!function(e){function t(n){if(i[n])return i[n].exports;var s=i[n]={i:n,l:!1,exports:{}};return e[n].call(s.exports,s,s.exports,t),s.l=!0,s.exports}var i={};t.m=e,t.c=i,t.i=function(e){return e},t.d=function(e,i,n){t.o(e,i)||Object.defineProperty(e,i,{configurable:!1,enumerable:!0,get:n})},t.n=function(e){var i=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(i,"a",i),i},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=6)}([/*!**********************************!*\
  !*** ../athenajs/dist/athena.js ***!
  \**********************************/
function(e,t,i){!function(t,i){e.exports=i()}(window,function(){return function(e){function t(n){if(i[n])return i[n].exports;var s=i[n]={i:n,l:!1,exports:{}};return e[n].call(s.exports,s,s.exports,t),s.l=!0,s.exports}var i={};return t.m=e,t.c=i,t.d=function(e,i,n){t.o(e,i)||Object.defineProperty(e,i,{configurable:!1,enumerable:!0,get:n})},t.r=function(e){Object.defineProperty(e,"__esModule",{value:!0})},t.n=function(e){var i=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(i,"a",i),i},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=7)}([function(e,t,i){(function(t,n){var s;s=function(){"use strict";function e(e){return"function"==typeof e}function s(){var e=setTimeout;return function(){return e(r,1)}}function r(){for(var e=0;e<E;e+=2)(0,D[e])(D[e+1]),D[e]=void 0,D[e+1]=void 0;E=0}function o(e,t){var i=arguments,n=this,s=new this.constructor(h);void 0===s[Y]&&b(s);var r,o=n._state;return o?(r=i[o-1],P(function(){return g(o,s,r,n._result)})):v(n,s,e,t),s}function a(e){if(e&&"object"==typeof e&&e.constructor===this)return e;var t=new this(h);return c(t,e),t}function h(){}function u(e){try{return e.then}catch(e){return H.error=e,H}}function l(t,i,n){i.constructor===t.constructor&&n===o&&i.constructor.resolve===a?function(e,t){t._state===B?d(e,t._result):t._state===G?p(e,t._result):v(t,void 0,function(t){return c(e,t)},function(t){return p(e,t)})}(t,i):n===H?(p(t,H.error),H.error=null):void 0===n?d(t,i):e(n)?function(e,t,i){P(function(e){var n=!1,s=function(e,t,i,n){try{e.call(t,i,n)}catch(e){return e}}(i,t,function(i){n||(n=!0,t!==i?c(e,i):d(e,i))},function(t){n||(n=!0,p(e,t))},e._label);!n&&s&&(n=!0,p(e,s))},e)}(t,i,n):d(t,i)}function c(e,t){var i;e===t?p(e,new TypeError("You cannot resolve a promise with itself")):"function"==typeof(i=t)||"object"==typeof i&&null!==i?l(e,t,u(t)):d(e,t)}function f(e){e._onerror&&e._onerror(e._result),y(e)}function d(e,t){e._state===N&&(e._result=t,e._state=B,0!==e._subscribers.length&&P(y,e))}function p(e,t){e._state===N&&(e._state=G,e._result=t,P(f,e))}function v(e,t,i,n){var s=e._subscribers,r=s.length;e._onerror=null,s[r]=t,s[r+B]=i,s[r+G]=n,0===r&&e._state&&P(y,e)}function y(e){var t=e._subscribers,i=e._state;if(0!==t.length){for(var n=void 0,s=void 0,r=e._result,o=0;o<t.length;o+=3)n=t[o],s=t[o+i],n?g(i,n,s,r):s(r);e._subscribers.length=0}}function m(){this.error=null}function g(t,i,n,s){var r=e(n),o=void 0,a=void 0,h=void 0,u=void 0;if(r){if((o=function(e,t){try{return e(t)}catch(e){return W.error=e,W}}(n,s))===W?(u=!0,a=o.error,o.error=null):h=!0,i===o)return void p(i,new TypeError("A promises callback cannot return that same promise."))}else o=s,h=!0;i._state!==N||(r&&h?c(i,o):u?p(i,a):t===B?d(i,o):t===G&&p(i,o))}function b(e){e[Y]=X++,e._state=void 0,e._result=void 0,e._subscribers=[]}function w(e,t){this._instanceConstructor=e,this.promise=new e(h),this.promise[Y]||b(this.promise),S(t)?(this._input=t,this.length=t.length,this._remaining=t.length,this._result=new Array(this.length),0===this.length?d(this.promise,this._result):(this.length=this.length||0,this._enumerate(),0===this._remaining&&d(this.promise,this._result))):p(this.promise,new Error("Array Methods must be provided an Array"))}function k(e){this[Y]=X++,this._result=this._state=void 0,this._subscribers=[],h!==e&&("function"!=typeof e&&function(){throw new TypeError("You must pass a resolver function as the first argument to the promise constructor")}(),this instanceof k?function(e,t){try{t(function(t){c(e,t)},function(t){p(e,t)})}catch(t){p(e,t)}}(this,e):function(){throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.")}())}var x,_,T,O,S=Array.isArray?Array.isArray:function(e){return"[object Array]"===Object.prototype.toString.call(e)},E=0,C=void 0,M=void 0,P=function(e,t){D[E]=e,D[E+1]=t,2===(E+=2)&&(M?M(r):I())},A="undefined"!=typeof window?window:void 0,j=A||{},F=j.MutationObserver||j.WebKitMutationObserver,L="undefined"==typeof self&&void 0!==t&&"[object process]"==={}.toString.call(t),R="undefined"!=typeof Uint8ClampedArray&&"undefined"!=typeof importScripts&&"undefined"!=typeof MessageChannel,D=new Array(1e3),I=void 0;L?I=function(){return t.nextTick(r)}:F?(_=0,T=new F(r),O=document.createTextNode(""),T.observe(O,{characterData:!0}),I=function(){O.data=_=++_%2}):R?((x=new MessageChannel).port1.onmessage=r,I=function(){return x.port2.postMessage(0)}):I=void 0===A?function(){try{var e=i(4);return void 0!==(C=e.runOnLoop||e.runOnContext)?function(){C(r)}:s()}catch(e){return s()}}():s();var Y=Math.random().toString(36).substring(16),N=void 0,B=1,G=2,H=new m,W=new m,X=0;return w.prototype._enumerate=function(){for(var e=this.length,t=this._input,i=0;this._state===N&&i<e;i++)this._eachEntry(t[i],i)},w.prototype._eachEntry=function(e,t){var i=this._instanceConstructor,n=i.resolve;if(n===a){var s=u(e);if(s===o&&e._state!==N)this._settledAt(e._state,t,e._result);else if("function"!=typeof s)this._remaining--,this._result[t]=e;else if(i===k){var r=new i(h);l(r,e,s),this._willSettleAt(r,t)}else this._willSettleAt(new i(function(t){return t(e)}),t)}else this._willSettleAt(n(e),t)},w.prototype._settledAt=function(e,t,i){var n=this.promise;n._state===N&&(this._remaining--,e===G?p(n,i):this._result[t]=i),0===this._remaining&&d(n,this._result)},w.prototype._willSettleAt=function(e,t){var i=this;v(e,void 0,function(e){return i._settledAt(B,t,e)},function(e){return i._settledAt(G,t,e)})},k.all=function(e){return new w(this,e).promise},k.race=function(e){var t=this;return new t(S(e)?function(i,n){for(var s=e.length,r=0;r<s;r++)t.resolve(e[r]).then(i,n)}:function(e,t){return t(new TypeError("You must pass an array to race."))})},k.resolve=a,k.reject=function(e){var t=new this(h);return p(t,e),t},k._setScheduler=function(e){M=e},k._setAsap=function(e){P=e},k._asap=P,k.prototype={constructor:k,then:o,catch:function(e){return this.then(null,e)}},k.polyfill=function(){var e=void 0;if(void 0!==n)e=n;else if("undefined"!=typeof self)e=self;else try{e=Function("return this")()}catch(e){throw new Error("polyfill failed because global object is unavailable in this environment")}var t=e.Promise;if(t){var i=null;try{i=Object.prototype.toString.call(t.resolve())}catch(e){}if("[object Promise]"===i&&!t.cast)return}e.Promise=k},k.Promise=k,k},e.exports=s()}).call(this,i(6),i(5))},function(e,t){var i;(i=window).fpscounter=function(e){function t(e,t){return(!e[0]||t<e[0])&&(e[0]=t),(!e[1]||t>e[1])&&(e[1]=t),e}function n(){var e,i,s,r,o,u;C=!0,(T=Date.now())>=O+S&&(e=Math.min(60,Math.round(1/(T-_)*1e3)),M.unshift(e),c.clearRect(0,0,a,h),M.length>P&&M.pop(),i=M.reduce(t,[]),s=i[0],r=i[1],o=r-s,c.fillStyle=w,c.beginPath(),c.moveTo(a,h),M.forEach(function(e,t){u=function(e,t,i,n){return[a-e,h-h*(t-i)/n]}(t,e,s,o),c.lineTo(u[0],u[1])}),c.lineTo(u[0],h),c.lineTo(a,h),c.fill(),c.stroke(),c.fillStyle="#fff",c.font=g,c.fillText(e,f,d),c.font=b,c.fillText(s,y,m),c.fillText(r,p,v),O=T),_=T,C&&(E=requestAnimationFrame(n))}function s(){_=Date.now(),M=[],O=_,n()}e=e||{};var r=i.fpscounter_options||{},o={remove_on_click:!1,width:100,height:50};Object.keys(o).forEach(function(t){e[t]=e[t]||r[t]||o[t]});var a=e.width,h=e.height,u=document.createElement("div");u.className="fpscounter",u.style.width=a+"px",u.style.height=h+"px";var l=document.createElement("canvas");l.className="fpscounter-canvas",l.width=a,l.height=h;var c=l.getContext("2d"),f=a/2-14,d=h/2+10,p=4,v=8,y=4,m=h-4,g="bold 30px Monospace",b="10px Monospace",w=c.createLinearGradient(0,0,0,h);w.addColorStop(0,"#001133"),w.addColorStop(1,"#112288");var k=c.createLinearGradient(0,0,0,h);k.addColorStop(0,"#2848d8"),k.addColorStop(1,"#3366ff"),c.lineWidth=1,c.strokeStyle=k;var x=document.createElement("style");x.textContent=".fpscounter { position: fixed; top: 0; right: 0; background-color: #000; color: #fff; font-size: 30px; font-family: monospace;z-index: 999999}",u.appendChild(l),document.body.appendChild(u),document.querySelector("head").appendChild(x);var _,T,O,S,E,C,M=[],P=a;S=100,u.addEventListener("click",function(){(C=!C)?s():(cancelAnimationFrame(E),e.remove_on_click&&document.body.removeChild(u))}),s()},!i.fpscounter_options||i.fpscounter_options.auto_start,e.exports=fpscounter},function(e,t,i){var n,s;s=this,void 0===(n=function(){return s.Wad=function(){(function(e){var t=function(e,t){var i=t||{},n=i.bufferLen||4096,s=i.numChannels||2;this.context=e.context,this.node=(this.context.createScriptProcessor||this.context.createJavaScriptNode).call(this.context,n,s,s);var r=new Worker(i.workerPath||"recorderWorker.js");r.postMessage({command:"init",config:{sampleRate:this.context.sampleRate,numChannels:s}});var o,a=!1;this.node.onaudioprocess=function(e){if(a){for(var t=[],i=0;i<s;i++)t.push(e.inputBuffer.getChannelData(i));r.postMessage({command:"record",buffer:t})}},this.configure=function(e){for(var t in e)e.hasOwnProperty(t)&&(i[t]=e[t])},this.record=function(){a=!0},this.stop=function(){a=!1},this.clear=function(){r.postMessage({command:"clear"})},this.getBuffer=function(e){o=e||i.callback,r.postMessage({command:"getBuffer"})},this.exportWAV=function(e,t){if(o=e||i.callback,t=t||i.type||"audio/wav",!o)throw new Error("Callback not set");r.postMessage({command:"exportWAV",type:t})},r.onmessage=function(e){var t=e.data;o(t)},e.connect(this.node),this.node.connect(this.context.destination)};t.forceDownload=function(t,i){var n=(e.URL||e.webkitURL).createObjectURL(t),s=e.document.createElement("a");s.href=n,s.download=i||"output.wav";var r=document.createEvent("Event");r.initEvent("click",!0,!0),s.dispatchEvent(r)},e.Recorder=t})(window),function(t){function i(e){if(!(this instanceof i))return new i(e);if(t.AudioContext||(t.AudioContext=t.webkitAudioContext),e||(console.log("tuna.js: Missing audio context! Creating a new context for you."),e=t.AudioContext&&new t.AudioContext),!e)throw new Error("Tuna cannot initialize because this environment does not support web audio.");!function(e){if(!0!==e.__connectified__){var t=e.createGain(),i=Object.getPrototypeOf(Object.getPrototypeOf(t)),n=i.connect;i.connect=function(){var e=Array.prototype.shift.apply(arguments);return e=c.isPrototypeOf?c.isPrototypeOf(e)?e.input:e:e.input||e,(arguments=Array.prototype.slice.call(arguments)).unshift(e),n.apply(this,arguments),e},e.__connectified__=!0}}(e),h=e,u=this}function n(e){return Math.max(0,Math.round(100*Math.pow(2,e/6))/100)}function s(e,t){var i,n,s=0,r=0,o=0,a=0;return i=e.toExponential().match(/^.\.?(.*)e(.+)$/),s=parseInt(i[2],10)-(i[1]+"").length,i=t.toExponential().match(/^.\.?(.*)e(.+)$/),(r=parseInt(i[2],10)-(i[1]+"").length)>s&&(s=r),n=e%t,s<-100||s>20?(o=Math.round(Math.log(n)/Math.log(10)),a=Math.pow(10,o),(n/a).toFixed(o-s)*a):parseFloat(n.toFixed(-s))}function r(e){return 0===e?1:Math.abs(e)/e}function o(e){return(Math.exp(e)-Math.exp(-e))/(Math.exp(e)+Math.exp(-e))}function a(e,t){return void 0===e?t:e}var h,u,l=function(e,t){e.value=t},c=Object.create(null,{activate:{writable:!0,value:function(e){e?(this.input.disconnect(),this.input.connect(this.activateNode),this.activateCallback&&this.activateCallback(e)):(this.input.disconnect(),this.input.connect(this.output))}},bypass:{get:function(){return this._bypass},set:function(e){this._lastBypassValue!==e&&(this._bypass=e,this.activate(!e),this._lastBypassValue=e)}},connect:{value:function(e){this.output.connect(e)}},disconnect:{value:function(e){this.output.disconnect(e)}},connectInOrder:{value:function(e){for(var t=e.length-1;t--;){if(!e[t].connect)return console.error("AudioNode.connectInOrder: TypeError: Not an AudioNode.",e[t]);e[t+1].input?e[t].connect(e[t+1].input):e[t].connect(e[t+1])}}},getDefaults:{value:function(){var e={};for(var t in this.defaults)e[t]=this.defaults[t].value;return e}},automate:{value:function(e,t,i,n){var s,r=n?~~(n/1e3):h.currentTime,o=i?~~(i/1e3):0,a=this.defaults[e],u=this[e];u?a.automatable?(i?(s="linearRampToValueAtTime",u.cancelScheduledValues(r),u.setValueAtTime(u.value,r)):s="setValueAtTime",u[s](t,o+r)):u=t:console.error("Invalid Property for "+this.name)}}}),f="float",d="int";void 0!==e&&e.exports?e.exports=i:t.define("Tuna",function(){return i}),i.prototype.Bitcrusher=function(e){e||(e=this.getDefaults()),this.bufferSize=e.bufferSize||this.defaults.bufferSize.value,this.input=h.createGain(),this.activateNode=h.createGain(),this.processor=h.createScriptProcessor(this.bufferSize,1,1),this.output=h.createGain(),this.activateNode.connect(this.processor),this.processor.connect(this.output);var t,i,n,s,r,o=0,u=0;this.processor.onaudioprocess=function(e){for(t=e.inputBuffer.getChannelData(0),i=e.outputBuffer.getChannelData(0),n=Math.pow(.5,this.bits),r=t.length,s=0;s<r;s++)(o+=this.normfreq)>=1&&(o-=1,u=n*Math.floor(t[s]/n+.5)),i[s]=u},this.bits=e.bits||this.defaults.bits.value,this.normfreq=a(e.normfreq,this.defaults.normfreq.value),this.bypass=e.bypass||!1},i.prototype.Bitcrusher.prototype=Object.create(c,{name:{value:"Bitcrusher"},defaults:{writable:!0,value:{bits:{value:4,min:1,max:16,automatable:!1,type:d},bufferSize:{value:4096,min:256,max:16384,automatable:!1,type:d},bypass:{value:!1,automatable:!1,type:"boolean"},normfreq:{value:.1,min:1e-4,max:1,automatable:!1,type:f}}},bits:{enumerable:!0,get:function(){return this.processor.bits},set:function(e){this.processor.bits=e}},normfreq:{enumerable:!0,get:function(){return this.processor.normfreq},set:function(e){this.processor.normfreq=e}}}),i.prototype.Cabinet=function(e){e||(e=this.getDefaults()),this.input=h.createGain(),this.activateNode=h.createGain(),this.convolver=this.newConvolver(e.impulsePath||"../impulses/impulse_guitar.wav"),this.makeupNode=h.createGain(),this.output=h.createGain(),this.activateNode.connect(this.convolver.input),this.convolver.output.connect(this.makeupNode),this.makeupNode.connect(this.output),this.makeupGain=a(e.makeupGain,this.defaults.makeupGain),this.bypass=e.bypass||!1},i.prototype.Cabinet.prototype=Object.create(c,{name:{value:"Cabinet"},defaults:{writable:!0,value:{makeupGain:{value:1,min:0,max:20,automatable:!0,type:f},bypass:{value:!1,automatable:!1,type:"boolean"}}},makeupGain:{enumerable:!0,get:function(){return this.makeupNode.gain},set:function(e){this.makeupNode.gain.value=e}},newConvolver:{value:function(e){return new u.Convolver({impulse:e,dryLevel:0,wetLevel:1})}}}),i.prototype.Chorus=function(e){e||(e=this.getDefaults()),this.input=h.createGain(),this.attenuator=this.activateNode=h.createGain(),this.splitter=h.createChannelSplitter(2),this.delayL=h.createDelay(),this.delayR=h.createDelay(),this.feedbackGainNodeLR=h.createGain(),this.feedbackGainNodeRL=h.createGain(),this.merger=h.createChannelMerger(2),this.output=h.createGain(),this.lfoL=new u.LFO({target:this.delayL.delayTime,callback:l}),this.lfoR=new u.LFO({target:this.delayR.delayTime,callback:l}),this.input.connect(this.attenuator),this.attenuator.connect(this.output),this.attenuator.connect(this.splitter),this.splitter.connect(this.delayL,0),this.splitter.connect(this.delayR,1),this.delayL.connect(this.feedbackGainNodeLR),this.delayR.connect(this.feedbackGainNodeRL),this.feedbackGainNodeLR.connect(this.delayR),this.feedbackGainNodeRL.connect(this.delayL),this.delayL.connect(this.merger,0,0),this.delayR.connect(this.merger,0,1),this.merger.connect(this.output),this.feedback=a(e.feedback,this.defaults.feedback.value),this.rate=a(e.rate,this.defaults.rate.value),this.delay=a(e.delay,this.defaults.delay.value),this.depth=a(e.depth,this.defaults.depth.value),this.lfoR.phase=Math.PI/2,this.attenuator.gain.value=.6934,this.lfoL.activate(!0),this.lfoR.activate(!0),this.bypass=e.bypass||!1},i.prototype.Chorus.prototype=Object.create(c,{name:{value:"Chorus"},defaults:{writable:!0,value:{feedback:{value:.4,min:0,max:.95,automatable:!1,type:f},delay:{value:.0045,min:0,max:1,automatable:!1,type:f},depth:{value:.7,min:0,max:1,automatable:!1,type:f},rate:{value:1.5,min:0,max:8,automatable:!1,type:f},bypass:{value:!1,automatable:!1,type:"boolean"}}},delay:{enumerable:!0,get:function(){return this._delay},set:function(e){this._delay=2*Math.pow(10,e)*2e-4,this.lfoL.offset=this._delay,this.lfoR.offset=this._delay,this._depth=this._depth}},depth:{enumerable:!0,get:function(){return this._depth},set:function(e){this._depth=e,this.lfoL.oscillation=this._depth*this._delay,this.lfoR.oscillation=this._depth*this._delay}},feedback:{enumerable:!0,get:function(){return this._feedback},set:function(e){this._feedback=e,this.feedbackGainNodeLR.gain.value=this._feedback,this.feedbackGainNodeRL.gain.value=this._feedback}},rate:{enumerable:!0,get:function(){return this._rate},set:function(e){this._rate=e,this.lfoL.frequency=this._rate,this.lfoR.frequency=this._rate}}}),i.prototype.Compressor=function(e){e||(e=this.getDefaults()),this.input=h.createGain(),this.compNode=this.activateNode=h.createDynamicsCompressor(),this.makeupNode=h.createGain(),this.output=h.createGain(),this.compNode.connect(this.makeupNode),this.makeupNode.connect(this.output),this.automakeup=a(e.automakeup,this.defaults.automakeup.value),this.makeupGain=e.makeupGain||this.defaults.makeupGain.value,this.threshold=a(e.threshold,this.defaults.threshold.value),this.release=e.release||this.defaults.release.value,this.attack=a(e.attack,this.defaults.attack.value),this.ratio=e.ratio||this.defaults.ratio.value,this.knee=a(e.knee,this.defaults.knee.value),this.bypass=e.bypass||!1},i.prototype.Compressor.prototype=Object.create(c,{name:{value:"Compressor"},defaults:{writable:!0,value:{threshold:{value:-20,min:-60,max:0,automatable:!0,type:f},release:{value:250,min:10,max:2e3,automatable:!0,type:f},makeupGain:{value:1,min:1,max:100,automatable:!0,type:f},attack:{value:1,min:0,max:1e3,automatable:!0,type:f},ratio:{value:4,min:1,max:50,automatable:!0,type:f},knee:{value:5,min:0,max:40,automatable:!0,type:f},automakeup:{value:!1,automatable:!1,type:"boolean"},bypass:{value:!1,automatable:!1,type:"boolean"}}},computeMakeup:{value:function(){var e=this.compNode;return-(e.threshold.value-e.threshold.value/e.ratio.value)/4}},automakeup:{enumerable:!0,get:function(){return this._automakeup},set:function(e){this._automakeup=e,this._automakeup&&(this.makeupGain=this.computeMakeup())}},threshold:{enumerable:!0,get:function(){return this.compNode.threshold},set:function(e){this.compNode.threshold.value=e,this._automakeup&&(this.makeupGain=this.computeMakeup())}},ratio:{enumerable:!0,get:function(){return this.compNode.ratio},set:function(e){this.compNode.ratio.value=e,this._automakeup&&(this.makeupGain=this.computeMakeup())}},knee:{enumerable:!0,get:function(){return this.compNode.knee},set:function(e){this.compNode.knee.value=e,this._automakeup&&(this.makeupGain=this.computeMakeup())}},attack:{enumerable:!0,get:function(){return this.compNode.attack},set:function(e){this.compNode.attack.value=e/1e3}},release:{enumerable:!0,get:function(){return this.compNode.release},set:function(e){this.compNode.release=e/1e3}},makeupGain:{enumerable:!0,get:function(){return this.makeupNode.gain},set:function(e){this.makeupNode.gain.value=n(e)}}}),i.prototype.Convolver=function(e){e||(e=this.getDefaults()),this.input=h.createGain(),this.activateNode=h.createGain(),this.convolver=h.createConvolver(),this.dry=h.createGain(),this.filterLow=h.createBiquadFilter(),this.filterHigh=h.createBiquadFilter(),this.wet=h.createGain(),this.output=h.createGain(),this.activateNode.connect(this.filterLow),this.activateNode.connect(this.dry),this.filterLow.connect(this.filterHigh),this.filterHigh.connect(this.convolver),this.convolver.connect(this.wet),this.wet.connect(this.output),this.dry.connect(this.output),this.dryLevel=a(e.dryLevel,this.defaults.dryLevel.value),this.wetLevel=a(e.wetLevel,this.defaults.wetLevel.value),this.highCut=e.highCut||this.defaults.highCut.value,this.buffer=e.impulse||"../impulses/ir_rev_short.wav",this.lowCut=e.lowCut||this.defaults.lowCut.value,this.level=a(e.level,this.defaults.level.value),this.filterHigh.type="lowpass",this.filterLow.type="highpass",this.bypass=e.bypass||!1},i.prototype.Convolver.prototype=Object.create(c,{name:{value:"Convolver"},defaults:{writable:!0,value:{highCut:{value:22050,min:20,max:22050,automatable:!0,type:f},lowCut:{value:20,min:20,max:22050,automatable:!0,type:f},dryLevel:{value:1,min:0,max:1,automatable:!0,type:f},wetLevel:{value:1,min:0,max:1,automatable:!0,type:f},level:{value:1,min:0,max:1,automatable:!0,type:f}}},lowCut:{get:function(){return this.filterLow.frequency},set:function(e){this.filterLow.frequency.value=e}},highCut:{get:function(){return this.filterHigh.frequency},set:function(e){this.filterHigh.frequency.value=e}},level:{get:function(){return this.output.gain},set:function(e){this.output.gain.value=e}},dryLevel:{get:function(){return this.dry.gain},set:function(e){this.dry.gain.value=e}},wetLevel:{get:function(){return this.wet.gain},set:function(e){this.wet.gain.value=e}},buffer:{enumerable:!1,get:function(){return this.convolver.buffer},set:function(e){var t=this.convolver,i=new XMLHttpRequest;e?(i.open("GET",e,!0),i.responseType="arraybuffer",i.onreadystatechange=function(){4===i.readyState&&(i.status<300&&i.status>199||302===i.status)&&h.decodeAudioData(i.response,function(e){t.buffer=e},function(e){e&&console.log("Tuna.Convolver.setBuffer: Error decoding data"+e)})},i.send(null)):console.log("Tuna.Convolver.setBuffer: Missing impulse path!")}}}),i.prototype.Delay=function(e){e||(e=this.getDefaults()),this.input=h.createGain(),this.activateNode=h.createGain(),this.dry=h.createGain(),this.wet=h.createGain(),this.filter=h.createBiquadFilter(),this.delay=h.createDelay(),this.feedbackNode=h.createGain(),this.output=h.createGain(),this.activateNode.connect(this.delay),this.activateNode.connect(this.dry),this.delay.connect(this.filter),this.filter.connect(this.feedbackNode),this.feedbackNode.connect(this.delay),this.feedbackNode.connect(this.wet),this.wet.connect(this.output),this.dry.connect(this.output),this.delayTime=e.delayTime||this.defaults.delayTime.value,this.feedback=a(e.feedback,this.defaults.feedback.value),this.wetLevel=a(e.wetLevel,this.defaults.wetLevel.value),this.dryLevel=a(e.dryLevel,this.defaults.dryLevel.value),this.cutoff=e.cutoff||this.defaults.cutoff.value,this.filter.type="lowpass",this.bypass=e.bypass||!1},i.prototype.Delay.prototype=Object.create(c,{name:{value:"Delay"},defaults:{writable:!0,value:{delayTime:{value:100,min:20,max:1e3,automatable:!1,type:f},feedback:{value:.45,min:0,max:.9,automatable:!0,type:f},cutoff:{value:2e4,min:20,max:2e4,automatable:!0,type:f},wetLevel:{value:.5,min:0,max:1,automatable:!0,type:f},dryLevel:{value:1,min:0,max:1,automatable:!0,type:f}}},delayTime:{enumerable:!0,get:function(){return this.delay.delayTime},set:function(e){this.delay.delayTime.value=e/1e3}},wetLevel:{enumerable:!0,get:function(){return this.wet.gain},set:function(e){this.wet.gain.value=e}},dryLevel:{enumerable:!0,get:function(){return this.dry.gain},set:function(e){this.dry.gain.value=e}},feedback:{enumerable:!0,get:function(){return this.feedbackNode.gain},set:function(e){this.feedbackNode.gain.value=e}},cutoff:{enumerable:!0,get:function(){return this.filter.frequency},set:function(e){this.filter.frequency.value=e}}}),i.prototype.Filter=function(e){e||(e=this.getDefaults()),this.input=h.createGain(),this.activateNode=h.createGain(),this.filter=h.createBiquadFilter(),this.output=h.createGain(),this.activateNode.connect(this.filter),this.filter.connect(this.output),this.frequency=e.frequency||this.defaults.frequency.value,this.Q=e.resonance||this.defaults.Q.value,this.filterType=a(e.filterType,this.defaults.filterType.value),this.gain=a(e.gain,this.defaults.gain.value),this.bypass=e.bypass||!1},i.prototype.Filter.prototype=Object.create(c,{name:{value:"Filter"},defaults:{writable:!0,value:{frequency:{value:800,min:20,max:22050,automatable:!0,type:f},Q:{value:1,min:.001,max:100,automatable:!0,type:f},gain:{value:0,min:-40,max:40,automatable:!0,type:f},bypass:{value:!1,automatable:!1,type:"boolean"},filterType:{value:"lowpass",automatable:!1,type:"string"}}},filterType:{enumerable:!0,get:function(){return this.filter.type},set:function(e){this.filter.type=e}},Q:{enumerable:!0,get:function(){return this.filter.Q},set:function(e){this.filter.Q.value=e}},gain:{enumerable:!0,get:function(){return this.filter.gain},set:function(e){this.filter.gain.value=e}},frequency:{enumerable:!0,get:function(){return this.filter.frequency},set:function(e){this.filter.frequency.value=e}}}),i.prototype.MoogFilter=function(e){var t,i,n,s,r,o,u,l,c,f,d,p,v,y;e||(e=this.getDefaults()),this.bufferSize=e.bufferSize||this.defaults.bufferSize.value,this.input=h.createGain(),this.activateNode=h.createGain(),this.processor=h.createScriptProcessor(this.bufferSize,1,1),this.output=h.createGain(),this.activateNode.connect(this.processor),this.processor.connect(this.output),t=i=n=s=r=o=u=l=0,this.processor.onaudioprocess=function(e){for(c=e.inputBuffer.getChannelData(0),f=e.outputBuffer.getChannelData(0),d=1.16*this.cutoff,inputFactor=d*d*.35013*(d*d),p=this.resonance*(1-.15*d*d),y=c.length,v=0;v<y;v++)c[v]-=l*p,c[v]*=inputFactor,r=c[v]+.3*t+(1-d)*r,t=c[v],o=r+.3*i+(1-d)*o,i=r,u=o+.3*n+(1-d)*u,n=o,l=u+.3*s+(1-d)*l,s=u,f[v]=l},this.cutoff=a(e.cutoff,this.defaults.cutoff.value),this.resonance=a(e.resonance,this.defaults.resonance.value),this.bypass=e.bypass||!1},i.prototype.MoogFilter.prototype=Object.create(c,{name:{value:"MoogFilter"},defaults:{writable:!0,value:{bufferSize:{value:4096,min:256,max:16384,automatable:!1,type:d},bypass:{value:!1,automatable:!1,type:"boolean"},cutoff:{value:.065,min:1e-4,max:1,automatable:!1,type:f},resonance:{value:3.5,min:0,max:4,automatable:!1,type:f}}},cutoff:{enumerable:!0,get:function(){return this.processor.cutoff},set:function(e){this.processor.cutoff=e}},resonance:{enumerable:!0,get:function(){return this.processor.resonance},set:function(e){this.processor.resonance=e}}}),i.prototype.Overdrive=function(e){e||(e=this.getDefaults()),this.input=h.createGain(),this.activateNode=h.createGain(),this.inputDrive=h.createGain(),this.waveshaper=h.createWaveShaper(),this.outputDrive=h.createGain(),this.output=h.createGain(),this.activateNode.connect(this.inputDrive),this.inputDrive.connect(this.waveshaper),this.waveshaper.connect(this.outputDrive),this.outputDrive.connect(this.output),this.ws_table=new Float32Array(this.k_nSamples),this.drive=a(e.drive,this.defaults.drive.value),this.outputGain=a(e.outputGain,this.defaults.outputGain.value),this.curveAmount=a(e.curveAmount,this.defaults.curveAmount.value),this.algorithmIndex=a(e.algorithmIndex,this.defaults.algorithmIndex.value),this.bypass=e.bypass||!1},i.prototype.Overdrive.prototype=Object.create(c,{name:{value:"Overdrive"},defaults:{writable:!0,value:{drive:{value:1,min:0,max:1,automatable:!0,type:f,scaled:!0},outputGain:{value:1,min:0,max:1,automatable:!0,type:f,scaled:!0},curveAmount:{value:.725,min:0,max:1,automatable:!1,type:f},algorithmIndex:{value:0,min:0,max:5,automatable:!1,type:d}}},k_nSamples:{value:8192},drive:{get:function(){return this.inputDrive.gain},set:function(e){this._drive=e}},curveAmount:{get:function(){return this._curveAmount},set:function(e){this._curveAmount=e,void 0===this._algorithmIndex&&(this._algorithmIndex=0),this.waveshaperAlgorithms[this._algorithmIndex](this._curveAmount,this.k_nSamples,this.ws_table),this.waveshaper.curve=this.ws_table}},outputGain:{get:function(){return this.outputDrive.gain},set:function(e){this._outputGain=n(e)}},algorithmIndex:{get:function(){return this._algorithmIndex},set:function(e){this._algorithmIndex=e,this.curveAmount=this._curveAmount}},waveshaperAlgorithms:{value:[function(e,t,i){var n,s,r=2*(e=Math.min(e,.9999))/(1-e);for(n=0;n<t;n++)s=2*n/t-1,i[n]=(1+r)*s/(1+r*Math.abs(s))},function(e,t,i){var n,s,r;for(n=0;n<t;n++)s=2*n/t-1,r=(.5*Math.pow(s+1.4,2)-1)*r>=0?5.8:1.2,i[n]=o(r)},function(e,t,i){var n,s,r,a=1-e;for(n=0;n<t;n++)r=(s=2*n/t-1)<0?-Math.pow(Math.abs(s),a+.04):Math.pow(s,a),i[n]=o(2*r)},function(e,t,i){var n,s,o,a,h=1-e>.99?.99:1-e;for(n=0;n<t;n++)s=2*n/t-1,(a=Math.abs(s))<h?o=a:a>h?o=h+(a-h)/(1+Math.pow((a-h)/(1-h),2)):a>1&&(o=a),i[n]=r(s)*o*(1/((h+1)/2))},function(e,t,i){var n,s;for(n=0;n<t;n++)s=2*n/t-1,i[n]=s<-.08905?-.75*(1-Math.pow(1-(Math.abs(s)-.032857),12)+1/3*(Math.abs(s)-.032847))+.01:s>=-.08905&&s<.320018?s*s*-6.153+3.9375*s:.630035},function(e,t,i){var n,s,r=2+Math.round(14*e),o=Math.round(Math.pow(2,r-1));for(n=0;n<t;n++)s=2*n/t-1,i[n]=Math.round(s*o)/o}]}}),i.prototype.Phaser=function(e){e||(e=this.getDefaults()),this.input=h.createGain(),this.splitter=this.activateNode=h.createChannelSplitter(2),this.filtersL=[],this.filtersR=[],this.feedbackGainNodeL=h.createGain(),this.feedbackGainNodeR=h.createGain(),this.merger=h.createChannelMerger(2),this.filteredSignal=h.createGain(),this.output=h.createGain(),this.lfoL=new u.LFO({target:this.filtersL,callback:this.callback}),this.lfoR=new u.LFO({target:this.filtersR,callback:this.callback});for(var t=this.stage;t--;)this.filtersL[t]=h.createBiquadFilter(),this.filtersR[t]=h.createBiquadFilter(),this.filtersL[t].type="allpass",this.filtersR[t].type="allpass";this.input.connect(this.splitter),this.input.connect(this.output),this.splitter.connect(this.filtersL[0],0,0),this.splitter.connect(this.filtersR[0],1,0),this.connectInOrder(this.filtersL),this.connectInOrder(this.filtersR),this.filtersL[this.stage-1].connect(this.feedbackGainNodeL),this.filtersL[this.stage-1].connect(this.merger,0,0),this.filtersR[this.stage-1].connect(this.feedbackGainNodeR),this.filtersR[this.stage-1].connect(this.merger,0,1),this.feedbackGainNodeL.connect(this.filtersL[0]),this.feedbackGainNodeR.connect(this.filtersR[0]),this.merger.connect(this.output),this.rate=a(e.rate,this.defaults.rate.value),this.baseModulationFrequency=e.baseModulationFrequency||this.defaults.baseModulationFrequency.value,this.depth=a(e.depth,this.defaults.depth.value),this.feedback=a(e.feedback,this.defaults.feedback.value),this.stereoPhase=a(e.stereoPhase,this.defaults.stereoPhase.value),this.lfoL.activate(!0),this.lfoR.activate(!0),this.bypass=e.bypass||!1},i.prototype.Phaser.prototype=Object.create(c,{name:{value:"Phaser"},stage:{value:4},defaults:{writable:!0,value:{rate:{value:.1,min:0,max:8,automatable:!1,type:f},depth:{value:.6,min:0,max:1,automatable:!1,type:f},feedback:{value:.7,min:0,max:1,automatable:!1,type:f},stereoPhase:{value:40,min:0,max:180,automatable:!1,type:f},baseModulationFrequency:{value:700,min:500,max:1500,automatable:!1,type:f}}},callback:{value:function(e,t){for(var i=0;i<4;i++)e[i].frequency.value=t}},depth:{get:function(){return this._depth},set:function(e){this._depth=e,this.lfoL.oscillation=this._baseModulationFrequency*this._depth,this.lfoR.oscillation=this._baseModulationFrequency*this._depth}},rate:{get:function(){return this._rate},set:function(e){this._rate=e,this.lfoL.frequency=this._rate,this.lfoR.frequency=this._rate}},baseModulationFrequency:{enumerable:!0,get:function(){return this._baseModulationFrequency},set:function(e){this._baseModulationFrequency=e,this.lfoL.offset=this._baseModulationFrequency,this.lfoR.offset=this._baseModulationFrequency,this._depth=this._depth}},feedback:{get:function(){return this._feedback},set:function(e){this._feedback=e,this.feedbackGainNodeL.gain.value=this._feedback,this.feedbackGainNodeR.gain.value=this._feedback}},stereoPhase:{get:function(){return this._stereoPhase},set:function(e){this._stereoPhase=e;var t=this.lfoL._phase+this._stereoPhase*Math.PI/180;t=s(t,2*Math.PI),this.lfoR._phase=t}}}),i.prototype.PingPongDelay=function(e){e||(e=this.getDefaults()),this.input=h.createGain(),this.wetLevel=h.createGain(),this.stereoToMonoMix=h.createGain(),this.feedbackLevel=h.createGain(),this.output=h.createGain(),this.delayLeft=h.createDelay(),this.delayRight=h.createDelay(),this.activateNode=h.createGain(),this.splitter=h.createChannelSplitter(2),this.merger=h.createChannelMerger(2),this.activateNode.connect(this.splitter),this.splitter.connect(this.stereoToMonoMix,0,0),this.splitter.connect(this.stereoToMonoMix,1,0),this.stereoToMonoMix.gain.value=.5,this.stereoToMonoMix.connect(this.wetLevel),this.wetLevel.connect(this.delayLeft),this.feedbackLevel.connect(this.delayLeft),this.delayLeft.connect(this.delayRight),this.delayRight.connect(this.feedbackLevel),this.delayLeft.connect(this.merger,0,0),this.delayRight.connect(this.merger,0,1),this.merger.connect(this.output),this.activateNode.connect(this.output),this.delayTimeLeft=void 0!==e.delayTimeLeft?e.delayTimeLeft:this.defaults.delayTimeLeft.value,this.delayTimeRight=void 0!==e.delayTimeRight?e.delayTimeRight:this.defaults.delayTimeRight.value,this.feedbackLevel.gain.value=void 0!==e.feedback?e.feedback:this.defaults.feedback.value,this.wetLevel.gain.value=void 0!==e.wetLevel?e.wetLevel:this.defaults.wetLevel.value,this.bypass=e.bypass||!1},i.prototype.PingPongDelay.prototype=Object.create(c,{name:{value:"PingPongDelay"},delayTimeLeft:{enumerable:!0,get:function(){return this._delayTimeLeft},set:function(e){this._delayTimeLeft=e,this.delayLeft.delayTime.value=e/1e3}},delayTimeRight:{enumerable:!0,get:function(){return this._delayTimeRight},set:function(e){this._delayTimeRight=e,this.delayRight.delayTime.value=e/1e3}},defaults:{writable:!0,value:{delayTimeLeft:{value:200,min:1,max:1e4,automatable:!1,type:d},delayTimeRight:{value:400,min:1,max:1e4,automatable:!1,type:d},feedback:{value:.3,min:0,max:1,automatable:!1,type:f},wetLevel:{value:.5,min:0,max:1,automatable:!1,type:f}}}}),i.prototype.Tremolo=function(e){e||(e=this.getDefaults()),this.input=h.createGain(),this.splitter=this.activateNode=h.createChannelSplitter(2),this.amplitudeL=h.createGain(),this.amplitudeR=h.createGain(),this.merger=h.createChannelMerger(2),this.output=h.createGain(),this.lfoL=new u.LFO({target:this.amplitudeL.gain,callback:l}),this.lfoR=new u.LFO({target:this.amplitudeR.gain,callback:l}),this.input.connect(this.splitter),this.splitter.connect(this.amplitudeL,0),this.splitter.connect(this.amplitudeR,1),this.amplitudeL.connect(this.merger,0,0),this.amplitudeR.connect(this.merger,0,1),this.merger.connect(this.output),this.rate=e.rate||this.defaults.rate.value,this.intensity=a(e.intensity,this.defaults.intensity.value),this.stereoPhase=a(e.stereoPhase,this.defaults.stereoPhase.value),this.lfoL.offset=1-this.intensity/2,this.lfoR.offset=1-this.intensity/2,this.lfoL.phase=this.stereoPhase*Math.PI/180,this.lfoL.activate(!0),this.lfoR.activate(!0),this.bypass=e.bypass||!1},i.prototype.Tremolo.prototype=Object.create(c,{name:{value:"Tremolo"},defaults:{writable:!0,value:{intensity:{value:.3,min:0,max:1,automatable:!1,type:f},stereoPhase:{value:0,min:0,max:180,automatable:!1,type:f},rate:{value:5,min:.1,max:11,automatable:!1,type:f}}},intensity:{enumerable:!0,get:function(){return this._intensity},set:function(e){this._intensity=e,this.lfoL.offset=1-this._intensity/2,this.lfoR.offset=1-this._intensity/2,this.lfoL.oscillation=this._intensity,this.lfoR.oscillation=this._intensity}},rate:{enumerable:!0,get:function(){return this._rate},set:function(e){this._rate=e,this.lfoL.frequency=this._rate,this.lfoR.frequency=this._rate}},stereoPhase:{enumerable:!0,get:function(){return this._rate},set:function(e){this._stereoPhase=e;var t=this.lfoL._phase+this._stereoPhase*Math.PI/180;t=s(t,2*Math.PI),this.lfoR.phase=t}}}),i.prototype.WahWah=function(e){e||(e=this.getDefaults()),this.input=h.createGain(),this.activateNode=h.createGain(),this.envelopeFollower=new u.EnvelopeFollower({target:this,callback:function(e,t){e.sweep=t}}),this.filterBp=h.createBiquadFilter(),this.filterPeaking=h.createBiquadFilter(),this.output=h.createGain(),this.activateNode.connect(this.filterBp),this.filterBp.connect(this.filterPeaking),this.filterPeaking.connect(this.output),this.init(),this.automode=a(e.enableAutoMode,this.defaults.automode.value),this.resonance=e.resonance||this.defaults.resonance.value,this.sensitivity=a(e.sensitivity,this.defaults.sensitivity.value),this.baseFrequency=a(e.baseFrequency,this.defaults.baseFrequency.value),this.excursionOctaves=e.excursionOctaves||this.defaults.excursionOctaves.value,this.sweep=a(e.sweep,this.defaults.sweep.value),this.activateNode.gain.value=2,this.envelopeFollower.activate(!0),this.bypass=e.bypass||!1},i.prototype.WahWah.prototype=Object.create(c,{name:{value:"WahWah"},defaults:{writable:!0,value:{automode:{value:!0,automatable:!1,type:"boolean"},baseFrequency:{value:.5,min:0,max:1,automatable:!1,type:f},excursionOctaves:{value:2,min:1,max:6,automatable:!1,type:f},sweep:{value:.2,min:0,max:1,automatable:!1,type:f},resonance:{value:10,min:1,max:100,automatable:!1,type:f},sensitivity:{value:.5,min:-1,max:1,automatable:!1,type:f}}},activateCallback:{value:function(e){this.automode=e}},automode:{get:function(){return this._automode},set:function(e){this._automode=e,e?(this.activateNode.connect(this.envelopeFollower.input),this.envelopeFollower.activate(!0)):(this.envelopeFollower.activate(!1),this.activateNode.disconnect(),this.activateNode.connect(this.filterBp))}},filterFreqTimeout:{value:0},setFilterFreq:{value:function(){try{this.filterBp.frequency.value=this._baseFrequency+this._excursionFrequency*this._sweep,this.filterPeaking.frequency.value=this._baseFrequency+this._excursionFrequency*this._sweep}catch(e){clearTimeout(this.filterFreqTimeout),this.filterFreqTimeout=setTimeout(function(){this.setFilterFreq()}.bind(this),0)}}},sweep:{enumerable:!0,get:function(){return this._sweep.value},set:function(e){this._sweep=Math.pow(e>1?1:e<0?0:e,this._sensitivity),this.setFilterFreq()}},baseFrequency:{enumerable:!0,get:function(){return this._baseFrequency},set:function(e){this._baseFrequency=50*Math.pow(10,2*e),this._excursionFrequency=Math.min(h.sampleRate/2,this.baseFrequency*Math.pow(2,this._excursionOctaves)),this.setFilterFreq()}},excursionOctaves:{enumerable:!0,get:function(){return this._excursionOctaves},set:function(e){this._excursionOctaves=e,this._excursionFrequency=Math.min(h.sampleRate/2,this.baseFrequency*Math.pow(2,this._excursionOctaves)),this.setFilterFreq()}},sensitivity:{enumerable:!0,get:function(){return this._sensitivity},set:function(e){this._sensitivity=Math.pow(10,e)}},resonance:{enumerable:!0,get:function(){return this._resonance},set:function(e){this._resonance=e,this.filterPeaking.Q=this._resonance}},init:{value:function(){this.output.gain.value=1,this.filterPeaking.type="peaking",this.filterBp.type="bandpass",this.filterPeaking.frequency.value=100,this.filterPeaking.gain.value=20,this.filterPeaking.Q.value=5,this.filterBp.frequency.value=100,this.filterBp.Q.value=1}}}),i.prototype.EnvelopeFollower=function(e){e||(e=this.getDefaults()),this.input=h.createGain(),this.jsNode=this.output=h.createScriptProcessor(this.buffersize,1,1),this.input.connect(this.output),this.attackTime=a(e.attackTime,this.defaults.attackTime.value),this.releaseTime=a(e.releaseTime,this.defaults.releaseTime.value),this._envelope=0,this.target=e.target||{},this.callback=e.callback||function(){}},i.prototype.EnvelopeFollower.prototype=Object.create(c,{name:{value:"EnvelopeFollower"},defaults:{value:{attackTime:{value:.003,min:0,max:.5,automatable:!1,type:f},releaseTime:{value:.5,min:0,max:.5,automatable:!1,type:f}}},buffersize:{value:256},envelope:{value:0},sampleRate:{value:44100},attackTime:{enumerable:!0,get:function(){return this._attackTime},set:function(e){this._attackTime=e,this._attackC=Math.exp(-1/this._attackTime*this.sampleRate/this.buffersize)}},releaseTime:{enumerable:!0,get:function(){return this._releaseTime},set:function(e){this._releaseTime=e,this._releaseC=Math.exp(-1/this._releaseTime*this.sampleRate/this.buffersize)}},callback:{get:function(){return this._callback},set:function(e){"function"==typeof e?this._callback=e:console.error("tuna.js: "+this.name+": Callback must be a function!")}},target:{get:function(){return this._target},set:function(e){this._target=e}},activate:{value:function(e){this.activated=e,e?(this.jsNode.connect(h.destination),this.jsNode.onaudioprocess=this.returnCompute(this)):(this.jsNode.disconnect(),this.jsNode.onaudioprocess=null)}},returnCompute:{value:function(e){return function(t){e.compute(t)}}},compute:{value:function(e){var t,i,n,s,r=e.inputBuffer.getChannelData(0).length,o=e.inputBuffer.numberOfChannels;if(i=n=s=0,o>1)for(s=0;s<r;++s)for(;i<o;++i)t=e.inputBuffer.getChannelData(i)[s],n+=t*t/o;else for(s=0;s<r;++s)t=e.inputBuffer.getChannelData(0)[s],n+=t*t;n=Math.sqrt(n),this._envelope<n?(this._envelope*=this._attackC,this._envelope+=(1-this._attackC)*n):(this._envelope*=this._releaseC,this._envelope+=(1-this._releaseC)*n),this._callback(this._target,this._envelope)}}}),i.prototype.LFO=function(e){this.output=h.createScriptProcessor(256,1,1),this.activateNode=h.destination,this.frequency=a(e.frequency,this.defaults.frequency.value),this.offset=a(e.offset,this.defaults.offset.value),this.oscillation=a(e.oscillation,this.defaults.oscillation.value),this.phase=a(e.phase,this.defaults.phase.value),this.target=e.target||{},this.output.onaudioprocess=this.callback(e.callback||function(){}),this.bypass=e.bypass||!1},i.prototype.LFO.prototype=Object.create(c,{name:{value:"LFO"},bufferSize:{value:256},sampleRate:{value:44100},defaults:{value:{frequency:{value:1,min:0,max:20,automatable:!1,type:f},offset:{value:.85,min:0,max:22049,automatable:!1,type:f},oscillation:{value:.3,min:-22050,max:22050,automatable:!1,type:f},phase:{value:0,min:0,max:2*Math.PI,automatable:!1,type:f}}},frequency:{get:function(){return this._frequency},set:function(e){this._frequency=e,this._phaseInc=2*Math.PI*this._frequency*this.bufferSize/this.sampleRate}},offset:{get:function(){return this._offset},set:function(e){this._offset=e}},oscillation:{get:function(){return this._oscillation},set:function(e){this._oscillation=e}},phase:{get:function(){return this._phase},set:function(e){this._phase=e}},target:{get:function(){return this._target},set:function(e){this._target=e}},activate:{value:function(e){e?this.output.connect(h.destination):this.output.disconnect(h.destination)}},callback:{value:function(e){var t=this;return function(){t._phase+=t._phaseInc,t._phase>2*Math.PI&&(t._phase=0),e(t._target,t._offset+t._oscillation*Math.sin(t._phase))}}}}),i.toString=i.prototype.toString=function(){return"Please visit https://github.com/Theodeus/tuna/wiki for instructions on how to use Tuna.js"}}(this);var t=new(window.AudioContext||window.webkitAudioContext);({UNSUPPORT:!1,SUPPORT_STANDARD_VERSION:1,SUPPORT_DEPRECATED_VERSION:2,isGetUserMediaSupported:function(e){return e.navigator.mediaDevices.getUserMedia?this.SUPPORT_STANDARD_VERSION:e.navigator.getUserMedia?this.SUPPORT_DEPRECATED_VERSION:this.UNSUPPORT},initialize:function(e){e.navigator.mediaDevices=e.navigator.mediaDevices||{},e.navigator.getUserMedia=e.navigator.getUserMedia||e.navigator.webkitGetUserMedia||e.navigator.mozGetUserMedia;var t=this.isGetUserMediaSupported(e);t!=this.UNSUPPORT&&(e.getUserMedia=t==this.SUPPORT_STANDARD_VERSION?e.navigator.mediaDevices.getUserMedia.bind(e.navigator.mediaDevices):function(t){return new Promise(function(i,n){e.navigator.getUserMedia(t,i,n)})})}}).initialize(window),window.getUserMedia?console.log("Your browser supports getUserMedia."):console.log("Your browser does not support getUserMedia.");var i=function(){var e=function(){Math.seed=6,Math.seededRandom=function(e,t){return e=e||1,t=t||0,Math.seed=(9301*Math.seed+49297)%233280,t+Math.seed/233280*(e-t)};for(var e=2*t.sampleRate,i=t.createBuffer(1,e,t.sampleRate),n=i.getChannelData(0),s=0;s<e;s++)n[s]=2*Math.seededRandom()-1;return i}(),i=function(e){return"[object Array]"===Object.prototype.toString.call(e)},n=function(e,t){t.filter?i(t.filter)?e.filter=t.filter.map(function(e){return{type:e.type||"lowpass",frequency:e.frequency||600,q:e.q||1,env:e.env||null}}):e.filter=[{type:t.filter.type||"lowpass",frequency:t.filter.frequency||600,q:t.filter.q||1,env:t.filter.env||null}]:t.filter=null},s=function(e,t){t.vibrato?e.vibrato={shape:g(t.vibrato.shape,"sine"),speed:g(t.vibrato.speed,1),magnitude:g(t.vibrato.magnitude,5),attack:g(t.vibrato.attack,0)}:e.vibrato=null},r=function(e,t){t.tremolo?e.tremolo={shape:g(t.tremolo.shape,"sine"),speed:g(t.tremolo.speed,1),magnitude:g(t.tremolo.magnitude,5),attack:g(t.tremolo.attack,1)}:e.tremolo=null},o=function(e,i){if(i.reverb){e.reverb={wet:g(i.reverb.wet,1)};var n=i.reverb.impulse||l.defaultImpulse,s=new XMLHttpRequest;s.open("GET",n,!0),s.responseType="arraybuffer",e.playable--,s.onload=function(){t.decodeAudioData(s.response,function(t){e.reverb.buffer=t,e.playable++,e.playOnLoad&&e.play(e.playOnLoadArg),e instanceof l.Poly&&e.setUp(i),"mic"===e.source&&e.reverb&&e.reverb.buffer&&e.reverb.node&&!e.reverb.node.buffer&&(e.reverb.node.convolver.buffer=e.reverb.buffer)})},s.send()}else e.reverb=null},a=function(e,i){"panning"in i?(e.panning={location:i.panning},"number"==typeof i.panning?e.panning.type="stereo":(e.panning.type="3d",e.panning.panningModel=i.panningModel||"equalpower")):e.panning={location:0,type:"stereo"},"stereo"!==e.panning.type||t.createStereoPanner||(console.log("Your browser does not support stereo panning. Falling back to 3D panning."),e.panning={location:[0,0,0],type:"3d",panningModel:"equalpower"})},h=function(e,t){t.delay?e.delay={delayTime:g(t.delay.delayTime,.5),maxDelayTime:g(t.delay.maxDelayTime,2),feedback:g(t.delay.feedback,.25),wet:g(t.delay.wet,.25)}:e.delay=null},u=function(e,i){e.nodes=[],e.gain=t.createGain(),e.gain.gain.value=g(i.volume,e.volume),e.nodes.push(e.mediaStreamSource),e.nodes.push(e.gain),(e.filter||i.filter)&&f(e,i),(e.reverb||i.reverb)&&d(e,i),a(e,i),p(e,i),(e.delay||i.delay)&&v(e,i),y(e,i),e.setUpExternalFxOnPlay(i,t)},l=function(i){if(this.source=i.source,this.destination=i.destination||t.destination,this.volume=g(i.volume,1),this.defaultVolume=this.volume,this.playable=1,this.pitch=l.pitches[i.pitch]||i.pitch||440,this.detune=i.detune||0,this.globalReverb=i.globalReverb||!1,this.gain=[],this.loop=i.loop||!1,this.tuna=i.tuna||null,function(e,t){e.env={attack:t.env?g(t.env.attack,1):0,decay:t.env?g(t.env.decay,0):0,sustain:t.env?g(t.env.sustain,1):1,hold:t.env?g(t.env.hold,3.14159):3.14159,release:t.env?g(t.env.release,0):0},e.defaultEnv={attack:t.env?g(t.env.attack,1):0,decay:t.env?g(t.env.decay,0):0,sustain:t.env?g(t.env.sustain,1):1,hold:t.env?g(t.env.hold,3.14159):3.14159,release:t.env?g(t.env.release,0):0}}(this,i),n(this,i),s(this,i),r(this,i),o(this,i),this.constructExternalFx(i,t),a(this,i),h(this,i),"noise"===this.source)this.decodedBuffer=e;else if("mic"===this.source)!function(e,i){e.nodes=[],e.mediaStreamSource=null,e.gain=null,getUserMedia({audio:!0,video:!1}).then(function(n){e.mediaStreamSource=t.createMediaStreamSource(n),l.micConsent=!0,u(e,i)}).catch(function(e){console.log("Error setting up microphone input: ",e)})}(this,i);else if("object"==typeof this.source){var c=t.createBuffer(2,this.source[0].length,t.sampleRate);c.getChannelData(0).set(this.source[0]),c.getChannelData(1).set(this.source[1]),this.decodedBuffer=c}else this.source in{sine:0,sawtooth:0,square:0,triangle:0}?i.callback&&i.callback(this):(f=this,d=i.callback,(p=new XMLHttpRequest).open("GET",f.source,!0),p.responseType="arraybuffer",f.playable--,p.onload=function(){t.decodeAudioData(p.response,function(e){f.decodedBuffer=e,3.14159===f.env.hold&&(f.env.hold=f.decodedBuffer.duration+1),d&&d(f),f.playable++,f.playOnLoad&&f.play(f.playOnLoadArg)})},p.send());var f,d,p};l.micConsent=!1,l.audioContext=t,void 0!=window.Tuna&&(l.tuna=new Tuna(l.audioContext));var c=function(e,t){for(var i=t&&t.destination||e.destination,n=1;n<e.nodes.length;n++){if("custom"===e.nodes[n-1].interface)var s=e.nodes[n-1].output;else var s=e.nodes[n-1];if("custom"===e.nodes[n].interface)var r=e.nodes[n].input;else var r=e.nodes[n];s.connect(r)}if("custom"===e.nodes[e.nodes.length-1].interface)var o=e.nodes[e.nodes.length-1].output;else var o=e.nodes[e.nodes.length-1];o.connect(i),l.reverb&&e.globalReverb&&(e.nodes[e.nodes.length-1].connect(l.reverb.node),l.reverb.node.connect(l.reverb.gain),l.reverb.gain.connect(i))},f=function(e,n){n.filter&&!i(n.filter)&&(n.filter=[n.filter]),e.filter.forEach(function(i,s){i.node=t.createBiquadFilter(),i.node.type=i.type,i.node.frequency.value=n.filter&&n.filter[s]&&n.filter[s].frequency||i.frequency,i.node.Q.value=n.filter&&n.filter[s]&&n.filter[s].q||i.q,(n.filter&&n.filter[s].env||e.filter[s].env)&&"mic"!==e.source&&(i.env={attack:n.filter&&n.filter[s].env&&n.filter[s].env.attack||e.filter[s].env.attack,frequency:n.filter&&n.filter[s].env&&n.filter[s].env.frequency||e.filter[s].env.frequency}),e.nodes.push(i.node)})},d=function(e,i){var n={interface:"custom",input:t.createGain(),convolver:t.createConvolver(),wet:t.createGain(),output:t.createGain()};n.convolver.buffer=e.reverb.buffer,n.wet.gain.value=e.reverb.wet,n.input.connect(n.convolver),n.input.connect(n.output),n.convolver.connect(n.wet),n.wet.connect(n.output),e.reverb.node=n,e.nodes.push(e.reverb.node)},p=function(e,i){var n=i&&i.panning;void 0===n&&(n=e.panning.location),"number"==typeof n?(e.panning.node=t.createStereoPanner(),e.panning.node.pan.value=n,e.panning.type="stereo"):(e.panning.node=t.createPanner(),e.panning.node.setPosition(n[0],n[1],n[2]),e.panning.node.panningModel=i.panningModel||e.panningModel||"equalpower",e.panning.type="3d"),e.nodes.push(e.panning.node)},v=function(e,i){if(e.delay){i.delay||(i.delay={});var n={interface:"custom",input:t.createGain(),output:t.createGain(),delayNode:t.createDelay(e.delay.maxDelayTime),feedbackNode:t.createGain(),wetNode:t.createGain()};n.delayNode.delayTime.value=g(i.delay.delayTime,e.delay.delayTime),n.feedbackNode.gain.value=g(i.delay.feedback,e.delay.feedback),n.wetNode.gain.value=g(i.delay.wet,e.delay.wet),n.input.connect(n.delayNode),n.input.connect(n.output),n.delayNode.connect(n.feedbackNode),n.delayNode.connect(n.wetNode),n.feedbackNode.connect(n.delayNode),n.wetNode.connect(n.output),e.delay.delayNode=n,e.nodes.push(n)}},y=function(e,t){if(e.tuna||t.tuna){var i={};if(e.tuna)for(var n in e.tuna)i[n]=e.tuna[n];if(t.tuna)for(var n in t.tuna)i[n]=t.tuna[n];for(var n in console.log("tunaconfig: ",i),i){console.log(n);var s=new l.tuna[n](i[n]);e.nodes.push(s)}}};l.prototype.constructExternalFx=function(e,t){},l.prototype.setUpExternalFxOnPlay=function(e,t){},l.prototype.play=function(e){var m;return e=e||{arg:null},this.playable<1?(this.playOnLoad=!0,this.playOnLoadArg=e):"mic"===this.source?l.micConsent?null===e.arg?c(this,e):(n(this,e),s(this,e),r(this,e),o(this,e),this.constructExternalFx(e,t),a(this,e),h(this,e),u(this,e),c(this,e)):console.log("You have not given your browser permission to use your microphone."):(this.nodes=[],e.wait||(e.wait=0),e.volume?this.volume=e.volume:this.volume=this.defaultVolume,this.source in{sine:0,sawtooth:0,square:0,triangle:0}?function(e,i){i=i||{},e.soundSource=t.createOscillator(),e.soundSource.type=e.source,i.pitch?i.pitch in l.pitches?e.soundSource.frequency.value=l.pitches[i.pitch]:e.soundSource.frequency.value=i.pitch:e.soundSource.frequency.value=e.pitch,e.soundSource.detune.value=i.detune||e.detune}(this,e):(this.soundSource=t.createBufferSource(),this.soundSource.buffer=this.decodedBuffer,("noise"===this.source||this.loop||e.loop)&&(this.soundSource.loop=!0)),void 0===e.exactTime&&(e.exactTime=t.currentTime+e.wait),this.nodes.push(this.soundSource),function(e,t){t&&t.env?(e.env.attack=g(t.env.attack,e.defaultEnv.attack),e.env.decay=g(t.env.decay,e.defaultEnv.decay),e.env.sustain=g(t.env.sustain,e.defaultEnv.sustain),e.env.hold=g(t.env.hold,e.defaultEnv.hold),e.env.release=g(t.env.release,e.defaultEnv.release)):e.env={attack:e.defaultEnv.attack,decay:e.defaultEnv.decay,sustain:e.defaultEnv.sustain,hold:e.defaultEnv.hold,release:e.defaultEnv.release}}(this,e),function(e,t){t&&t.filter&&e.filter?(i(t.filter)||(t.filter=[t.filter]),f(e,t)):e.filter&&f(e,e)}(this,e),y(this,e),this.setUpExternalFxOnPlay(e,t),this.gain.unshift(t.createGain()),this.gain[0].label=e.label,this.nodes.push(this.gain[0]),this.gain.length>15&&(this.gain.length=15),this.reverb&&d(this,e),p(this,e),v(this,e),c(this,e),this.filter&&this.filter[0].env&&function(e,t){e.filter.forEach(function(e,i){e.node.frequency.linearRampToValueAtTime(e.frequency,t.exactTime),e.node.frequency.linearRampToValueAtTime(e.env.frequency,t.exactTime+e.env.attack)})}(this,e),function(e,t){e.gain[0].gain.linearRampToValueAtTime(1e-4,t.exactTime),e.gain[0].gain.linearRampToValueAtTime(e.volume,t.exactTime+e.env.attack+1e-5),e.gain[0].gain.linearRampToValueAtTime(e.volume*e.env.sustain,t.exactTime+e.env.attack+e.env.decay+2e-5),e.gain[0].gain.linearRampToValueAtTime(e.volume*e.env.sustain,t.exactTime+e.env.attack+e.env.decay+e.env.hold+3e-5),e.gain[0].gain.linearRampToValueAtTime(1e-4,t.exactTime+e.env.attack+e.env.decay+e.env.hold+e.env.release+4e-5),e.soundSource.start(t.exactTime),e.soundSource.stop(t.exactTime+e.env.attack+e.env.decay+e.env.hold+e.env.release)}(this,e),this.vibrato&&((m=this).vibrato.wad=new l({source:m.vibrato.shape,pitch:m.vibrato.speed,volume:m.vibrato.magnitude,env:{attack:m.vibrato.attack},destination:m.soundSource.frequency}),m.vibrato.wad.play()),this.tremolo&&function(e,t){e.tremolo.wad=new l({source:e.tremolo.shape,pitch:e.tremolo.speed,volume:e.tremolo.magnitude,env:{attack:e.tremolo.attack,hold:10},destination:e.gain[0].gain}),e.tremolo.wad.play()}(this)),e.callback&&e.callback(this),this},l.prototype.setVolume=function(e){return this.defaultVolume=e,this.gain.length>0&&(this.gain[0].gain.value=e),this},l.prototype.setSpeed=function(e){var t;return t=e&&e>0?e:0,this.soundSource?this.soundSource.playbackRate.value=t:console.log("Sorry, but the wad does not contain a soundSource!"),this},l.prototype.setDetune=function(e){return this.soundSource.detune.value=e,this},l.prototype.setPanning=function(e){return this.panning.location=e,i(e)&&"3d"===this.panning.type&&this.panning.node?this.panning.node.setPosition(e[0],e[1],e[2]):"number"==typeof e&&"stereo"===this.panning.type&&this.panning.node&&(this.panning.node.pan.value=e),i(e)?this.panning.type="3d":"number"==typeof e&&(this.panning.type="stereo"),this},l.prototype.setReverb=function(e){var t;return t=e&&e>0&&e<1?e:e>=1?1:0,this.reverb?(this.reverb.wet=t,this.reverb.node&&(this.reverb.node.wet.gain.value=t)):console.log("Sorry, but the wad does not contain Reverb!"),this},l.prototype.setDelay=function(e,t,i){var n,s,r;return n=e&&e>0?e:0,s=t&&t>0&&t<1?t:t>=1?1:0,r=i&&i>0&&i<1?i:i>=1?1:0,this.delay?(this.delay.delayTime=n,this.delay.wet=s,this.delay.feedback=r,this.delay.delayNode&&(this.delay.delayNode.delayNode.delayTime.value=n,this.delay.delayNode.wetNode.gain.value=s,this.delay.delayNode.feedbackNode.gain.value=r)):console.log("Sorry, but the wad does not contain delay!"),this},l.prototype.stop=function(e){if("mic"!==this.source){if(e)for(var i=0;i<this.gain.length;i++)this.gain[i].label===e&&(this.gain[i].gain.cancelScheduledValues(t.currentTime),this.gain[i].gain.setValueAtTime(this.gain[i].gain.value,t.currentTime),this.gain[i].gain.linearRampToValueAtTime(1e-4,t.currentTime+this.env.release));e||(this.gain[0].gain.cancelScheduledValues(t.currentTime),this.gain[0].gain.setValueAtTime(this.gain[0].gain.value,t.currentTime),this.gain[0].gain.linearRampToValueAtTime(1e-4,t.currentTime+this.env.release))}else l.micConsent?this.mediaStreamSource.disconnect(0):console.log("You have not given your browser permission to use your microphone.");this.tremolo&&this.tremolo.wad.stop()};var m=new Uint8Array(2048);l.Poly=function(e){e||(e={}),this.isSetUp=!1,this.playable=1,e.reverb?o(this,e):this.setUp(e)},l.Poly.prototype.setUp=function(e){if(this.wads=[],this.input=t.createAnalyser(),this.input.fftSize=2048,this.nodes=[this.input],this.destination=e.destination||t.destination,this.volume=e.volume||1,this.output=t.createGain(),this.output.gain.value=this.volume,this.tuna=e.tuna||null,"undefined"!=typeof Recorder&&e.recConfig){this.rec=new Recorder(this.output,e.recConfig),this.rec.recordings=[];var i=this,s=function(e){i.rec.createWadArg.source=e,i.rec.recordings.unshift(new l(i.rec.createWadArg))};this.rec.createWad=function(e){this.createWadArg=e||{env:{hold:9001}},this.getBuffer(s)}}this.globalReverb=e.globalReverb||!1,n(this,e),this.filter&&f(this,e),this.reverb&&d(this,e),this.constructExternalFx(e,t),a(this,e),p(this,e),e.compressor&&function(e,i){e.compressor=t.createDynamicsCompressor(),e.compressor.attack.value=g(i.compressor.attack,e.compressor.attack.value),e.compressor.knee.value=g(i.compressor.knee,e.compressor.knee.value),e.compressor.ratio.value=g(i.compressor.ratio,e.compressor.ratio.value),e.compressor.release.value=g(i.compressor.release,e.compressor.release.value),e.compressor.threshold.value=g(i.compressor.threshold,e.compressor.threshold.value),e.nodes.push(e.compressor)}(this,e),h(this,e),v(this,e),y(this,e),this.nodes.push(this.output),c(this,e),this.isSetUp=!0,e.callback&&e.callback(this)},l.Poly.prototype.updatePitch=function(e){this.input.getByteTimeDomainData(m);var i,n,s=function(e,t){var i=-1,n=0,s=0,r=!1;if(e.length<1996)return-1;for(var o=0;o<1e3;o++){var a=(e[o]-128)/128;s+=a*a}if((s=Math.sqrt(s/1e3))<.01)return-1;for(var h=1,u=4;u<=1e3;u++){for(var l=0,o=0;o<1e3;o++)l+=Math.abs((e[o]-128)/128-(e[o+u]-128)/128);if((l=1-l/1e3)>.9&&l>h)r=!0;else if(r)return t/i;h=l,l>n&&(n=l,i=u)}return n>.01?t/i:-1}(m,t.sampleRate);if(-1!==s&&11025!==s&&12e3!==s){var r=s;this.pitch=Math.floor(r);var o=(i=r,n=Math.log(i/440)/Math.log(2)*12,Math.round(n)+69);this.noteName=l.pitchesArray[o-12]}var a=this;a.rafID=window.requestAnimationFrame(function(){a.updatePitch()})},l.Poly.prototype.stopUpdatingPitch=function(){cancelAnimationFrame(this.rafID)},l.Poly.prototype.setVolume=function(e){return this.isSetUp?this.output.gain.value=e:console.log("This PolyWad is not set up yet."),this},l.Poly.prototype.play=function(e){if(this.isSetUp)if(this.playable<1)this.playOnLoad=!0,this.playOnLoadArg=e;else{e&&e.volume&&(this.output.gain.value=e.volume,e.volume=void 0);for(var t=0;t<this.wads.length;t++)this.wads[t].play(e)}else console.log("This PolyWad is not set up yet.");return this},l.Poly.prototype.stop=function(e){if(this.isSetUp)for(var t=0;t<this.wads.length;t++)this.wads[t].stop(e)},l.Poly.prototype.add=function(e){return this.isSetUp?(e.destination=this.input,this.wads.push(e),e instanceof l.Poly&&(e.output.disconnect(0),e.output.connect(this.input))):console.log("This PolyWad is not set up yet."),this},l.Poly.prototype.remove=function(e){if(this.isSetUp)for(var i=0;i<this.wads.length;i++)this.wads[i]===e&&(this.wads[i].destination=t.destination,this.wads.splice(i,1),e instanceof l.Poly&&(e.output.disconnect(0),e.output.connect(t.destination)));return this},l.Poly.prototype.constructExternalFx=function(e,t){},l.defaultImpulse="http://www.codecur.io/us/sendaudio/widehall.wav",l.setGlobalReverb=function(e){l.reverb={},l.reverb.node=t.createConvolver(),l.reverb.gain=t.createGain(),l.reverb.gain.gain.value=e.wet;var i=e.impulse||l.defaultImpulse,n=new XMLHttpRequest;n.open("GET",i,!0),n.responseType="arraybuffer",n.onload=function(){t.decodeAudioData(n.response,function(e){l.reverb.node.buffer=e})},n.send()};var g=function(e,t){return null==e?t:e};if(l.pitches={A0:27.5,"A#0":29.1352,Bb0:29.1352,B0:30.8677,"B#0":32.7032,Cb1:30.8677,C1:32.7032,"C#1":34.6478,Db1:34.6478,D1:36.7081,"D#1":38.8909,Eb1:38.8909,E1:41.2034,Fb1:41.2034,"E#1":43.6535,F1:43.6535,"F#1":46.2493,Gb1:46.2493,G1:48.9994,"G#1":51.9131,Ab1:51.9131,A1:55,"A#1":58.2705,Bb1:58.2705,B1:61.7354,Cb2:61.7354,"B#1":65.4064,C2:65.4064,"C#2":69.2957,Db2:69.2957,D2:73.4162,"D#2":77.7817,Eb2:77.7817,E2:82.4069,Fb2:82.4069,"E#2":87.3071,F2:87.3071,"F#2":92.4986,Gb2:92.4986,G2:97.9989,"G#2":103.826,Ab2:103.826,A2:110,"A#2":116.541,Bb2:116.541,B2:123.471,Cb3:123.471,"B#2":130.813,C3:130.813,"C#3":138.591,Db3:138.591,D3:146.832,"D#3":155.563,Eb3:155.563,E3:164.814,Fb3:164.814,"E#3":174.614,F3:174.614,"F#3":184.997,Gb3:184.997,G3:195.998,"G#3":207.652,Ab3:207.652,A3:220,"A#3":233.082,Bb3:233.082,B3:246.942,Cb4:246.942,"B#3":261.626,C4:261.626,"C#4":277.183,Db4:277.183,D4:293.665,"D#4":311.127,Eb4:311.127,E4:329.628,Fb4:329.628,"E#4":349.228,F4:349.228,"F#4":369.994,Gb4:369.994,G4:391.995,"G#4":415.305,Ab4:415.305,A4:440,"A#4":466.164,Bb4:466.164,B4:493.883,Cb5:493.883,"B#4":523.251,C5:523.251,"C#5":554.365,Db5:554.365,D5:587.33,"D#5":622.254,Eb5:622.254,E5:659.255,Fb5:659.255,"E#5":698.456,F5:698.456,"F#5":739.989,Gb5:739.989,G5:783.991,"G#5":830.609,Ab5:830.609,A5:880,"A#5":932.328,Bb5:932.328,B5:987.767,Cb6:987.767,"B#5":1046.5,C6:1046.5,"C#6":1108.73,Db6:1108.73,D6:1174.66,"D#6":1244.51,Eb6:1244.51,Fb6:1318.51,E6:1318.51,"E#6":1396.91,F6:1396.91,"F#6":1479.98,Gb6:1479.98,G6:1567.98,"G#6":1661.22,Ab6:1661.22,A6:1760,"A#6":1864.66,Bb6:1864.66,B6:1975.53,Cb7:1975.53,"B#6":2093,C7:2093,"C#7":2217.46,Db7:2217.46,D7:2349.32,"D#7":2489.02,Eb7:2489.02,E7:2637.02,Fb7:2637.02,"E#7":2793.83,F7:2793.83,"F#7":2959.96,Gb7:2959.96,G7:3135.96,"G#7":3322.44,Ab7:3322.44,A7:3520,"A#7":3729.31,Bb7:3729.31,B7:3951.07,Cb8:3951.07,"B#7":4186.01,C8:4186.01},l.pitchesArray=["C0","C#0","D0","D#0","E0","F0","F#0","G0","G#0","A0","A#0","B0","C1","C#1","D1","D#1","E1","F1","F#1","G1","G#1","A1","A#1","B1","C2","C#2","D2","D#2","E2","F2","F#2","G2","G#2","A2","A#2","B2","C3","C#3","D3","D#3","E3","F3","F#3","G3","G#3","A3","A#3","B3","C4","C#4","D4","D#4","E4","F4","F#4","G4","G#4","A4","A#4","B4","C5","C#5","D5","D#5","E5","F5","F#5","G5","G#5","A5","A#5","B5","C6","C#6","D6","D#6","E6","F6","F#6","G6","G#6","A6","A#6","B6","C7","C#7","D7","D#7","E7","F7","F#7","G7","G#7","A7","A#7","B7","C8"],l.midiInstrument={play:function(){console.log("playing midi")},stop:function(){console.log("stopping midi")}},l.midiInputs=[],midiMap=function(e){console.log(e.receivedTime,e.data),144===e.data[0]?0===e.data[2]?(console.log("|| stopping note: ",l.pitchesArray[e.data[1]-12]),l.midiInstrument.stop(l.pitchesArray[e.data[1]-12])):e.data[2]>0&&(console.log("> playing note: ",l.pitchesArray[e.data[1]-12]),l.midiInstrument.play({pitch:l.pitchesArray[e.data[1]-12],label:l.pitchesArray[e.data[1]-12],callback:function(e){}})):176===e.data[0]?(console.log("controller"),46==e.data[1]&&(127==e.data[2]?l.midiInstrument.pedalMod=!0:0==e.data[2]&&(l.midiInstrument.pedalMod=!1))):224===e.data[0]&&console.log("pitch bend")},navigator&&navigator.requestMIDIAccess)try{navigator.requestMIDIAccess().then(function(e){l.midiInputs=[];for(var t=e.inputs.values(),i=t.next();!i.done;i=t.next())l.midiInputs.push(i.value);console.log("MIDI inputs: ",l.midiInputs);for(var n=0;n<l.midiInputs.length;n++)l.midiInputs[n].onmidimessage=midiMap},function(e){console.log("uh-oh! Something went wrong!  Error code: "+e.code)})}catch(e){var b="There was an error on this page.\n\n";b+="Error description: "+e.message+"\n\n",b+="Click OK to continue.\n\n",console.log(b)}return l.presets={hiHatClosed:{source:"noise",env:{attack:.001,decay:.008,sustain:.2,hold:.03,release:.01},filter:{type:"highpass",frequency:400,q:1}},snare:{source:"noise",env:{attack:.001,decay:.01,sustain:.2,hold:.03,release:.02},filter:{type:"bandpass",frequency:300,q:.18}},hiHatOpen:{source:"noise",env:{attack:.001,decay:.008,sustain:.2,hold:.43,release:.01},filter:{type:"highpass",frequency:100,q:.2}},ghost:{source:"square",volume:.3,env:{attack:.01,decay:.002,sustain:.5,hold:2.5,release:.3},filter:{type:"lowpass",frequency:600,q:7,env:{attack:.7,frequency:1600}},vibrato:{attack:8,speed:8,magnitude:100}},piano:{source:"square",volume:1.4,env:{attack:.01,decay:.005,sustain:.2,hold:.015,release:.3},filter:{type:"lowpass",frequency:1200,q:8.5,env:{attack:.2,frequency:600}}}},l}();return void 0!==e&&e.exports&&(e.exports=i),i}()}.apply(t,[]))||(e.exports=n)},function(e,t,i){"use strict";function n(e){if(Array.isArray(e)){for(var t=0,i=Array(e.length);t<e.length;t++)i[t]=e[t];return i}return Array.from(e)}function s(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;if(!(this instanceof s))return new(Function.prototype.bind.apply(s,[null].concat(Array.prototype.slice.call(arguments))));null!==e&&(e instanceof HTMLElement?this.push(e):e.match(/^#|\./)?this.push.apply(this,n(document.querySelectorAll(e))):this.push(document.createElement(e)))}function r(e){return"number"==typeof e?e?e<0?-1:1:e==e?0:NaN:NaN}i.r(t);var o=i(0),a=i.n(o),h={sendArrayBufferView:function(e,t){var i=new XMLHttpRequest;i.open("POST",t,!0),i.send(e)},getArrayBuffer:function(e){return new a.a(function(t,i){var n=new XMLHttpRequest;n.open("GET",e,!0),n.responseType="arraybuffer",n.onload=function(){var e=n.response;e?t(e):i(!1)},n.send(null)})}},u={audioCache:{},enabled:!0,addSound:function(e,t){this.audioCache[e]=t},toggleSound:function(e){this.enabled=e},play:function(e,t,i,n){var s=null;if(this.enabled){if(void 0!==(s=this.audioCache[e]))return"function"==typeof s.loop?s.loop(t||!1):s.loop=t||!1,s.play({panning:[n||0,0,5],volume:i||1,loop:t||!1});console.warn("[AM] could not find sound, did you load:",e)}},stop:function(e,t){var i=null;if(this.enabled){try{i=this.audioCache[e]}catch(t){return void console.warn("[AM] WARN: unable to stop sound",e)}i&&"function"==typeof i.stop&&i.stop(t||void 0)}}},l={create:function(e,t){e._pool=[],e._poolMarker=0,e._poolSize=0;var i=e._pool;e.createFromPool=function(){e._poolSize<=e._poolMarker&&e.expandPool(10);var t=e._pool[e._poolMarker++];return t._poolIndex=e._poolMarker-1,e.prototype.constructor.apply(t,arguments),t},e.expandPool=function(t){for(var n={pool:!0},s=i.length,r=i.length+t;s<r;s++)i.push(new e(n));e._poolSize+=t},e.prototype.freeFromPool=function(){e._poolMarker>0&&e._poolMarker--;var t=i[e._poolMarker],n=t._poolIndex;i[e._poolMarker]=this,i[this._poolIndex]=t,t._poolIndex=this._poolIndex,this._poolIndex=n},e.expandPool(t)}},c=i(2),f=i.n(c),d=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),p=function(){function e(){var t=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.promise=new a.a(function(e,i){t.resolve=e,t.reject=i})}return d(e,null,[{key:"resolve",value:function(e){return a.a.resolve(e)}}]),e}(),v="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};s.prototype=new Array,Object.assign(s.prototype,{css:function(e,t){if("object"===(void 0===e?"undefined":v(e)))this.forEach(function(t){var i=t.style;for(var n in e)i[n]=e[n]});else{if(void 0===t)return this.length?this[0].style[e]:null;this.forEach(function(i){i.style[e]=t})}return this},find:function(e){var t=new s;return this.forEach(function(i){for(var n=i.querySelectorAll(e),s=0;s<n.length;++s)t.push(n[s])}),t},appendTo:function(e){var t="object"===(void 0===e?"undefined":v(e))&&e||document.querySelector(e);return t&&this.forEach(function(e){t.appendChild(e)}),this},attr:function(e,t){return"object"===(void 0===e?"undefined":v(e))?this.forEach(function(t){for(var i in e)t.setAttribute(i,e[i])}):this.forEach(function(i){i.setAttribute(e,t)}),this},addClass:function(e){var t=e.split(" ");return this.forEach(function(e){var i;(i=e.classList).add.apply(i,n(t))}),this},removeClass:function(e){var t=e.split(" ");this.forEach(function(e){var i;(i=e.classList).remove.apply(i,n(t))})},html:function(e){return this.forEach(function(t){return t.innerHTML=e}),this},show:function(){return this.forEach(function(e){e.style.display="block"}),this},hide:function(){return this.forEach(function(e){e.style.display="none"}),this}});var y=s,m="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},g=window.createImageBitmap||function(e){return p.resolve(e)},b={isLocal:!!document.location.href.match(/^file:\/\//),scriptMaxTime:3e3,groupMaxTime:5e3,resources:{any:{def:new p,loadedRes:0,numRes:0,res:{},progressCb:null,errorCb:null}},dynamicScripts:{},iOS:!!navigator.userAgent.match(/iPhone|iPad/),skipResources:["script"],async:!0,loading:!1,getResourceById:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"any",i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=this.resources[t].res[e];return n&&n.loaded?!0===i?n:n.elt:this.dynamicScripts[e]?this.dynamicScripts[e]:void console.error("[RM] unknwon resource id",e)},newResourceFromPool:function(e){var t=this.getResourceById(e);return"function"==typeof t.createFromPool?t.createFromPool.apply(t,Array.prototype.slice.call(arguments,1)):function(e){return new(e.bind.apply(e,arguments))}.apply(void 0,[t].concat(Array.prototype.slice.call(arguments,1)))},_createGroup:function(e){this._groupExists(e)?this.resources[e].def=new p:this.resources[e]={def:new p,loadedRes:0,numRes:0,res:{},progressCb:null,errorCb:null}},_groupExists:function(e){return void 0!==this.resources[e]},addResources:function(e,t){t=t||"any",this._createGroup(t);var i=void 0,n=this.resources[t];if(null!==e)if("object"===(void 0===e?"undefined":m(e))&&e.constructor===Array)for(i in e)void 0===n.res[e[i].id]&&-1===this.skipResources.indexOf(e[i].type)&&(n.res[e[i].id]=JSON.parse(JSON.stringify(e[i])),n.numRes++);else void 0===n.res[e.id]&&-1===this.skipResources.indexOf(e.type)&&(n.res[e.id]=JSON.parse(JSON.stringify(e)),n.numRes++);return null!==e&&n.numRes!==n.loadedRes||n.def.resolve(!0),n.def.promise},loadNextResource:function(e){var t=this.resources[e],i=void 0;for(i in t.res)if(!t.res[i].loaded&&-1===this.skipResources.indexOf(t.res[i].type)){this._loadResource(t.res[i],e);break}},loadResources:function(e){var t=this,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:void 0;if(e=e||"any",!0!==this.loading){this.loading=!0;var s=this.resources[e],r=null,o=void 0,a=0;for(o in s.progressCb=i||null,s.errorCb=n||null,s.res)s.res[o].loaded||-1!==this.skipResources.indexOf(s.res[o].type)||(a++,this.async?this._loadResource(s.res[o],e):null===r&&(r=s.res[o]));this.async||this._loadResource(r,e),0!==a?s.gpTimeout=setTimeout(function(){var e,i=[];if(s.gpTimeout){for(e in s.gpTimeout=null,console.error("[RM] Unable to load the following resources after",t.groupMaxTime/1e3,"sec"),s.res)s.res[e].loaded||(i.push("["+s.res[e].type+"] "+e),console.warn("["+s.res[e].type+"] "+e+": "+s.res[e].src));s.errorCb&&s.errorCb("Unable to get all resources after",t.groupMaxTime,i)}},this.groupMaxTime):this.loading=!1}else console.warn("[ResourceManager] loadResources() -> already loading")},getCanvasFromImage:function(e){var t=document.createElement("canvas");return t.width=e.naturalWidth,t.height=e.naturalHeight,t.getContext("2d").drawImage(e,0,0),t},loadImage:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0,i=new Image,n=this,s=new p;return i.onload=function(){g(this).then(function(r){e.elt=r,e.img=i,e.loaded=!0,t&&n._resLoaded(t),s.resolve(!!t||r)})},i.src=e.src,s.promise},createObjectPool:function(e,t){l.create(e,t)},registerScript:function(e,t,i){var n=this.dynamicScripts[e];i&&this.createObjectPool(t,i),n?console.error("existing script with the id",e,"should I replace it?"):this.dynamicScripts[e]=t},loadScript:function(e,t,i){var n=new p;return console.error("loadScript not supported"),console.log("[RM] loading script",e.src),n.promise},loadAudio:function(e,t){var i=this,n=new Audio,s=new p;return n.preload="auto",n.addEventListener("canplaythrough",function n(){this.removeEventListener("canplaythrough",n),e.elt=this,e.loaded=!0,u.addSound(e.id,this),i._resLoaded(t),s.resolve(!0)}),n.addEventListener("loadstart",function(){console.log("loadStarted",n.src)}),n.src=e.src,s.promise},loadWadAudio:function(e,t){var i=this,n=new p,s=new f.a({source:e.src,callback:function(){e.elt=s,e.loaded=!0,u.addSound(e.id,s),i._resLoaded(t),n.resolve(!0)}});return n.promise},loadJSON:function(e,t,i){var n=this,s=new p;fetch(e.src).then(function(e){if(200===e.status)return e.json();throw"Error getting photo list"}).then(function(r){e.elt=r,e.loaded=!0,i?i.call(n,e,t).then(function(){s.resolve(!0)}):(n._resLoaded(t),s.resolve(!0))})},loadMapData:function(e,t){var i=this,n=new p,s=this.resources[t];return h.getArrayBuffer((document.location.href.match("warpdesign.fr")?"/gods/":"")+e.elt.dataUrl).then(function(s){e.elt.buffer=s,e.loaded=!0,i._resLoaded(t),n.resolve(!0)},function(){s.def.reject('Unable to load map resource "'+e.src+'" ['+e.id+"]")}),n.promise},_resLoaded:function(e){var t=this.resources[e];t.loadedRes++,new y("span.loaded").html(t.loadedRes),t.progressCb&&t.progressCb.call(this,Math.floor(100*t.loadedRes/t.numRes)),t.loadedRes===t.numRes?(this.loading=!1,null!==t.gpTimeout&&clearTimeout(t.gpTimeout),t.def.resolve(!0)):this.async||this.loadNextResource(e)},_loadResource:function(e,t){switch(e.type){case"image":return this.loadImage(e,t);case"audio":return this.loadWadAudio(e,t);case"script":return this.loadScript(e,t);default:return this.loadJSON(e,t,this.loadMapData)}}},w=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),k=function(){function e(t,i){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.easing=null,this.context=t.context||this,void 0!==i&&(this.width=i.width,this.height=i.height),this.startValue=void 0!==t.startValue?t.startValue:0,this.endValue=void 0!==t.endValue?t.endValue:1,this.loop=void 0===t.loop?0:t.loop,this.loops=0,this.duration=t.duration||400}return w(e,[{key:"setEasing",value:function(e){this.easing=e}},{key:"start",value:function(){return this.loops||(this.def=new p),this.startTime=(new Date).getTime(),this.ended=!1,this.stopped=!1,this.def.promise}},{key:"stop",value:function(e,t){this.stopped=!0}},{key:"process",value:function(e,t,i){var n=(new Date).getTime()-this.startTime,s=n/this.duration;return this.stopped||n>=this.duration?(this.loops++,this.stopped||this.loops>=this.loop?(this.animProgress=1,this.ended=!0,this.def.resolve(!0)):this.start()):this.animProgress=this.easing(s,n,0,1,this.duration),this.ended}}]),e}(),x=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),_=function e(t,i,n){null===t&&(t=Function.prototype);var s=Object.getOwnPropertyDescriptor(t,i);if(void 0===s){var r=Object.getPrototypeOf(t);return null===r?void 0:e(r,i,n)}if("value"in s)return s.value;var o=s.get;return void 0!==o?o.call(n):void 0},T=function(e){function t(e,i){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var n=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,Object.assign({startValue:0,endValue:1},e),i));return n.startOpacity=void 0!==n.startValue?e.startValue:0,n.endOpacity=void 0!==n.endValue?e.endValue:1,n.diff=n.endValue-n.startValue,n}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,k),x(t,[{key:"start",value:function(){return this.currentOpacity=1,_(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"start",this).call(this)}},{key:"process",value:function(e,i,n){return _(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"process",this).call(this),this.currentOpacity=this.startValue+this.animProgress*this.diff,n.setOpacity(this.currentOpacity),this.ended}}]),t}(),O=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),S=function e(t,i,n){null===t&&(t=Function.prototype);var s=Object.getOwnPropertyDescriptor(t,i);if(void 0===s){var r=Object.getPrototypeOf(t);return null===r?void 0:e(r,i,n)}if("value"in s)return s.value;var o=s.get;return void 0!==o?o.call(n):void 0},E=function(e){function t(e,i){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var n=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,Object.assign({startValue:0,endValue:2*Math.PI,loop:!0},e),i));return n.startAngle=void 0!==n.startAngle?e.startValue:0,n.endAngle=void 0!==n.endAngle?e.endValue:1,n.diff=n.endValue-n.startValue,n}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,k),O(t,[{key:"start",value:function(){return this.currentAngle=this.startAngle,S(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"start",this).call(this)}},{key:"stop",value:function(e,i){S(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"stop",this).call(this),e.setAngle(i)}},{key:"process",value:function(e,i,n){return S(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"process",this).call(this),this.currentAngle=this.startValue+this.animProgress*this.diff,n.setAngle(this.currentAngle),this.ended}}]),t}(),C=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),M=function(e){function t(e,i){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var n=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,i));return n.callback=e.callback,n.diff=n.endValue-n.startValue,n}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,k),C(t,[{key:"process",value:function(e,i){return function e(t,i,n){null===t&&(t=Function.prototype);var s=Object.getOwnPropertyDescriptor(t,i);if(void 0===s){var r=Object.getPrototypeOf(t);return null===r?void 0:e(r,i,n)}if("value"in s)return s.value;var o=s.get;return void 0!==o?o.call(n):void 0}(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"process",this).call(this),this.callback(this.startValue+this.animProgress*this.diff,e,i),this.ended}}]),t}(),P=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),A=function e(t,i,n){null===t&&(t=Function.prototype);var s=Object.getOwnPropertyDescriptor(t,i);if(void 0===s){var r=Object.getPrototypeOf(t);return null===r?void 0:e(r,i,n)}if("value"in s)return s.value;var o=s.get;return void 0!==o?o.call(n):void 0},j=function(e){function t(e,i){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var n=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,Object.assign({startValue:.002,endValue:1},e),i));return n.buffer=i.getBuffer(n.width,n.height),n.startWidth=null,n.ratio=n.width/n.height,n.diff=n.endValue*n.width-n.startValue*n.width,n}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,k),P(t,[{key:"start",value:function(){return this.startWidth=this.startValue*this.width,A(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"start",this).call(this)}},{key:"process",value:function(e){A(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"process",this).call(this);var i=this.startWidth+this.animProgress*this.diff,n=i/this.ratio;return this.buffer.drawImage(e.canvas,0,0,0|i,0|n),e.clearRect(0,0,e.canvas.width,e.canvas.height),e.drawImage(this.buffer.canvas,0,0,0|i,0|n,0,0,this.width,this.height),this.ended}}]),t}(),F=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),L={},R={},D=new(function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.addEasing("linear",function(e){return e})}return F(e,[{key:"addFX",value:function(e,t){L[e]=t}},{key:"getEffect",value:function(e){return L[e]}},{key:"addEasing",value:function(e,t){R[e]=t}},{key:"getEasing",value:function(e){return R[e]||R.linear}}]),e}());D.addFX("Mosaic",j),D.addFX("Fade",T),D.addFX("Rotate",E),D.addFX("Custom",M);var I=D,Y=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),N=function(){function e(t,i){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e);var n,s,r=(n=window.getComputedStyle(document.documentElement,""),s=(Array.prototype.slice.call(n).join("").match(/-(moz|webkit|ms)-/)||""===n.OLink&&["","o"])[1],{dom:"WebKit|Moz|MS|O".match(new RegExp("("+s+")","i"))[1],lowercase:s,css:"-"+s+"-",js:s[0].toUpperCase()+s.substr(1)});this.layers=new Array(t.layers.length+1),this.layersIndex=t.layers,this.sortedLayers=this._sortLayers(),this.prefix=r.lowercase,this.target=i||y("div").attr("id","display_"+t.name).appendTo("body")[0],this.width=t.width,this.height=t.height,this.type=t.type||"2d",this.fxCtx=null,this.isFullscreen=!1,this._addFullscreenEvents(),this._createLayers(),this.fxQueue={pre:{},post:{}}}return Y(e,[{key:"getBuffer",value:function(e,t){var i=y("canvas").attr({width:e+"px",height:t+"px"})[0].getContext("2d");return i.imageSmoothingEnabled=!1,i}},{key:"_addFullscreenEvents",value:function(){var e=this.target;e.addEventListener("webkitfullscreenchange",this._onFullscreenChange.bind(this),!1),document.addEventListener("mozfullscreenchange",this._onFullscreenChange.bind(this),!1),e.addEventListener("fullscreenchange",this._onFullscreenChange.bind(this),!1),e.addEventListener("MSFullscreenChange",this._onFullscreenChange.bind(this),!1)}},{key:"_onFullscreenChange",value:function(){var e=document.webkitFullscreenElement||document.fullscreenElement||document.mozFullScreenElement||document.msFullscreenElement;if(this.isFullscreen=e===this.target,this.isFullscreen){var t=this._getFullScreenSize(this.width,this.height);console.log("size",t.scaleX,t.scaleY),y(this.target).css({width:t.width+"px",height:t.height+"px"}).find("canvas").css({width:t.width+"px",height:t.height+"px",top:t.top+"px",left:t.left+"px"})}else y(this.target).css({width:this.width+"px",height:this.height+"px"}).find("canvas").css({width:this.width+"px",height:this.height+"px",top:0,left:0})}},{key:"_getFullScreenSize",value:function(e,t){var i,n,s=e/t,r=navigator.userAgent.match(/Edge|Firefox/),o=navigator.userAgent.match(/Edge/),a=screen.width,h=screen.height;return o&&(a=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth,h=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight),console.log("screen",screen.width,screen.height),s>0?i=(n=h)*s:n=(i=a)*s,{width:i,height:n,scaleX:i/e,scaleY:n/t,top:r?(h-n)/2:0,left:r?(a-i)/2:0}}},{key:"toggleFullscreen",value:function(){this.isFullscreen=!this.isFullscreen,this.isFullscreen?(console.log("request fullscreen"),this.target.requestFullScreen=this.target.requestFullscreen||this.target.webkitRequestFullscreen||this.target.mozRequestFullScreen||this.target.msRequestFullscreen,this.target.requestFullScreen?this.target.requestFullScreen():console.warn("Request fullscreen support not detected.")):(console.log("exit fullscreen"),document.exitFullScreen=document.exitFullscreen||document.webkitExitFullscreen||document.mozExitFullScreen||document.msExitFullscreen,document.exitFullScreen?document.exitFullScreen():console.log("Exit fullscreen support not detected."))}},{key:"_createLayers",value:function(){var e=void 0;for(e=0;e<this.layers.length;++e)this.layers[e]=y("canvas").addClass("layer_"+e).attr({width:this.width,height:this.height}).css({width:this.width+"px",height:this.height+"px",position:"absolute",zIndex:this._getLayerZIndex(e)}).appendTo(this.target)[0].getContext(this.type),this.layers[e].imageSmoothingEnabled=!1;this.fxCtx=y("canvas").addClass("fx").attr({width:this.width,height:this.height}).css({width:this.width+"px",height:this.height+"px",position:"absolute",zIndex:3}).appendTo(this.target)[0].getContext(this.type),this.fxCtx.imageSmoothingEnabled=!1}},{key:"_getLayerZIndex",value:function(e){return e<this.layersIndex.length?this.layersIndex[e]?0:2:1}},{key:"_sortLayers",value:function(){var e=[];return this.layersIndex.forEach(function(t,i){t&&e.push(i)}),e.push(this.layers.length-1),this.layersIndex.forEach(function(t,i){t||e.push(i)}),e}},{key:"setLayerZIndex",value:function(e,t){e<this.layers.length&&(y(this.layers[e].canvas).css("zIndex",t),this.layersIndex[e]=0===t,this.orderedLayers=this._sortLayers())}},{key:"clearScreen",value:function(e){e.setTransform(1,0,0,1,0,0),e.clearRect(0,0,this.width,this.height)}},{key:"clearAllScreens",value:function(){for(var e=0;e<this.layers.length;++e)this.clearScreen(this.layers[e]);this.clearScreen(this.fxCtx)}},{key:"setCanvasOpacity",value:function(e,t){e.style.opacity=t}},{key:"renderScene",value:function(e){this.clearScreen(this.fxCtx),this.executeFx(null,null,e,null,"pre");for(var t=0;t<this.layers.length;++t)this.setCanvasOpacity(this.layers[t].canvas,Object.keys(this.fxQueue.post).length?0:e.getOpacity());for(var i=0;i<this.layers.length-1;i++)this.clearScreen(this.layers[i]);if(e.render(this.layers),e.hudScene&&e.hudScene.render(this.layers),Object.keys(this.fxQueue.post).length){this.clearScreen(this.fxCtx),this.setCanvasOpacity(this.fxCtx.canvas,0);for(var n=0;n<this.layers.length;++n){var s=this.sortedLayers[n];this.fxCtx.drawImage(this.layers[s].canvas,0,0)}}this.executeFx(this.fxCtx,this.fxCtx,e,null,"post"),Object.keys(this.fxQueue.post).length&&this.setCanvasOpacity(this.fxCtx.canvas,1)}},{key:"prepareCanvas",value:function(e){var t=null,i=0,n="";for(i=0;i<this.layers.length;++i)n=(t=this.layers[i]).canvas.style.display,t.canvas.style.display="none",e.forEach(function(e){"image"===e.type&&t.drawImage(e.elt,0,0)}),this.clearScreen(t),t.canvas.style.display=n}},{key:"animate",value:function(e,t,i){var n,s,r=this,o=I.getEffect(e),a=t.easing||"linear",h=t.when||"pre";if(t.context=i||this,void 0!==this.fxQueue[h][e]){console.warn("[Display] animate() - "+e+" already in progress, cannot execute twice.");var u=new p;u.resolve(),n=u.promise}else o?((s=new o(t,this)).setEasing(new I.getEasing(a)),n=s.start().then(function(){delete r.fxQueue[h][e]}).catch(function(e){console.error(e)}),this.fxQueue[h][e]=s):console.warn("[Display] animate() - "+e+" unknown: did you spell it correctly ?");return n}},{key:"stopAnimate",value:function(){console.log("TODO: need to stop animation")}},{key:"executeFx",value:function(e,t,i,n,s){for(var r in s=s||"pre",this.fxQueue[s])this.fxQueue[s][r].process(e,t,i,n)}},{key:"clearDisplay",value:function(){this.fxQueue.pre={},this.fxQueue.post={},this.clearAllScreens()}}]),e}(),B=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),G=new(function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.displays={}}return B(e,[{key:"addDisplay",value:function(e,t){return console.log("[Display Manager] adding display",e.name),this.displays[e.name]=new N(e,t),this.displays[e.name]}},{key:"getDisplay",value:function(e){return this.displays[e]}}]),e}()),H={},W={notify:function(e,t){var i={type:e,data:t};H[e]?H[e].forEach(function(e){return e(i)}):H["*"]&&H["*"].forEach(function(e){return e(i)})},listen:function(e,t){console.log("[NotificationManager] listening to event(s) "+e),e.replace(/\s+/g," ").split(" ").forEach(function(e){H[e]||(H[e]=[]),H[e].push(t)})}};window.NM=W;for(var X=W,q={KEYS:{UP:38,DOWN:40,LEFT:37,RIGHT:39,SPACE:32,ENTER:13,ESCAPE:27,CTRL:17},PAD_BUTTONS:{32:1,FACE_0:1,FACE_3:2,FACE_4:3,LEFT_SHOULDER:4,RIGHT_SHOULDER:5,LEFT_SHOULDER_BOTTOM:6,RIGHT_SHOULDER_BOTTOM:7,SELECT:8,START:9,LEFT_ANALOGUE_STICK:10,RIGHT_ANALOGUE_STICK:11,38:12,40:13,37:14,39:15},axes:{},newGamepadPollDelay:1e3,gamepadSupport:!1,recording:!1,playingEvents:!1,playingPos:0,recordedEvents:[],pad:null,latches:{},keyPressed:{},padPressed:{},keyCb:{},enabled:!0,inputMode:"keyboard",dPadJoystick:null,jPollInterval:0,init:function(){this._generateKeyCodes(),this._installInputModeSwitchHandler(),this._installKBEventHandlers(),this._pollNewGamepad(),this.setInputMode(this.inputMode)},_generateKeyCodes:function(){for(var e=65;e<91;++e)this.KEYS[String.fromCharCode(e)]=e},_installInputModeSwitchHandler:function(){var e=this;document.addEventListener("touchstart",function(){e.setInputMode("joystick")})},startRecordingEvents:function(){this.recording||(this.recordedEvents.length=0,this.recording=!0,console.log("[InputManager] Starting record of input events!"))},stopRecordingEvents:function(){this.recording=!1,console.log("[InputManager] Stoping record of input events, recorded",this.recordedEvents.length,"events")},playRecordedEvents:function(){this.playingEvents||(console.log("[InputManager] Starting to play an existing record of input events!"),this.playingEvents=!0,this.playPos=0)},nextRecordedEvents:function(){this.playingPos>=this.recordedEvents.length?(this.playingEvents=!1,this.keyPressed={38:!1,40:!1,37:!1,39:!1,32:!1,13:!1,27:!1,17:!1},console.log("[InputManager] Reached the end of recorded events, resetting keys status to default!")):this.keyPressed=this.recordedEvents[this.playingPos++]},recordEvents:function(){this.recordedEvents.push(JSON.parse(JSON.stringify(this.keyPressed)))},setInputMode:function(e){if(this.inputMode!==e){switch(e){case"virtual_joystick":this.dPadJoystick&&(this.jPollInterval=setInterval(this._pollJoystick.bind(this),1/30*1e3));break;case"keyboard":this._clearJoystickPoll();break;case"gamepad":this._clearJoystickPoll(),requestAnimationFrame(this._pollGamepad.bind(this))}this._resetKeys(),this.inputMode=e}},_resetKeys:function(){for(var e in this.keyPressed)this.keyPressed[e]=!1,this.latches[e]=!1},_pollNewGamepad:function(){var e=this,t=navigator.getGamepads&&navigator.getGamepads()||navigator.webkitGetGamepads&&navigator.webkitGetGamepads(),i=null;if(t&&t.length)for(var n=0;n<t.length;++n)(i=t[n])&&(this.pad=i,this.gamepadSupport||(console.log("[Event] Oh oh! Looks like we have a new challenger: ",i.id),this.gamepadSupport=!0,this.setInputMode("gamepad")));this.gamepadSupport||setTimeout(function(){e._pollNewGamepad()},this.newGamepadPollDelay)},_pollGamepad:function(){this._pollNewGamepad(),this.pad.buttons[12].pressed&&!this.latches[this.KEYS.UP]?(this.keyPressed[this.KEYS.UP]=!0,this.keyPressed[this.KEYS.DOWN]=!1):this.pad.buttons[13].pressed&&!this.latches[this.KEYS.DOWN]?(this.latches[this.KEYS.UP]=!1,this.keyPressed[this.KEYS.DOWN]=!0,this.keyPressed[this.KEYS.UP]=!1):(this.latches[this.KEYS.UP]=!1,this.latches[this.KEYS.DOWN]=!1,this.keyPressed[this.KEYS.DOWN]=!1,this.keyPressed[this.KEYS.UP]=!1),this.pad.buttons[15].pressed&&!this.latches[this.KEYS.RIGHT]?(this.keyPressed[this.KEYS.RIGHT]=!0,this.keyPressed[this.KEYS.LEFT]=!1):this.pad.buttons[14].pressed?(this.latches[this.KEYS.RIGHT]=!1,this.keyPressed[this.KEYS.LEFT]=!0,this.keyPressed[this.KEYS.RIGHT]=!1):(this.latches[this.KEYS.RIGHT]=!1,this.latches[this.KEYS.LEFT]=!1,this.keyPressed[this.KEYS.LEFT]=!1,this.keyPressed[this.KEYS.RIGHT]=!1),this.pad.buttons[0].pressed&&!this.latches[this.KEYS.SPACE]?this.keyPressed[this.KEYS.SPACE]=!0:this.pad.buttons[0].pressed||(this.latches[this.KEYS.SPACE]=!1,this.keyPressed[this.KEYS.SPACE]=!1),this.pad.buttons[1].pressed&&!this.latches[this.KEYS.CTRL]?this.keyPressed[this.KEYS.CTRL]=!0:this.pad.buttons[1].pressed||(this.latches[this.KEYS.CTRL]=!1,this.keyPressed[this.KEYS.CTRL]=!1),this.jPollInterval=requestAnimationFrame(this._pollGamepad.bind(this))},_getModifiers:function(){return{ALT:!0,SHIFT:!0,CTRL:!0,META:!0}},_initVirtualJoystick:function(){var e=this,t=void 0;console.log("[InputManager] _initVirtualJoystick"),(this.dPadJoystick=new VirtualJoystick({container:document.body,strokeStyle:"cyan",limitStickTravel:!0,mouseSupport:!0,stickRadius:60})).addEventListener("touchStartValidation",function(e){return!(e.changedTouches[0].pageX>=window.innerWidth/2)}),(t=this.fireJoystick=new VirtualJoystick({container:document.body,strokeStyle:"orange",limitStickTravel:!0,mouseSupport:!0,stickRadius:0})).addEventListener("touchStartValidation",function(e){return!(e.changedTouches[0].pageX<window.innerWidth/2)}),t.addEventListener("touchStart",function(){"virtual_joystick"===e.inputMode&&(e.keyPressed[e.KEYS.CTRL]=!0)}),t.addEventListener("touchEnd",function(){"virtual_joystick"===e.inputMode&&(e.keyPressed[e.KEYS.CTRL]=!1)})},_clearJoystickPoll:function(){this.jPollInterval&&(cancelAnimationFrame(this.jPollInterval),this.jPollInterval=0)},_pollJoystick:function(){var e=this,t=[],i=[],n=this.dPadJoystick;Math.abs(n.deltaX())>=10?n.left()?(t.push("LEFT"),i.push("RIGHT")):(t.push("RIGHT"),i.push("LEFT")):(i.push("LEFT"),i.push("RIGHT")),Math.abs(n.deltaY())>=10?n.up()?(t.push("UP"),i.push("DOWN")):(t.push("DOWN"),i.push("UP")):(i.push("UP"),i.push("DOWN")),t.length&&t.forEach(function(t){e.keyPressed[e.KEYS[t]]=!0}),i.length&&i.forEach(function(t){e.keyPressed[e.KEYS[t]]=!1})},_installKBEventHandlers:function(){var e=this;document.addEventListener("keydown",function(t){if("keyboard"===e.inputMode&&!e.playingEvents){switch(t.keyCode){case 32:case 37:case 38:case 39:case 40:t.preventDefault()}t.keyCode&&!e.latches[t.keyCode]&&(e.keyPressed[t.keyCode]=!0),e.metas=e._getModifiers(),e.enabled&&e.keyCb[t.keyCode]&&e.keyCb[t.keyCode].down.forEach(function(e){e(String.fromCharCode(t.keyCode),t)})}}),document.addEventListener("keyup",function(t){"keyboard"!==e.inputMode||e.playingEvents||(t.keyCode&&(e.keyPressed[t.keyCode]=!1,e.latches[t.keyCode]=!1),e.metas=e._getModifiers(),e.enabled&&e.keyCb[t.keyCode]&&e.keyCb[t.keyCode].up.forEach(function(e){e(String.fromCharCode(t.keyCode),t)}))})},getAllKeysStatus:function(){for(var e=Object.keys(this.KEYS),t={},i=0;i<e.length;++i)t[e[i]]=this.getKeyStatus(e[i]);return t},getKeyStatus:function(e,t){var i=void 0;try{return(i=this.keyPressed[e]||this.padPressed[e])&&!0===t&&(this.keyPressed[e]=!1,this.latches[e]=!0),i}catch(e){throw e}},isKeyDown:function(e,t){var i="string"==typeof e&&this.KEYS[e]||e;return this.getKeyStatus(i,t)},installKeyCallback:function(e,t,i){var n=this;e.split(" ").forEach(function(e){var s=n.KEYS[e];n.keyCb[s]||(n.keyCb[s]={up:[],down:[]}),n.keyCb[s][t].push(i)})},removeKeyCallback:function(e,t,i){var n=this.keyCb[e][t].indexOf(i);n>-1&&this.keyCb[e][t].splice(n,1)},clearEvents:function(){this.keyPressed={},this.keyCb={}}},V=0;V<10;++V)q.KEYS[V.toString()]=V+48;[].concat(function(e){if(Array.isArray(e)){for(var t=0,i=Array(e.length);t<e.length;t++)i[t]=e[t];return i}return Array.from(e)}("ABCDEFGHIJKLMNOPQRSTUVWXYZ")).forEach(function(e,t){q.KEYS[e]=65+t});var U=q,K=i(1),z=i.n(K),J=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),Q=function(){function e(){var t=this,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),console.log("[Game] Init()"),this.debug=i.debug,this.name=i.name;var n=i.target&&new y(i.target);this.showFps=void 0!==i.showFps&&i.showFps,this.showFps&&z()({width:50,height:50}),this.width=i.width||1024,this.height=i.height||768,this.target=n&&n.length&&n[0]||y("div").css({width:this.width+"px",height:this.height+"px"}).appendTo("body")[0],y(this.target).addClass("athena-game"),this.resources=i.resources,this.display=null,this.scene=null,this.running=!1,this._initEvents(),this.createDisplay({name:"main",width:i.width,height:i.height,layers:i.layers||[!1,!0]},this.target),this.toggleSound(void 0===i.sound||i.sound),this.sound||(console.warn("sound disabled: skipping audio resources"),b.skipResources.push("audio")),this.timeout=null,this.animFrame=null,this.bindEvents("*"),i.scene&&this.setScene(i.scene),this.debug&&(document.addEventListener("keyup",function(e){68===e.keyCode?t.scene&&(t.scene.debug(),t.scene.map&&t.toggleTileInspector(t.scene.isDebug)):70===e.keyCode?t.toggleFullscreen():80===e.keyCode&&t.togglePause()}),navigator.userAgent.match(/Xbox/)&&this.target.addEventListener("click",function(){console.log("[Game] Toggling fullscreen."),t.toggleFullscreen()}))}return J(e,[{key:"addInspector",value:function(){var e=this;this.moveHandler=function(t){var i=e.scene.map,n=t.offsetX>0?t.offsetX:0,s=t.offsetY>0?t.offsetY:0,r=e.scene.mapOffsetX,o=e.scene.mapOffsetY,a=i.viewportW,h=i.viewportH;if(t.offsetX<r||t.offsetX>r+a||t.offsetY<o||t.offsetY>o+h)e.tileInspector.hide(),e.tileHover.hide();else{var u=i.getTileIndexFromPixel(n-r-i.viewportX,s-o-i.viewportY);u?(e.tileInspector.html(u.x+", "+u.y+"<br />["+i.map[u.x+u.y*i.numCols]+", "+i.tileBehaviors[u.x+u.y*i.numCols]+"]").css({left:0,top:0}),e.tileInspector.show(),e.tileHover.css({left:u.x*i.tileWidth+r+i.viewportX+"px",top:u.y*i.tileHeight+o+i.viewportY+"px"}).show()):(e.tileInspector.hide(),e.tileHover.hide())}},this.tileInspector=new y("div").css({border:"1px dotted white","background-color":"rgba(0,0,0,.7)",color:"white","z-index":10,position:"absolute","pointer-events":"none"}).appendTo(this.target),this.tileHover=new y("div").css({border:"1px dotted white",width:this.scene.map.tileWidth+"px",height:this.scene.map.tileHeight+"px","background-color":"rgba(255,0,0,.4)",position:"absolute","z-index":10,top:0,left:0,"pointer-events":"none"}).appendTo(this.target),y(this.target).css("position","relative")}},{key:"toggleTileInspector",value:function(e){e?(this.tileInspector||this.addInspector(),this.tileInspector.show(),this.target.addEventListener("mousemove",this.moveHandler,!1)):this.tileInspector&&(this.target.removeEventListener("mousemove",this.moveHandler),this.tileInspector.hide(),this.tileHover.hide())}},{key:"bindEvents",value:function(e){X.listen(e,this.onEvent.bind(this))}},{key:"onEvent",value:function(e){}},{key:"toggleSound",value:function(e){this.sound=e,u.toggleSound(e)}},{key:"toggleFullscreen",value:function(){this.display&&this.display.toggleFullscreen()}},{key:"createDisplay",value:function(e,t){this.display=G.addDisplay(e,t)}},{key:"_initEvents",value:function(){U.init(),this._addVisibilityEvents()}},{key:"_addVisibilityEvents",value:function(){var e=this,t="",i="";console.log("[Game] adding visibility events"),void 0!==document.hidden?(i="hidden",t="visibilitychange"):void 0!==document.msHidden?(i="msHidden",t="msvisibilitychange"):void 0!==document.webkitHidden&&(i="webkitHidden",t="webkitvisibilitychange"),t.length?document.addEventListener(t,function(){console.log("[Game] got visibility event "+document[i]),document[i]&&e.running&&e.togglePause()},!1):console.warn("[Game] Visibility API not available.")}},{key:"setScene",value:function(e){console.log("[Game] setScene: "+e.name),this.scene!==e&&(this.scene&&(this._stopSceneLoops(),this.scene._stop(),this.toggleTileInspector(!1)),e?this._setupScene(e):console.warn("[Game] Attempt to set non-existing scene:",e))}},{key:"_startScene",value:function(){var e=this.scene.hudScene;this.display.clearAllScreens(),this.scene._start(),this.scene.start(),e&&e.start(),this._runSceneLoop(),this._renderSceneLoop()}},{key:"_setupScene",value:function(e){var t=this;this.scene=e;var i=e.hudScene;window.currentScene=e,this.scene.setDisplay(this.display),this.display.clearDisplay(),this.scene._setup(),this.scene.setup(),i&&i.setup(),this.scene._load().then(function(e){t.scene===e?t._startScene():console.warn("[Game] scene",e,"has finished loading but is not the current scene anymore so it won't be started.")}).catch(function(e){console.error(e)})}},{key:"_renderSceneLoop",value:function(){var e=this.scene;this.running&&(U.playingEvents&&U.nextRecordedEvents(),this.animFrame=window.requestAnimationFrame(this._renderSceneLoop.bind(this)),this.display.renderScene(e),e.hudScene,U.recording&&U.recordEvents())}},{key:"_runSceneLoop",value:function(){var e=this.scene;this.running||(this.running=!0),e.update((new Date).getTime()),this.running&&(this.timeout=setTimeout(this._runSceneLoop.bind(this),16))}},{key:"togglePause",value:function(){this.running?(this.running=!1,this.scene.pause(this.running),this.display.renderScene(this.scene),this._stopSceneLoops()):(this.running=!0,this.scene.pause(this.running),this._runSceneLoop(),this._renderSceneLoop())}},{key:"_stopSceneLoops",value:function(){this.running=!1,console.log("[Game] Scene stopped, stopping run & render loops"),this.animFrame&&(window.cancelAnimationFrame(this.animFrame),this.animFrame=null),this.timeout&&(clearTimeout(this.timeout),this.timeout=null)}}]),e}(),Z=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),$=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.offsetX=t.offsetX||0,this.offsetY=t.offsetY||0,this.width=t.width||16,this.height=t.height||16,this.inertia=t.inertia||1,this.upCollide=t.upCollide||!0,this.downCollide=t.downCollide||!0}return Z(e,null,[{key:"TYPE",get:function(){return{AIR:1,WALL:2,LADDER:3}}}]),e}(),ee=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),te=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.counter=t.size,this.type=t.afterDestroy,this.data=t.afterDestroyData}return ee(e,[{key:"remove",value:function(e){--this.counter||this.destroy(e)}},{key:"getSpriteOptions",value:function(e){var t=Object.assign({},this.data.spriteOptions);return"string"==typeof t.x&&(t.x=e.x+Number(t.x)),"string"==typeof t.y&&(t.y=e.y+Number(t.y)),t}},{key:"destroy",value:function(e){switch(this.type){case"reward":if(this.data){var t=this.getSpriteOptions(e,this.data),i=new(b.getResourceById(this.data.spriteId))(t);e.currentMap.addObject(i)}break;default:throw this.type}}}]),e}(),ie=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),ne=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),console.log("[MapEvent] constructor()"),this.map=t||null,this.reset()}return ie(e,[{key:"reset",value:function(){this.switches={},this.events=[],this.items={}}},{key:"addItem",value:function(e,t){this.items[e]=t}},{key:"getItem",value:function(e){return this.items[e]}},{key:"setSwitch",value:function(e,t){this.switches[e]=t}},{key:"toggleSwitch",value:function(e){this.setSwitch(e,void 0===this.switches[e]||!this.switches[e])}},{key:"getSwitch",value:function(e){return this.switches[e]||!1}},{key:"checkConditions",value:function(e){var t,i,n=e.conditions,s=null,r=!0;if(n){for(t=0,i=n.length;t<i;t++){switch((s=n[t]).type){case"time":break;case"switch":r=this.getSwitch(s.id)===s.status}if(!r)break}return r}return!0}},{key:"handleAction",value:function(e){var t;switch(e.type){case"toggleSwitch":(t=e.sprite).toggleSwitch(),this.toggleSwitch(t.id);break;default:console.log("[MapEvent] non-handled action type",e.type)}}},{key:"handleEvent",value:function(e){var t=e.type;if(!this.checkConditions(e))return!0;switch(t){case"cp":this.map.setStartXYFromMaster();break;case"message":this.map.notify("game:message",{message:e.message});break;case"wave":return this.handleWave(Object.assign({},e));case"explosion":this.scheduleSprite(e.spriteId,e.spriteOptions,0),this.getItem(e.targetId).destroy();break;default:console.log("non-handled Event",e.type)}}},{key:"scheduleSprite",value:function(e,t,i){var n=this,s=b.newResourceFromPool(e,t);return i?setTimeout(function(){n.map.addObject(s)},i):this.map.addObject(s),s}},{key:"handleWave",value:function(e){var t=e.size,i=new te(e),n=0,s=0;for(e.spriteOptions.wave=i,n=0;n<t;n++)this.scheduleSprite(e.spriteId,e.spriteOptions,s),s+=e.delay||0;return!1}},{key:"endWave",value:function(){}},{key:"triggerEvent",value:function(e){this.events.push(e)}},{key:"isEventTriggered",value:function(e){return this.events.indexOf(e)>-1}}]),e}(),se=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}();window.maps={};var re=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.options=t,this.src=t.src,this.tileWidth=t.tileWidth||64,this.tileHeight=t.tileHeight||32,this.width=t.width||1024,this.height=t.height||1024,this.addTileSet(t.tiles),this.viewportX=t.viewportX||0,this.viewportY=t.viewportY||0,this.viewportW=t.viewportW||this.width,this.viewportH=t.viewportH||this.height,this.triggers=t.triggers||{},this.windows=t.windows||{},this.maxWinX=this.width/this.viewportW|0,this.xMax=this.width-this.viewportW,this.yMax=this.height-this.viewportH,this.viewportTargetX=this.viewportTargetY=this.viewportSpeedX=this.viewsportSpeedY=this.viewportStartX=this.viewportStartY=0,this.viewportLimitX=230,this.viewportCenterX=307,this.viewportLimitY=154,this.viewportCenterY=230,this.tileOffsetX=0,this.tileOffsetY=0,this.scrollTileWidth=0,this.scrollTileHeight=0,this.viewportLimits={x1:this.viewportLimitX,x2:this.viewportW-this.viewportLimitX,y1:this.viewportLimitY,y2:this.viewportH-this.viewportLimitY},this.objects=[],this.friendBullets=[],this.enemies=[],this.platforms=[],this.name=t.name||"map"+(new Date).getTime(),this._calcNumTiles(!1),this.setBuffer(t.buffer),this.dataUrl=t.dataUrl,this.firstRow=this.lastRow=this.firstCol=this.lastCol=0,this.isDebug=!1,this.srcBitmap=null,this.moving=!1,this.setEasing(t.easing),this.startMoveTime=null,this.duration=800,this.masterObject=null,this.currentWindow=null,this.startX=t.startX||0,this.startY=t.startY||0,window.maps[this.name]=this,this.mapEvent=new ne(this),this.scene=null,this.isDirty=!0}return se(e,[{key:"setStartXYFromMaster",value:function(){this.startX=this.masterObject.x,this.startY=this.masterObject.y}},{key:"setEasing",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"linear";this.easing=I.getEasing(e)}},{key:"respawn",value:function(){console.log("avant",this.masterObject.running,this.masterObject.currentAnimName),this.masterObject.reset(),console.log("apres",this.masterObject.running,this.masterObject.currentAnimName),console.log("resuming",this.startX,this.startY),this.masterObject.x=this.startX,this.masterObject.y=this.startY,this.isDirty=!0}},{key:"reset",value:function(){for(var e in this.masterObject=null,this.objects.length=0,this.friendBullets.length=0,this.enemies.length=0,this.platforms.length=0,this.windows)this.windows[e].displayed=!1;for(var t in this.triggers)this.triggers[t].triggered=!1;this.mapEvent.reset(),this.viewportX=this.options.viewportX||0,this.viewportY=this.options.viewportY||0,this.viewportW=this.options.viewportW||0,this.viewportH=this.options.viewportH||0,this.tileOffsetX=0,this.tileOffsetY=0,this.scrollTileWidth=0,this.scrollTileHeight=0,this.firstCol=-this.viewportX/this.tileWidth,this.firstRow=-this.viewportY/this.tileHeight,this.lastCol=this.firstCol+this.numViewportCols,this.lastRow=this.firstRow+this.numViewportRows,this.startX=this.options.startX||0,this.startY=this.options.startY||0,this.isDirty=!0}},{key:"setScene",value:function(e){this.scene=e}},{key:"setBuffer",value:function(e){var t=this.numCols*this.numRows;this.map=new Uint8Array(e,0,t),this.tileBehaviors=new Uint8Array(e,t),this.buffer=e}},{key:"setData",value:function(e,t){var i=this.numCols*this.numRows,n=new Uint8Array(2*i);n.set(new Uint8Array(e),0),n.set(new Uint8Array(t),i),this.buffer=n.buffer,this.map=new Uint8Array(this.buffer,0,i),this.tileBehaviors=new Uint8Array(this.buffer,i,i)}},{key:"setMasterObject",value:function(e){this.masterObject=e,e.x=this.startX,e.y=this.startY}},{key:"addObject",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;!e.image&&e.imageId&&e.setImage(b.getResourceById(e.imageId)),e.setMap(this),e.setScene(this.scene),e.layer=t,this.objects.push(e),!0===e.master&&this.setMasterObject(e),1===e.collideGroup?this.enemies.push(e):2===e.collideGroup?this.friendBullets.push(e):3===e.collideGroup&&(console.log("[Map] adding platform "+e.id),this.platforms.push(e))}},{key:"setTilesSize",value:function(e,t){this.tileWidth=e,this.tileHeight=t}},{key:"setViewPort",value:function(e,t,i,n){this.viewportX=e,this.viewportY=t,this.viewportW=i,this.viewportH=n}},{key:"debug",value:function(e){this.isDebug=e,this.isDirty=!0}},{key:"moveObjects",value:function(e){this.objects.forEach(function(t){3!==t.collideGroup&&t.movable&&t.update(e)})}},{key:"movePlatforms",value:function(e){this.platforms.forEach(function(t){t.movable&&t.update(e)})}},{key:"update",value:function(e){var t=0,i=0,n=0;!0===this.moving?(i=(t=e-this.startMoveTime)/this.duration,t>=this.duration?(this.moving=!1,this.viewportX=this.viewportTargetX,this.viewportY=this.viewportTargetY):(n=this.easing(i,t,0,1,this.duration),this.viewportX=this.viewportStartX+n*this.viewportSpeedX|0,this.viewportY=this.viewportStartY+n*this.viewportSpeedY|0),this.isDirty=!0):this.masterObject&&(this.checkMasterPosition(),this.checkForTriggers()),this.movePlatforms(e),this.moveObjects(e)}},{key:"checkMasterPosition",value:function(){var e=null,t=null;this.masterObject&&!this.moving&&(this.viewportX&&this.masterObject.x+this.viewportX<=this.viewportLimitX?e=this.viewportX+this.viewportCenterX:-this.viewportX+this.viewportW-this.masterObject.x<=this.viewportLimitX&&(e=this.viewportX-this.viewportCenterX),this.viewportY&&this.masterObject.y+this.viewportY<=this.viewportLimitY?t=this.viewportY+this.viewportCenterY:-this.viewportY+this.viewportH-this.masterObject.y<=this.viewportLimitY&&(t=this.viewportY-this.viewportCenterY),null===e&&null===t||this.moveTo(null!==e?e:this.viewportX,null!==t?t:this.viewportY),null===e&&null===t||this.moveTo(null!==e?e:this.viewportX,null!==t?t:this.viewportY))}},{key:"checkCollisions",value:function(){this.masterObject&&this.masterObject.canCollide&&this.checkMasterToEnemiesCollisions(),this.checkMasterBulletsToEnemiesCollisions()}},{key:"checkForTriggers",value:function(){var e=this,t=this.masterObject.getHitBox();this.getTriggersForBox(this.masterObject.x+t.x,this.masterObject.y+t.y,this.masterObject.x+t.x2,this.masterObject.y+t.y2).forEach(function(t){t.triggered=!e.mapEvent.handleEvent(t)})}},{key:"moveTo",value:function(e,t){var i=e<-this.xMax?-this.xMax:e,n=t<-this.yMax?-this.yMax:t;this.moving||this.viewportX===i&&this.viewportY===n||(this.masterObject&&this.masterObject.savePosition(),this.viewportTargetX=i>0?0:i,this.viewportTargetY=n>0?0:n,this.startMoveTime=(new Date).getTime(),this.viewportSpeedX=i-this.viewportX|0,this.viewportSpeedY=n-this.viewportY|0,this.viewportStartX=this.viewportX,this.viewportStartY=this.viewportY,this.moving=!0)}},{key:"setNewSrc",value:function(e){this.src=e.src}},{key:"getSrc",value:function(){return this.src}},{key:"fallTest",value:function(e,t){var i=this.getTileIndexFromPixel(e,t);return this.tileBehaviors[i.x+i.y*this.numCols]===$.TYPE.WALL}},{key:"checkMasterBulletsToEnemiesCollisions",value:function(){var e=0,t=0,i=this.friendBullets.length,n=this.enemies.length;for(e=0;e<i;++e)for(t=0;t<n;++t)this.enemies[t]&&this.enemies[t].canCollideFriendBullet&&this.friendBullets[e]&&this.friendBullets[e].hitTest(this.enemies[t])}},{key:"checkMasterToEnemiesCollisions",value:function(){for(var e=0,t=this.enemies.length,i=!1;e<t&&!i;)i=this.enemies[e].hitTest(this.masterObject),e++;return i}},{key:"checkForPlatform",value:function(e,t,i){var n=e.getHitBox();return n.x,sprite.x,n.y,sprite.y,this.platforms.forEach(function(e){var t=e.getHitBox();e.x,t.x,e.y,t.y}),!1}},{key:"getTriggersForBox",value:function(e,t,i,n){var s=this.getTileIndexFromPixel(e,t),r=this.getTileIndexFromPixel(i,t),o=this.getTileIndexFromPixel(e,n),a=r.x,h=o.y,u=void 0,l=void 0,c=[],f=null;for(u=s.x;u<=a;u++)for(l=s.y;l<=h;l++)(f=this.triggers[l*this.numCols+u])&&!f.triggered&&c.push(f);return c}},{key:"checkMatrixForCollision",value:function(e,t,i,n,s){var r=t/this.tileWidth,o=e.length/r,a=0,h=0,u=!1;for(a=0;a<o;++a)for(h=0;h<r;++h)u=u||e[a*r+h]&&this.getTileBehaviorAtIndex(i+h,n+a)===s;return u}},{key:"getMaxDistanceToTile",value:function(e,t,i){for(var n=!1,s=e.getHitBox2(),r=t<0,o=r?-this.tileWidth:this.tileWidth,a=r?-1:1,h=this.getTileIndexFromPixel(r?s.x+a:s.x2+a,s.y),u=h.y,l=u+Math.floor((s.y2-s.y)/this.tileHeight),c=0;!n&&Math.abs(a)<Math.abs(t);){for(c=u;c<=l;++c)n=n||this.getTileBehaviorAtIndex(h.x,c)===i;n||(a+=o,h=this.getTileIndexFromPixel(r?s.x+a:s.x2+a,s.y))}return n?Math.abs(a)>1?a-o:0:t}},{key:"setNextX",value:function(e,t){for(var i=!(e.vx>0),n=e.getHitBox(),s=e.y+n.y2,r=i?e.x+n.x-1:e.x+n.x2+1,o=e.y+n.y,a=this.getTileIndexFromPixel(r,o),h=!1,u=i?r:0;!h&&(i&&u>=e.vx||!i&&u<=e.vx);){for(var l=a.y*this.tileHeight;l<s;l+=this.tileHeight,a.y++)if(this.tileBehaviors[a.y*this.numCols+a.x]===t){h=!0;break}h||(u=i?a.x*this.tileWidth-r:++a.x*this.tileWidth-r),r=i?a.x*this.tileWidth-1:a.x*this.tileWidth,a=this.getTileIndexFromPixel(r,o)}return i&&e.vx>=u||!i&&e.vx<u?(e.x+=e.vx,!1):(console.log("**collision"),e.x+=u,!0)}},{key:"setNextYTop",value:function(e,t){var i=e.getHitBox,n=(e.x,i.x2,e.x+i.x),s=e.y+i.x2+1;this.getTileIndexFromPixel(n,s),e.y+=e.vy}},{key:"checkForTileType",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,s=arguments.length>4&&void 0!==arguments[4]&&arguments[4],r=e.getHitBox(),o=this.hitObjectTest(r.x+e.x+i,r.y+e.y+n,r.x2+e.x-i,r.y2+e.y-n,t);return!!o&&(s&&e.centerXOverTile(o),!0)}},{key:"hitObjectTest",value:function(e,t,i,n,s){var r=this.getTileIndexFromPixel(e,t),o=this.getTileIndexFromPixel(i,t),a=this.getTileIndexFromPixel(e,n),h=o.x,u=a.y,l=void 0,c=void 0;for(l=r.x;l<=h;l++)for(c=r.y;c<=u;c++)if(this.tileBehaviors[c*this.numCols+l]===s)return{x:l,y:c,tile:{x:l*this.tileWidth,y:c*this.tileHeight}};return!1}},{key:"drawTile",value:function(e,t,i,n,s,r){var o=this.tiles[e];t.drawImage(this.srcBitmap,o.offsetX+(s&&this.tileOffsetX)||0,o.offsetY+(r&&this.tileOffsetY)||0,s?this.scrollTileWidth:o.width,r?this.scrollTileHeight:o.height,i,n,s?this.scrollTileWidth:o.width,r?this.scrollTileHeight:o.height)}},{key:"_getTileOffset",value:function(){var e=Math.abs(this.viewportX),t=Math.abs(this.viewportY);this.tileOffsetX=e<this.tileWidth?e:e%this.tileWidth,this.tileOffsetY=t<this.tileHeight?t:t%this.tileHeight,this.scrollTileWidth=this.tileWidth-this.tileOffsetX,this.scrollTileHeight=this.tileHeight-this.tileOffsetY}},{key:"draw",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,s=void 0,r=void 0,o=void 0,a=void 0,h=0,u=0,l=0;if(this.tiles.length){if(!this.srcBitmap&&(this.srcBitmap=b.getResourceById(this.src),!this.srcBitmap))throw"no source bitmap found when drawing map";if(s=r=o=a=0,!this.isDirty&&this.lastCol||this._getBoundariesTiles(t),this.isDirty||!this.lastCol){for(this._getTileOffset(),s=this.firstRow,o=this.lastRow,l=n;s<o;s++){for(r=this.firstCol,a=this.lastCol,u=i;r<a;r++)(h=this.map[s*this.numCols+r])<255&&this.drawTile(h,e,u,l,!(!this.viewportX||r!==this.firstCol),!(!this.viewportY||s!==this.firstRow)),this.viewportX&&r===this.firstCol?u+=this.scrollTileWidth:u+=this.tileWidth;this.viewportY&&s===this.firstRow?l+=this.scrollTileHeight:l+=this.tileHeight}!0===this.isDebug&&this.showTileBehaviors(e,t,i,n),this.checkVisibleWindows(),this.isDirty=!1}}else this.isDirty=!1}},{key:"addNewObjectsFromWindow",value:function(e){var t=this,i=this.windows[e];i&&!1===i.displayed&&(i.displayed=!0,i.items.forEach(function(e){var i=b.newResourceFromPool(e.type,e.spriteOptions);t.addObject(i),e.itemId&&t.mapEvent.addItem(e.itemId,i)}))}},{key:"checkVisibleWindows",value:function(){for(var e=Math.abs(this.viewportY)/this.viewportH*this.maxWinX|0,t=this.viewportY%this.viewportH?e+this.maxWinX:e,i=this.viewportX%this.viewportW,n=e;n<=t;n+=this.maxWinX)this.addNewObjectsFromWindow(n),i&&this.addNewObjectsFromWindow(n+1)}},{key:"drawObjects",value:function(e){var t=this,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,s=void 0,r=void 0,o=this.objects.length,a=this.objects,h=null,u=null;for(s=o-1;s>=0;s--)!function(){var o=(h=a[s]).layer;if((i||n)&&(h.x+=i,h.y+=n,h.children.length))for(r=0;r<h.children.length;++r)(u=h.children[r]).x+=i,u.y+=n;if(h._draw(e[o]),t.isDebug&&h.showHitBox(e[o]),h.children.length&&h.children.forEach(function(i){i._draw(e[o]),t.isDebug&&i.showHitBox(e[o])}),(i||n)&&(h.x-=i,h.y-=n,h.children.length))for(r=0;r<h.children.length;++r)(u=h.children[r]).x-=i,u.y-=n}()}},{key:"getTileAt",value:function(e,t){var i,n,s;return i=e/this.tileWidth|0,n=t/this.tileHeight|0,s=this.map[this.numCols*n+i],this.tiles[s]}},{key:"getTileBehaviorAtIndex",value:function(e,t){return this.tileBehaviors[this.numCols*t+e]}},{key:"getTileIndexFromPixel",value:function(e,t){return{x:e/this.tileWidth|0,y:t/this.tileHeight|0}}},{key:"getTilePixelPos",value:function(e,t){return{y:t*this.tileHeight,x:e*this.tileWidth}}},{key:"_calcNumTiles",value:function(){this.numCols=this.width/this.tileWidth|0,this.numRows=this.height/this.tileHeight|0,this.numViewportCols=Math.ceil(this.viewportW/this.tileWidth),this.numViewportRows=Math.ceil(this.viewportH/this.tileHeight)}},{key:"_getBoundariesTiles",value:function(){arguments.length>0&&void 0!==arguments[0]&&arguments[0]?(this.firstCol=0,this.firstRow=0,this.lastCol=this.width/this.tileWidth|0,this.lastRow=this.height/this.tileHeight|0):(this.firstCol=Math.floor(-this.viewportX/this.tileWidth),this.firstRow=Math.floor(-this.viewportY/this.tileHeight),this.lastCol=this.firstCol+this.numViewportCols,this.lastRow=this.firstRow+this.numViewportRows,this.viewportX%this.tileWidth&&this.lastCol++,this.viewportY%this.tileHeight&&this.lastRow++)}},{key:"notify",value:function(e,t){X.notify(e,t)}},{key:"removeObject",value:function(e){var t=this.objects.indexOf(e);t>-1&&this.objects.splice(t,1),(t=this.enemies.indexOf(e))>-1?this.enemies.splice(t,1):(t=this.friendBullets.indexOf(e))>-1&&this.friendBullets.splice(t,1)}},{key:"showTileBehaviors",value:function(e,t){var i,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,r=void 0,o=void 0,a=void 0,h=0,u=0,l=[null,null,"rgba(240,0,0,.6)","rgba(0,0,240,.6)"],c=void 0,f=void 0;for(r=o=a=0,r=this.firstRow,i=this.lastRow,u=s;r<i;r++){for(o=this.firstCol,a=this.lastCol,h=n;o<a;o++)c=this.viewportX&&o===this.firstCol?this.scrollTileWidth:this.tileWidth,f=this.viewportY&&r===this.firstRow?this.scrollTileHeight:this.tileHeight,this.tileBehaviors[r*this.numCols+o]>1&&(e.fillStyle=l[this.tileBehaviors[r*this.numCols+o]],e.beginPath(),e.moveTo(h,u),e.lineTo(h+c,u),e.lineTo(h+c,u+f),e.lineTo(h,u+f),e.lineTo(h,u),e.closePath(),e.fill()),this.viewportX&&o===this.firstCol?h+=this.scrollTileWidth:h+=this.tileWidth;this.viewportY&&r===this.firstRow?u+=this.scrollTileHeight:u+=this.tileHeight}}},{key:"getObjectsList",value:function(){this.objects.forEach(function(e,t){console.log("["+t+"]",e.type,"("+e.id+")")})}},{key:"toString",value:function(){var e=0,t=this.tiles.length,i={src:this.src,viewportX:0,viewportY:0,viewportW:this.viewportW,viewportH:this.viewportH,width:this.width,height:this.height,tileWidth:this.tileWidth,tileHeight:this.tileHeight,map:this.map,objects:this.objects,tiles:[]};for(e=0;e<t;e++)i.tiles.push("new Tile({offsetX: tile.offsetX,offsetY: tile.offsetY,width: tile.width,height: tile.height,inertia: tile.inertia,upCollide: tile.upCollide,downCollide: tile.downCollide}),");return JSON.stringify(i)}},{key:"_createTiles",value:function(e){var t=[];return e.forEach(function(e){t.push(new $(e))}),t}},{key:"addTileSet",value:function(e){e&&e.length?this.tiles=this._createTiles(e):this.tiles=[],this.isDirty=!0}},{key:"clear",value:function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:$.TYPE.AIR,i=0;i<this.numCols;++i)for(var n=0;n<this.numRows;++n)this.map[n*this.numCols+i]=e,this.tileBehaviors[n*this.numCols+i]=t}},{key:"updateTile",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:-1,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:-1,s=t*this.numCols+e;i>-1&&(this.map[s]=i,this.isDirty=!0),n>-1&&(this.isDirty=!0,this.tileBehaviors[s]=n)}},{key:"shift",value:function(e,t,i){var n=new Uint8Array(this.buffer,0,e*this.numCols),s=new Uint8Array(this.buffer,this.numCols*this.numRows,e*this.numCols),r=t*this.numCols;this.map.set(n,r),this.tileBehaviors.set(s,r),this.isDirty=!0}},{key:"resize",value:function(e,t){var i=null,n={},s={},r=new Array(this.numCols*this.numRows),o=null,a=null,h=null;if("bottomleft"!==e)throw"resize not supported for direction"+e;t.newWidth,this.width;var u=t.newHeight-this.height,l=t.newWidth/this.tileWidth|0,c=t.newHeight/this.tileHeight|0,f=(this.numCols,c-this.numRows),d=this.width/this.viewportW|0,p=this.height/this.viewportH|0,v=(t.newWidth,this.viewportW,t.newHeight/this.viewportH|0),y=v-p;i=new ArrayBuffer(l*c*2),o=new Uint8Array(i,0,c*l),r=new Uint8Array(i,c*l,c*l);for(var m=f;m<c;m++)for(var g=0;g<this.numCols;g++)o[m*l+g]=this.map[m*l+g],r[m*l+g]=this.tileBehaviors[m*l+g],this.triggers[m*l+g]&&((a=Object.assign({},!0,this.triggers[m*l+g])).spriteOptions&&(a.spriteOptions.y+=u),n[m*l+g]=a);this.setBuffer(i),this.width=t.newWidth,this.height=t.newHeight,this.triggers=n,this._calcNumTiles();for(var b=y;b<v;++b)for(var w=0;w<d;++w)if(this.windows[b*d+w]){h=this.windows[b*d+w].items;for(var k=0;k<h.length;++k)(a=Object.assign({},h[k])).spriteOptions&&(a.spriteOptions.y+=u);s[b*d+w]={displayed:!1,items:h.slice(0)}}this.windows=s}}]),e}(),oe=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}();window.scenes={};var ae=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),t=t||{},this.layers=new Array(t.layers||2),this.readyDef=null,this.resources=t.resources||[],this.pics={},this.map=null,this.mapOffsetX=0,this.mapOffsetY=0,this.loaded=!1,this.running=!1,this.backgroundImage=null,this.name=t.name||"Scene"+e.count++,this.opacity=void 0!==t.opacity?t.opacity:1,this.hudScene=t.hudScene||null,this.time=null,this.playTime=null,window.scenes[this.name]=this,this._objectsToAdd=[],this.isDebug=!1}return oe(e,[{key:"_prepareCanvas",value:function(){this.resources&&this.display.prepareCanvas(this.resources)}},{key:"_emptyLayers",value:function(){for(var e=0;e<this.layers.length;++e)this.layers[e]=[]}},{key:"_getResourcesRef",value:function(){var e=this.resources;e&&e.forEach(function(e){e.elt=b.getResourceById(e.id)})}},{key:"fadeIn",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1e3;return this.animate("Fade",{startValue:0,endValue:1,duration:e})}},{key:"fadeOut",value:function(e){return this.animate("Fade",{startValue:1,endValue:0,duration:e})}},{key:"fadeInAndOut",value:function(e,t,i){var n=this,s=new p;return this.fadeIn(e).then(function(){setTimeout(function(){n.fadeOut(i).then(function(){s.resolve()})},t)}),s.promise}},{key:"_loadResources",value:function(e,t){var i=this;return this.loaded?(console.log("[Scene "+this.name+"] _loadResources() - Scene is loaded."),this._onLoad()):(console.log("[Scene "+this.name+"] _loadResources() - Loading scene."),this.readyDef=b.addResources(e),this.readyDef.then(function(){i.loaded=!0,i._onLoad()}).catch(function(e){console.error(e)}),b.loadResources("any",t)),this.readyDef}},{key:"load",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;this.loaded?console.log("Scene already loaded"):this.resources.push({type:e,src:t,id:i||t})}},{key:"loadImage",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;this.load("image",e,t||e)}},{key:"loadAudio",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;this.load("audio",e,t||e)}},{key:"loadMap",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;this.load("map",e,t||e)}},{key:"_load",value:function(){var e=this,t=new p;return this.hudScene&&!this.hudScene.loaded?this.hudScene._load().then(function(){e._loadResources(e.resources).then(function(){t.resolve(e)})}).catch(function(e){console.error(e)}):this._loadResources(this.resources).then(function(){return t.resolve(e)}),t.promise}},{key:"debug",value:function(e){var t=void 0!==e?e:!this.isDebug;this.isDebug=t,this.hudScene&&this.hudScene.debug(t),this.map&&this.map.debug(t)}},{key:"_onLoad",value:function(){var e=this;this._cacheImages(),this._getResourcesRef(),this._prepareCanvas(),this._objectsToAdd.forEach(function(t){return e.addObject.apply(e,function(e){if(Array.isArray(e)){for(var t=0,i=Array(e.length);t<e.length;t++)i[t]=e[t];return i}return Array.from(e)}(t))})}},{key:"_cacheImages",value:function(){if(console.log("[Scene "+this.name+"] caching Images"),this.resources)try{for(var e=0,t=this.resources.length;e<t;e++){var i=this.resources[e].id,n=this.resources[e].src;"image"===this.resources[e].type&&(this.pics[i]=b.getResourceById(i),this.pics[n]=b.getResourceById(i))}}catch(e){throw e}}},{key:"setMap",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;this.map=e instanceof re?e:new re(e),this.map.setScene(this),this.mapOffsetX=t,this.mapOffsetY=i,window.currentMap=this.map}},{key:"_setObjectImage",value:function(e){"function"!=typeof e.setImage||e.image||e.setImage(this.pics[e.imageId||e.imageSrc])}},{key:"_addObjectToLayer",value:function(e,t){this.layers[e].push(t),this._setObjectImage(t),t.setScene(this),t.layer=e}},{key:"addObject",value:function(e,t){if(this.loaded){var i=t||0;if(Array.isArray(e)){var n=!0,s=!1,r=void 0;try{for(var o,a=e[Symbol.iterator]();!(n=(o=a.next()).done);n=!0){var h=o.value;this._addObjectToLayer(i,h)}}catch(e){s=!0,r=e}finally{try{!n&&a.return&&a.return()}finally{if(s)throw r}}}else this._addObjectToLayer(i,e)}else this._objectsToAdd.push(Array.from(arguments))}},{key:"drawMap",value:function(e){this.map.isDirty&&(this.display.clearScreen(e),this.map.draw(e,!1,this.mapOffsetX,this.mapOffsetY))}},{key:"drawMapObjects",value:function(e){this.map.drawObjects(e,this.mapOffsetX,this.mapOffsetY)}},{key:"drawSceneObjects",value:function(e){for(var t=this,i=0,n=this.layers.length;i<n;i++)!function(i,n){for(var s=t.layers[i],r=e[i],o=0,a=s.length;o<a;o++){var h=s[o];h._draw(r),t.isDebug&&t.isDebug&&h.showHitBox(r),h.children.length&&h.children.forEach(function(e){e._draw(r),t.isDebug&&e.showHitBox(r)})}}(i)}},{key:"moveSceneObjects",value:function(e){for(var t=0,i=this.layers.length;t<i;t++)for(var n=this.layers[t],s=0,r=n.length;s<r;s++){var o=n[s];o.movable&&o.update(e)}}},{key:"setOpacity",value:function(e){this.opacity=e}},{key:"getOpacity",value:function(){return this.opacity}},{key:"setBackgroundImage",value:function(e){this.backgroundImage=e,e instanceof Image?new y(this.display.target).css("backgroundImage","url("+e.src+")"):new y(this.display.target).css("backgroundImage","url("+e+")")}},{key:"setup",value:function(){this.hudScene&&this.hudScene.setup()}},{key:"_setup",value:function(){this._emptyLayers(),this.map&&this.map.reset(),U.clearEvents(),this.hudScene&&this.hudScene._setup()}},{key:"_start",value:function(){this.running=!0,this.time=(new Date).getTime(),this.playTime=null,this.hudScene&&this.hudScene._start()}},{key:"_stop",value:function(){this._reset(),this.stop()}},{key:"_reset",value:function(){this.debug(!1),this._objectsToAdd=[]}},{key:"start",value:function(){}},{key:"stop",value:function(){this.running=!1,this.hudScene&&this.hudScene.stop()}},{key:"pause",value:function(e){}},{key:"getPlayTime",value:function(){return(this.playTime?this.playTime:(new Date).getTime()-this.time)/1e3}},{key:"update",value:function(e){this.moveSceneObjects(e),this.map&&(this.map.update(e),this.map.checkCollisions(e))}},{key:"render",value:function(e){var t=e.length-1;this.map&&(this.drawMap(e[t]),this.drawMapObjects(e)),this.drawSceneObjects(e)}},{key:"setLayerPriority",value:function(e,t){this.display.setLayerZIndex(e,t?0:2)}},{key:"notify",value:function(e,t){X.notify(e,t)}},{key:"bindEvents",value:function(e){X.listen(e,this.onEvent.bind(this))}},{key:"onEvent",value:function(){}},{key:"setDisplay",value:function(e){this.display=e,this.hudScene&&this.hudScene.setDisplay(e)}},{key:"animate",value:function(e,t){return this.display.animate(e,t,this)}},{key:"removeObject",value:function(e){var t=this.layers[e.layer],i=t.indexOf(e);i>-1&&t.splice(i,1)}}]),e}();ae.count=1;var he=ae,ue=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),le=function(){function e(t,i){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.sprite=t,t.gravity=void 0!==i.gravity?i.gravity:0,t.vx=void 0!==i.vx?i.vx:0,t.vy=void 0!==i.vy?i.vy:0,this.checkWalls=i.checkWalls||!1,this.checkFall=i.checkFall||!1,this.onVXChange=i.onVXChange||null,this.onVYChange=i.onVYChange||null}return ue(e,[{key:"onUpdate",value:function(){}},{key:"getMapEvent",value:function(){return this.sprite.currentMap.mapEvent}}]),e}(),ce=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),fe=function(e){function t(e,i){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var n=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,i));return n.direction=i.direction||"right",n.direction.match("left")&&(n.sprite.vx=-n.sprite.vx),n.direction.match("top")&&(n.sprite.vy=-n.sprite.vy),n}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,le),ce(t,[{key:"onUpdate",value:function(){var e=this.sprite,t=e.currentMap,i=e.x+e.vx,n=e.y+e.vy,s=e.getHitBox(),r=e.vx>0?s.x2:s.x;t.hitObjectTest(i+r,n+s.y,i+r,n+s.y,$.TYPE.WALL)?(e.vx=-e.vx,this.onVXChange&&this.onVXChange(e.vx)):t.hitObjectTest(i+s.x,n+s.y2+2,i+s.x2,n+s.y2+2,$.TYPE.AIR)?(e.vx=-e.vx,this.onVXChange&&this.onVXChange(e.vx)):t.hitObjectTest(i+s.x,n+s.y2+2,i+s.x2,n+s.y2+2,$.TYPE.LADDER)&&(e.vx=-e.vx,this.onVXChange&&this.onVXChange(e.vx)),e.x+=e.vx,e.y+=e.vy}}]),t}(),de=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),pe=function(e){function t(e,i){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var n=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,i));return n.elasticity=void 0!==i.elasticity?i.elasticity:.8,n.onEnd=i.onEnd||null,n.onGround=i.onGround||null,n}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,le),de(t,[{key:"onUpdate",value:function(){var e=this.sprite,t=e.currentMap,i=e.x+e.vx,n=e.y+e.vy,s=e.getHitBox();t.hitObjectTest(i+s.x,n+s.y2,i+s.x2,n+s.y2,$.TYPE.WALL)?(this.onGround&&this.onGround(),this.resetY(),Math.abs(e.vy)<=e.gravity&&(e.movable=!1,this.onEnd&&this.onEnd())):(e.vy+=e.gravity,e.y+=e.vy)}},{key:"resetY",value:function(){this.sprite.vy=-this.sprite.vy*this.elasticity}}]),t}(),ve=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),ye=function(e){function t(e,i){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var n=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,i));return n.direction=i.direction||"right",n.currentMovement=i.startMovement||"",n.lookDirection=i.lookDirection||"left",n.climbVY=2,n.jumping=!1,n.firing=!1,n.fromLadder=!1,n.sideHit=!1,n}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,le),ve(t,[{key:"onUpdate",value:function(){if("falling"===this.currentMovement||this.currentMovement.match(/jump/)||this.firing)this.currentMovement.match(/jump/)?(U.isKeyDown("SPACE",!0)&&this.handleFire(),this.fromLadder||!0!==U.getKeyStatus(U.KEYS.UP)||this.goUpOrClimb(!0),this.jump()):this.currentMovement.match("fire")||this.currentMovement.match("climb")||this.fall();else if(U.isKeyDown("CTRL")?(console.log("[PlayerMove] jump:",this.lookDirection),this.startJump(this.lookDirection)):!0===U.getKeyStatus(U.KEYS.LEFT)?!0===U.getKeyStatus(U.KEYS.UP)?this.startJump("left"):this.walkLeft():!0===U.getKeyStatus(U.KEYS.RIGHT)?!0===U.getKeyStatus(U.KEYS.UP)?(this.startJump("right"),console.log("[PlayerMove] startJump right",this.fromLadder)):this.walkRight():!0===U.getKeyStatus(U.KEYS.UP)?this.goUpOrClimb(!1):!0===U.getKeyStatus(U.KEYS.DOWN)?this.goDownOrClimb():"climb"!==this.currentMovement?this.currentMovement.match("fire")||this.idle():this.stopClimbing(),U.isKeyDown("SPACE",!0))switch(this.currentMovement){case"faceWall":this.switchAbove&&this.getMapEvent().handleAction({type:"toggleSwitch",sprite:this.switchAbove});break;case"climb":if(!this.lookDirection)break;case"idle":case"walk_right":case"walk_left":this.handleFire();break;case"down":break;default:console.log("[PlayerMove] unhandle fire",this.currentMovement)}}},{key:"handleFire",value:function(){var e=this;console.log("[PlayerMove] fire direction",this.lookDirection),this.firing||this.sprite.onEvent("fire",{direction:this.lookDirection})&&(this.firing=!0,this.previousMovement=this.currentMovement,this.sprite.storeCurrentAnim(),this.sprite.setAnimation("fire"+this.lookDirection,function(){e.firing=!1,this.restorePreviousAnim()}))}},{key:"walk",value:function(e){var t,i,n,s=this.sprite,r=s.getHitBox();return this.currentMovement="walk_"+e,this.vy=0,s.currentAnimName="walk"+e.charAt(0).toUpperCase()+e.slice(1),n="step_"+e,this.lookDirection=e,this.vx="left"===e?-2:2,t=s.x+this.vx,i=s.y+this.vy,s.currentMap.hitObjectTest(t+r.x,i+r.y,t+r.x2,i+r.y2,$.TYPE.WALL)?this.idle():(s.startAnimation(),s.currentFrameNum===s.previousFrameNum||3!==s.currentFrameNum&&7!==s.currentFrameNum||u.play(n)),s.x+=this.vx,s.y+=this.vy,this.fallTest(),0}},{key:"walkLeft",value:function(){"climb"!==this.currentMovement?this.walk("left"):this.lookDirection="left"}},{key:"walkRight",value:function(){"climb"!==this.currentMovement?this.walk("right"):this.lookDirection="right"}},{key:"startJump",value:function(e){var t=this.sprite,i=this;this.jumping?(i.readyToJump=!0,this.jumping=!0,i.currentMovement="jump"+e,this.vx="left"===e?-2:2,this.vy=-4,this.gravity=.098,this.sprite.setAnimation("jump"+e)):(console.log("[PlayerMove] starting jump",t.y),this.readyToJump=!1,this.currentMovement="startjump",this.vx="left"===e?-2:2,this.vy=-4,this.gravity=.098,console.log("[PlayerMove] startJump",this.vy),t.setAnimation("goDown"+e,function(){console.log("[PlayerMove] end goDownLeft, ready to jump",this.vy,this.y),i.readyToJump=!0,i.currentMovement="jump"+e,i.jumping=!0,this.setAnimation("jump"+e)})),this.lookDirection=this.direction=e,this.sideHit=!1,u.play("jump")}},{key:"jump",value:function(){var e=this.sprite,t=e.x+Math.ceil(this.vx),i=e.y+Math.ceil(this.vy),n=e.getHitBox(),s=null,r=null,o=!1;if(this.readyToJump){if(this.currentMovement.match(/jump/)&&((s=e.currentMap.hitObjectTest(t+n.x,e.y+n.y,t+n.x2,e.y+n.y2,$.TYPE.WALL))&&(this.sideHit=!0,o=!0,"right"===this.direction?e.x=s.tile.x-n.x2-n.x-1:e.x=s.tile.x+e.currentMap.tileWidth),r=e.currentMap.hitObjectTest(e.x+n.x,i+n.y,e.x+n.x2,i+n.y2,$.TYPE.WALL)))return this.vy<0?(console.log("[PlayerMove] Top collision, reversing vy!"),void(this.sideHit?this.vy=-this.vy:this.fall())):(console.log("[PlayerMove] touch ground!",this.currentMovement),this.jumping=!1,this.fromLadder=!1,u.play("land"),this.currentMovement="idle",e.y=r.tile.y-e.getCurrentHeight(),void(this.vy=0));o||(e.x+=Math.ceil(this.vx)),e.y+=Math.ceil(this.vy),this.vy+=this.gravity}else console.log("[PlayerMove] not ready to jump",this.fromLadder)}},{key:"idle",value:function(){var e=this.sprite;this.vx=0,this.vy=0,e.stopAnimation()}},{key:"goDown",value:function(){var e=this.sprite;this.vx=0,this.vy=0,e.currentAnimName="goDown"+this.lookDirection,this.currentMovement=""}},{key:"faceWall",value:function(){var e=this.sprite;this.vx=0,this.vy=0,"faceWall"!==this.currentMovement&&(this.currentMovement="faceWall",e.advanceFrame("faceWall"),this.switchAbove=this.sprite.currentMap.getSwitchAboveMaster())}},{key:"climb",value:function(e){var t=this.sprite;this.fromLadder=!0,this.currentMovement="climb",this.vx=0,this.vy=e?-this.climbVY:this.climbVY,t.currentAnimName="climb",t.startAnimation(),t.x+=this.vx,t.y+=this.vy}},{key:"stopClimbing",value:function(){var e=this.sprite;this.vx=0,this.vy=0,e.stopAnimation()}},{key:"goUpOrClimb",value:function(e){var t=this.sprite,i=t.getHitBox(),n=e?0:24,s=!1;return!0!==U.getKeyStatus(U.KEYS.LEFT)&&!0!==U.getKeyStatus(U.KEYS.RIGHT)&&(!0===e?t.currentMap.hitObjectTest(i.x+t.x,i.y+t.y+40,i.x+t.x-n,i.y2+t.y-50,$.TYPE.LADDER)&&(s=t.currentMap.hitObjectTest(i.x2+t.x+n,i.y+t.y+40,i.x2+t.x-n,i.y2+t.y-50,$.TYPE.LADDER)):s=t.currentMap.hitObjectTest(i.x+t.x+n,i.y+t.y+40,i.x2+t.x-n,i.y2+t.y-50,$.TYPE.LADDER),!1!==s?("climb"!==this.currentMovement&&(t.centerXOverTile(s),this.lookDirection=""),this.climb(1),!0):e?void 0:(this.faceWall(),!1))}},{key:"goDownOrClimb",value:function(){var e=this.sprite,t=e.getHitBox(),i=e.currentMap.hitObjectTest(t.x+e.x+24,t.y2+e.y+this.climbVY,t.x2+e.x-24,t.y2+e.y+this.climbVY,$.TYPE.LADDER);i?("climb"!==this.currentMovement&&e.centerXOverTile(i),this.climb(0)):"climb"===this.currentMovement||"faceWall"===this.currentMovement?(i=e.currentMap.hitObjectTest(t.x+e.x+24,t.y2+e.y+this.climbVY,t.x2+e.x-24,t.y2+e.y+this.climbVY,$.TYPE.LADDER),this.faceWall()):this.goDown()}},{key:"fall",value:function(){var e=4,t=this.sprite;for(this.jumping=!1;e>0;e--)if(this.fallTest(e)){this.vy=e;break}e>0?(this.vx=0,t.y+=this.vy,t.advanceFrame("fall"+this.lookDirection)):this.fromLadder=!1}},{key:"fallTest",value:function(e){e=e||1;var t=this.sprite,i=t.getHitBox(),n=t.y+i.y2+e;return t.currentMap.fallTest(t.x+i.x,n)||t.currentMap.fallTest(t.x+i.x2,n)?("falling"==this.currentMovement&&(this.currentMovement=""),!1):(this.currentMovement="falling",!0)}}]),t}(),me=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),ge=function(e){function t(e,i){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var n=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,i));return n.startY=e.y,n.startX=e.x,n.maxX=i.minX||0,n.maxY=i.minY||0,n}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,le),me(t,[{key:"onUpdate",value:function(){var e=this.sprite,t=Math.abs(e.y-this.startY),i=Math.abs(e.x-this.startX);t>this.maxY&&(e.vy=-e.vy,this.onVYChange&&this.onVYChange()),i>this.maxX&&(e.vx=-e.vx,this.onVXChange&&this.onVXChange()),e.x+=e.vx,e.y+=e.vy}}]),t}(),be=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),we=function(e){function t(e,i){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var n=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,i));return n.startY=e.y,n.startX=e.x,n.currentNode=0,n.offset=2,n.nodes=i.nodes,n.reverse=i.reverse||!1,n.dirX=0,n.dirY=0,n.numNodes=n.nodes.length/2,n}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,le),be(t,[{key:"onUpdate",value:function(){var e=this.sprite,t=this.currentNode,i=this.nodes[t],n=this.nodes[t+1];if(this.offset>0?(e.x+=i,e.y+=n):(e.x-=i,e.y-=n),i&&(this.dirX&&r(this.dirX)!==r(i)&&this.onVXChange&&this.onVXChange(),this.dirX=i),n&&(this.dirY&&r(this.dirY)!==r(n)&&this.onVYChange&&this.onVYChange(),this.dirY=n),this.currentNode+=this.offset,this.currentNode>=this.nodes.length||this.currentNode<0){if(!this.reverse)return void(e.movable=!1);this.onVXChange&&(this.dirX=0,this.onVXChange()),this.onVYChange&&(this.dirY=0,this.onVYChange()),this.currentNode=this.currentNode<0?0:this.nodes.length-2,this.offset=-this.offset}}}]),t}(),ke=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),xe=function(e){function t(e,i){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var n=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,i));return n.direction=i.direction||"right",n.direction.match("left")&&(e.vx=-e.vx),n.direction.match("top")&&(e.vy=-e.vy),n}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,le),ke(t,[{key:"onUpdate",value:function(){var e=this.sprite,t=e.currentMap,i=e.x+e.vx,n=e.y+e.vy,s=e.getHitBox(),r=e.vx>0?s.x2:s.x;t.hitObjectTest(i+r,n+s.y,i+r,n+s.y2,$.TYPE.WALL)&&(e.vx=-e.vx,this.onVXChange&&this.onVXChange(e.vx)),e.x+=e.vx,e.y+=e.vy}}]),t}(),_e=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),Te={},Oe=new(function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return _e(e,[{key:"addBehavior",value:function(e,t){Te[e]=t}},{key:"getBehavior",value:function(e){return Te[e]}}]),e}());Oe.addBehavior("ground",fe),Oe.addBehavior("inout",ge),Oe.addBehavior("simplefall",pe),Oe.addBehavior("weapon",xe),Oe.addBehavior("player",ye),Oe.addBehavior("path",we);var Se=Oe,Ee=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),Ce=function(){function e(t,i){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.type=t,this.id=i.objectId||this.type+(new Date).getTime(),this.layer=i.layer||0,this.currentMap=null,this.currentScene=null,this._destroyed=!1,this.children=[],this.wave=i.wave||null,this.behavior=null,this.platform=null,this.mask=null,this.collideGroup=i.collideGroup||0,this.canCollideFriendBullet=i.canCollideFriendBullet||!1,this.master=i.master||!1,this.moving=!1,this.easing=I.getEasing(i.easing||"linear"),i.behavior&&this.setBehavior(i.behavior,i.behaviorOptions),this._settings=Object.assign({speed:1,visible:!0,canCollide:!1,plane:0,x:0,y:0,vx:0,vy:0,scale:1,angle:0,movable:!0,gravity:0,data:{},path:null,target:null,targetOffsetX:0,targetOffsetY:0,wave:i.wave||null},i),this.target=null,this.spline=null,this.currentMovement="",this.fxQueue={},i.pool||(this._reset(),this.reset(),i.animate&&this.animate(i.animate.name,i.animate.options)),i.scene?i.scene.addObject(this):i.map}return Ee(e,[{key:"reset",value:function(){}},{key:"_reset",value:function(){this.speed=this._settings.speed,this.visible=this._settings.visible,this.canCollide=this._settings.canCollide,this.plane=this._settings.plane,this.x=this._settings.x,this.y=this._settings.y,this.opacity=this._settings.opacity||1,this.scale=this._settings.scale,this.angle=this._settings.angle,this.movable=this._settings.movable,this.moving=!1,this.data=this._settings.data,this.path=null,this.vx=this._settings.vx||0,this.vy=this._settings.vy||0,this.gravity=this._settings.gravity,this.moveHandlers=[],this.targetOffsetX=this._settings.targetOffsetX||0,this.targetOffsetY=this._settings.targetOffsetY||0,this.target=this._settings.target||null,this.savedX=this.x,this.savedY=this.y,this.wave=this._settings.wave}},{key:"setMap",value:function(e){this.currentMap=e,this.children.forEach(function(t){t.setMap(e)})}},{key:"setScene",value:function(e){this.currentScene=e,this.children.forEach(function(t){t.setScene(e)})}},{key:"setPlatform",value:function(e){this.platform=e}},{key:"moveTo",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return this.moving||(0===i?(this.x=e,this.y=t,this._onUpdate()):(console.log("moveTo from",this.x,"to",e),this.targetX=e,this.targetY=t,this.duration=i,this.startMoveTime=(new Date).getTime(),this.targetDistanceX=e-this.x|0,this.targetDistanceY=t-this.y|0,this.targetStartX=this.x,this.targetStartY=this.y,this.moving=!0)),this}},{key:"snapToMap",value:function(e,t){if(this.currentMap){var i=this.currentMap,n=i.getTileIndexFromPixel(this.x,this.y);this.x%i.tileWidth&&!e&&n.x++,this.y%i.tileHeight&&!t&&n.y++,n=i.getTilePixelPos(n.x,n.y),this.moveTo(n.x,n.y)}}},{key:"setMask",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this.mask=e,t&&e&&(e.exclude=!0)}},{key:"setOpacity",value:function(e){this.opacity=e}},{key:"getOpacity",value:function(){return this.opacity}},{key:"cancelMoveTo",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this.moving&&(this.moving=!1,e&&(this.x=this.targetX,this.y=this.targetY))}},{key:"center",value:function(){var e=this.currentScene.display;return this.x=(e.width-this.width)/2,this.y=(e.height-this.height)/2,this}},{key:"setBehavior",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.behavior="string"==typeof e?new(Se.getBehavior(e))(this,t):new e(this,t)}},{key:"clearBehavior",value:function(){this.vx=this.vy=0,this.behavior=null}},{key:"_applyMask",value:function(e,t,i){if(this.mask){var n=this.mask;n.exclude?(e.save(),e.fillStyle=n.color||"black",e.fillRect(t+n.x,i+n.y,n.width,n.height)):(e.save(),e.beginPath(),e.rect(t+n.x,i+n.y,n.width,n.height),e.clip())}}},{key:"_undoMask",value:function(e){this.mask&&e.restore()}},{key:"update",value:function(e){if(this.movable){if(!0===this.moving){var t=e-this.startMoveTime,i=t/this.duration,n=0;t>=this.duration?(this.moving=!1,this.x=this.targetX,this.y=this.targetY):(n=this.easing(i,t,0,1,this.duration),this.x=this.targetStartX+n*this.targetDistanceX|0,this.y=this.targetStartY+n*this.targetDistanceY|0)}else this.behavior?this.behavior.onUpdate(e):(this.x+=this.vx,this.y+=this.vy,this.vy-=this.gravity);this.children.length&&this.children.forEach(function(e){e.update()})}}},{key:"savePosition",value:function(){this.savedX=this.x,this.savedY=this.y}},{key:"getSavedPosition",value:function(){return{x:this.savedX,y:this.savedY}}},{key:"moveWithSpline",value:function(){}},{key:"setPath",value:function(e){this.path=e}},{key:"setScale",value:function(e){this.scale=e}},{key:"setAngle",value:function(e){this.angle=e}},{key:"getAngle",value:function(){return this.angle}},{key:"transform",value:function(e,t){switch(e){case"scale":this.scale=t}}},{key:"hide",value:function(){return this.visible=!1,this}},{key:"show",value:function(){return this.visible=!0,this}},{key:"applyCtxAlpha",value:function(e){this._oldAlpha=e.globalAlpha,e.globalAlpha=this.opacity}},{key:"restoreCtxAlpha",value:function(e){e.globalAlpha=this._oldAlpha}},{key:"getCurrentWidth",value:function(){return this.width}},{key:"getCurrentHeight",value:function(){return this.height}},{key:"getHitBox",value:function(){return{x:0,y:0,x2:this.getCurrentWidth()-1,y2:this.getCurrentHeight()-1}}},{key:"showHitBox",value:function(e){if(this.visible){var t=this.getHitBox(),i=this.currentMap&&this.currentMap.viewportX||0,n=this.currentMap&&this.currentMap.viewportY||0;t&&(e.setTransform(1,0,0,1,0,0),e.strokeStyle="rgb(0,230,0)",e.beginPath(),e.moveTo(t.x+this.x+i,t.y+this.y+n),e.lineTo(t.x2+this.x+i,t.y+this.y+n),e.lineTo(t.x2+this.x+i,t.y2+this.y+n),e.lineTo(t.x+this.x+i,t.y2+this.y+n),e.lineTo(t.x+this.x+i,t.y+this.y+n),e.closePath(),e.stroke())}}},{key:"showObjectBox",value:function(e){e.strokeStyle="rgb(0,230,0)",e.beginPath(),e.moveTo(this.x,this.y),e.lineTo(this.width+this.x,this.y),e.lineTo(this.width+this.x,this.y+this.height),e.lineTo(this.x,this.y+this.height),e.lineTo(this.x,this.y),e.closePath(),e.stroke()}},{key:"hitTest",value:function(e){var t=e.getHitBox(),i=!1;if(this.canCollide&&e.canCollide&&this!==e&&this.visible){var n=this.getHitBox(),s={x:this.x+n.x,y:this.y+n.y,x2:this.x+n.x+n.x2,y2:this.y+n.y2+n.y};(s.y<e.y+t.y&&s.y2>e.y+t.y||s.y>e.y+t.y&&s.y<e.y+t.y+t.y2)&&(s.x<e.x+t.x&&s.x2>e.x+t.x||s.x>e.x+t.x&&s.x<e.x+t.x+t.x2)&&(e.onCollision(this),this.onCollision(e),i=!0)}if(!i)for(var r=this.children.length,o=0;!i&&o<r;)i=this.children[o].hitTest(e),o++;return i}},{key:"setTarget",value:function(e){this.target=e}},{key:"addMoveHandler",value:function(e){this.moveHandlers.push(e)}},{key:"onHit",value:function(e){console.log("[Drawable] oops, ",this.type," [",this.id,"] ","was hit by",e.name," [",e.id,"]")}},{key:"_onUpdate",value:function(){var e=[this.x,this.y];this.moveHandlers.forEach(function(t){return t.apply(void 0,e)})}},{key:"isFxQueueEmpty",value:function(){for(var e in this.fxQueue)return!1;return!0}},{key:"animate",value:function(e,t){var i=this,n=I.getEffect(e),s=null,r=t.easing||"linear",o=void 0;return void 0!==this.fxQueue[e]?console.warn("Fx",e,"already in progress, cannot execute twice"):n?((o=new n(t)).setEasing(new I.getEasing(r)),s=o.start().then(function(){delete i.fxQueue[e]}).catch(function(e){console.error(e)}),this.fxQueue[e]=o):console.warn("Fx",e,"unknown: did you spell it correctly ?"),s||p.resolve()}},{key:"stopAnimate",value:function(e){var t=this;Object.keys(this.fxQueue).forEach(function(i){t.fxQueue[i].stop(t,e)})}},{key:"executeFx",value:function(e,t){var i=this;Object.keys(this.fxQueue).forEach(function(n){i.fxQueue[n].process(e,null,i,t)})}},{key:"onCollision",value:function(){}},{key:"addChild",value:function(e){e.setMap(this.currentMap),e.setScene(this.currentScene),this.children.push(e)}},{key:"removeChild",value:function(e){var t=this.children.indexOf(e);t>-1&&(this.children[t].destroy(),this.children.splice(t,1))}},{key:"removeAllChildren",value:function(){for(var e=0;e<this.children.length;++e)this.children[e].destroy();this.children.length=0}},{key:"setImage",value:function(e){}},{key:"_draw",value:function(e){this.applyCtxAlpha(e),this.draw(e),this.restoreCtxAlpha(e)}},{key:"playSound",value:function(e,t){var i=0,n=this.currentMap,s=1,r=t||{pan:!0,loop:!1};(n&&(this.x<-n.viewportX||this.x>-n.viewportX+n.viewportW)||this.y<-n.viewportY||this.y>-n.viewportY+n.viewportH)&&(s=.2),n&&r.pan&&(i=this.x<n.masterObject.x?-5:5),this.sound=u.play(e,r.loop||!1,s,i)}},{key:"notify",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};X.notify(this.type+":"+e,t)}},{key:"destroy",value:function(){this._destroyed=!0,"function"==typeof this.freeFromPool&&this.freeFromPool(),this.currentMap?this.currentMap.removeObject(this):this.currentScene&&this.currentScene.removeObject(this),this.children.forEach(function(e){e.destroy()}),this.wave&&this.wave.remove(this)}}]),e}(),Me=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),Pe=function(e){function t(e,i){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var n=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e||"Sprite",i||{}));return n.imageId=i&&i.imageId||null,i&&i.animations&&n.load(i.animations),n}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,Ce),Me(t,[{key:"initProperties",value:function(){this.animations={},this.currentAnim=null,this.currentFrame=null,this.currentFrameNum=this.previousFrameNum=0,this.loaded=!1,this.currentAnimName="",this.storedAnimName="",this.storedFrameNum=0,this.numFrames=0,this.rewindOnEnd=!1,this.direction=1,this.frameCounter=0,this.animEndDef=null,this.animChangeDef=null,this.rewinded=!1,this.isDebug=!1}},{key:"debug",value:function(e){this.isDebug=e}},{key:"addAnimation",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n={};if(n[e]=Object.assign({frameDuration:1,loop:1,frames:[]},i),i.frameWidth&&i.frameHeight&&i.numFrames){this.imageId=t;for(var s=i.offsetX||0,r=i.offsetY||0,o=0,a=i.numFrames||0,h=n[e].frames,u=i.frameHeight,l=i.frameWidth+(i.frameSpacing||0);o<a;)h.push({offsetX:s,offsetY:r,width:i.frameWidth,height:u,hitBox:{x:0,y:0,x2:i.frameWidth-1,y2:u-1}}),s+=l,o++;a&&this.load(n)}else console.error("Parameter missing: frameWidth, frameHeight, numFrames are all required!")}},{key:"load",value:function(e){var t=this,i=e||this._settings.animations,n=void 0;this.loaded||this.initProperties(),Object.keys(i).forEach(function(e){var s=i[e];t.animations[e]=s,n=e,s.flipFrom&&t.updateFlipAnimation(s,s.flipFrom,s.flipType)}),this.loaded||(this.loaded=!0,this.setAnimation(n))}},{key:"updateFlipAnimation",value:function(e,t,i){var n=this.animations[t].frames;e.frames=new Array(n.length);for(var s=0;s<n.length;++s)e.frames[s]={},Object.assign(e.frames[s],n[s]),1&i&&(e.frames[s].hitBox.x=n[s].width-n[s].hitBox.x2,e.frames[s].hitBox.x2=n[s].width-n[s].hitBox.x),2&i&&(e.frames[s].hitBox.y=n[s].height-n[s].hitBox.y2,e.frames[s].hitBox.y2=n[s].height-n[s].hitBox.y)}},{key:"setImage",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];e?this.image&&!t||(this.image=e,this.children.forEach(function(t){t.setImage(e)})):console.warn("[Sprite] setImage(): image not loaded",this.imageId||this.imageSrc)}},{key:"rewind",value:function(){this.direction=-this.direction,this.running=!0,this.rewinded=!0,this.nextFrame(),console.log("[Sprite] rewind",this.currentFrameNum,this.running,this.rewinded,this.direction)}},{key:"nextFrame",value:function(){if(this.running)if(this.currentFrameNum+=this.direction,this.currentFrameNum<0||this.currentFrameNum>=this.numFrames)switch(this.currentAnim.loop){case 2:this.direction=-this.direction,this.currentFrameNum=this.currentFrameNum<0?0:this.numFrames-1,this.currentFrame=this.currentAnim.frames[this.currentFrameNum];break;case 1:this.currentFrameNum=this.currentAnim.loopFrom?this.currentAnim.loopFrom:0,this.currentFrame=this.currentAnim.frames[this.currentFrameNum];break;default:!this.currentAnim.rewindOnEnd||this.rewinded?(this.currentFrameNum-=this.direction,this.running=!1,this._animationEnded()):this.currentAnim.rewindOnEnd&&this.rewind()}else this.currentFrame=this.currentAnim.frames[this.currentFrameNum]}},{key:"storeCurrentAnim",value:function(){this.storedAnimName=this.currentAnimName,this.storedFrameNum=this.currentFrameNum}},{key:"restorePreviousAnim",value:function(){this.setAnimation(this.storedAnimName,null,this.storedFrameNum)}},{key:"advanceFrame",value:function(e){this.previousFrameNum=this.currentFrameNum,this.currentAnim!==this.animations[e]?(this.frameCounter=0,this.setAnimation(e)):++this.frameCounter>this.currentAnim.frameDuration&&(this.nextFrame(),this.frameCounter=0)}},{key:"getCurrentWidth",value:function(){return this.currentFrame.width}},{key:"getCurrentHeight",value:function(){return this.currentFrame.height}},{key:"getCurrentOffsetX",value:function(){return this.currentFrame.offsetX}},{key:"getCurrentOffsetY",value:function(){return this.currentFrame.offsetY}},{key:"getCurrentShiftX",value:function(){return this.currentFrame.shiftX||0}},{key:"getCurrentShiftY",value:function(){return this.currentFrame.shiftY||0}},{key:"getHitBox",value:function(){return this.currentFrame.hitBox||{x:0,y:0,x2:this.getCurrentWidth()-1,y2:this.getCurrentHeight()-1}}},{key:"getHitBox2",value:function(){var e=this.currentFrame.hitBox;return{x:this.x+e.x,x2:this.x+e.x2,y:this.y+e.y,y2:this.y+e.y2}}},{key:"centerXOverTile",value:function(e){var t=this.currentMap.tileWidth,i=this.getCurrentWidth(),n=Math.floor((t-i)/2);i<=t&&(this.x=e.x*t+n)}},{key:"clearMove",value:function(){this.running=!1}},{key:"setAnimation",value:function(e,t,i,n){this.loaded||this.load();try{this.currentAnim&&this._animationEnded(),this.animEndDef=new p,this.currentAnim&&this._animationChanged(this.currentAnimName,e),this.animChangeDef=new p,this.currentAnim=this.animations[e],this.currentAnimName=e,this.numFrames=this.currentAnim.frames.length,this.currentFrameNum=this.previousFrameNum=n?this.numFrames-1:i||0,this.currentFrame=this.currentAnim.frames[this.currentFrameNum],this.running=!0,this.rewinded=!1,this.direction=n?-1:1,"function"==typeof t&&this.onAnimationEnd(t)}catch(t){console.error("[Sprite] setAnimation() - unable to set animation ",e,"("+t.message+")","for sprite",this.id)}}},{key:"stopAnimation",value:function(e){this.running=!1,this.animEndDef&&!e&&this.animEndDef.reject()}},{key:"startAnimation",value:function(){this.running=!0}},{key:"onAnimationEnd",value:function(e){this.animEndDef.promise.then(e.bind(this))}},{key:"onAnimationChange",value:function(e){this.animChangeDef.promise.then(e.bind(this))}},{key:"_animationEnded",value:function(){this.animEndDef.resolve(this.currentAnimName,this.currentFrameNum)}},{key:"_animationChanged",value:function(e,t){this.animChangeDef.resolve(e,t)}},{key:"onHit",value:function(e){(function e(t,i,n){null===t&&(t=Function.prototype);var s=Object.getOwnPropertyDescriptor(t,i);if(void 0===s){var r=Object.getPrototypeOf(t);return null===r?void 0:e(r,i,n)}if("value"in s)return s.value;var o=s.get;return void 0!==o?o.call(n):void 0})(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"onHit",this).call(this,e),console.log("[Sprite] oops, ",this.type," [",this.id,"] ","was hit by",e.name," [",e.id,"]")}},{key:"draw",value:function(e){if(this.visible&&this.image&&this.currentAnimName){this.currentAnimName.length&&this.advanceFrame(this.currentAnimName);var t=this.getCurrentWidth(),i=t*this.scale,n=this.getCurrentHeight(),s=n*this.scale,r=Math.floor(i/2),o=Math.floor(s/2),a=this.getCurrentOffsetX(),h=this.getCurrentOffsetY(),u=this.currentAnim.flipFrom?this.x+this.getCurrentShiftX()-i:this.x+this.getCurrentShiftX(),l=this.currentAnim.flipFrom?this.y+this.getCurrentShiftY()-s:this.y+this.getCurrentShiftY(),c=this.currentMap&&this.currentMap.viewportX||0,f=this.currentMap&&this.currentMap.viewportY||0;t&&n&&(this.executeFx(e),this.mask&&!this.mask.exclude&&this._applyMask(e,Math.floor(u+c),Math.floor(l+f)),e.setTransform(this.scale,0,0,this.scale,u+c+r,l+f+o),e.rotate(this.angle),e.drawImage(this.image,Math.floor(a),Math.floor(h),Math.floor(t),Math.floor(n),Math.floor(-r),Math.floor(-o),Math.floor(i),Math.floor(s)),this.mask&&this.mask.exclude&&(e.setTransform(1,0,0,1,0,0),this._applyMask(e,Math.floor(u+c),Math.floor(l+f))),this._undoMask(e))}}},{key:"describeAllAnimations",value:function(){var e=this,t=null,i=this,n=1,s=1,r=0,o=0,a=0,h=0,u=void 0,l=null;Object.keys(this.animations).forEach(function(i){t=e.animations[i],r=t.frames[0].width,o=t.frames[0].height,(r+5)*t.frames.length>a&&(a=(r+5)*t.frames.length),h+=o+5}),(u=document.getElementById("describe"))||((u=document.createElement("canvas")).id="describe",u.setAttribute("width",a.toString()),u.setAttribute("height",h.toString())),(l=y("#describe")[0]&&y("#describe")[0].getContext("2d")||new y("canvas").attr("id","describe").attr("width",a).attr("height",h).css("zIndex","100").appendTo("body")[0].getContext("2d")).webkitImageSmoothingEnabled=!1,Object.keys(this.animations).forEach(function(a){n=1,t=e.animations[a],console.log(a,"got",t.frames.length),console.log("frameDuration=",t.frameDuration),console.log("loop=",t.loop),console.log("loopFrom=",t.loopFrom),console.log("rewindOnEnd",t.rewindOnEnd),t.frames.forEach(function(e){var t=e.width,o=e.height,a=e.offsetX,h=e.offsetY,u=e.hitBox;l.drawImage(i.image,a,h,t,o,n,s,t,o),l.strokeStyle="rgb(240,240,240)",l.beginPath(),l.moveTo(n-1,s-1),l.lineTo(n+t,s-1),l.lineTo(n+t,s+o+1),l.lineTo(n-1,s+o+1),l.lineTo(n-1,s-1),l.closePath(),l.lineCap="butt",l.stroke(),u&&(l.strokeStyle="rgb(0,230,0)",l.beginPath(),l.moveTo(n+u.x,s+u.y),l.lineTo(n+u.x2,s+u.y),l.lineTo(n+u.x2,s+u.y2),l.lineTo(n+u.x,s+u.y2),l.lineTo(n+u.x,s+u.y),l.closePath(),l.stroke()),n+=r+5}),s+=o+5})}},{key:"listAnimations",value:function(){return this.animations}}]),t}(),Ae=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),je=function e(t,i,n){null===t&&(t=Function.prototype);var s=Object.getOwnPropertyDescriptor(t,i);if(void 0===s){var r=Object.getPrototypeOf(t);return null===r?void 0:e(r,i,n)}if("value"in s)return s.value;var o=s.get;return void 0!==o?o.call(n):void 0},Fe=function(e){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"SimpleText"+(new Date).getTime(),i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var n=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,i));return n.fontFace=i.fontFace||"Arial",n.fontStyle=i.fontStyle||"normal",n.fontSize=i.fontSize||"18px",n.fontWeight=i.fontWeight||"normal",n.align=i.align||"center",n.color=i.color||"white",n.width=i.width||0,n.height=i.height||0,n.buffer=null,n.text=i.text||"",n}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,Ce),Ae(t,[{key:"createBuffer",value:function(e){var t=this.fakeWidth||0,i=this.fakeHeight||0;this.buffer=e.getBuffer(t,i)}},{key:"clearBuffer",value:function(){this.currentScene.display.clearScreen(this.buffer)}},{key:"moveWithSpline",value:function(){}},{key:"setSize",value:function(e,t){null!==e&&(this.width=e),null!==t&&(this.height=t)}},{key:"prepareRender",value:function(){this._setFont(),this.lines=this.text.split("\n"),this.buffer?this.clearBuffer():this.createBuffer(this.currentScene.display),this.getMetrics()}},{key:"getMetrics",value:function(){var e=this.buffer;e.font=this.font,this.fakeLineHeight=parseInt(e.font),this.fakeHeight=this.lines.length*this.fakeLineHeight,this.fakeWidth=e.measureText(this.text).width,e.canvas.width=this.fakeWidth,e.canvas.height=this.fakeHeight,e.fillStyle=this.color,e.font=this.font,e.textBaseline="top"}},{key:"renderText",value:function(){this.prepareRender();for(var e=0;e<this.lines.length;++e)this.buffer.fillText(this.lines[e],0,this.fakeLineHeight*e)}},{key:"setText",value:function(e){this.text=e,this.renderText()}},{key:"setScene",value:function(e){je(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"setScene",this).call(this,e),this.setText(this.text)}},{key:"setColor",value:function(e){this.color=e,this.renderText()}},{key:"getHitBox",value:function(){return{x:0,y:0,x2:this.w,y2:this.y}}},{key:"getCurrentWidth",value:function(){return this.fakeWidth}},{key:"getCurrentHeight",value:function(){return this.fakeHeight}},{key:"getCurrentOffsetX",value:function(){return this.offsetX}},{key:"getCurrentOffsetY",value:function(){return this.offsetY}},{key:"onHit",value:function(e){je(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"onHit",this).call(this,e),console.log("oops, ",this.type," [",this.id,"] ","was hit by",e.name," [",e.id,"]")}},{key:"draw",value:function(e){var t=this.fakeWidth*this.scale,i=this.fakeHeight*this.scale,n=Math.floor(t/2),s=Math.floor(i/2),r=this.currentMap&&this.currentMap.viewportX||0,o=this.currentMap&&this.currentMap.viewportY||0,a=this.fakeWidth,h=this.fakeHeight;this.visible&&this.buffer&&(this.executeFx(e),e.setTransform(this.scale,0,0,this.scale,this.x+r+n,this.y+o+s),e.rotate(this.angle),e.drawImage(this.buffer.canvas,0,0,Math.floor(a),Math.floor(h),Math.floor(-n),Math.floor(-s),Math.floor(t),Math.floor(i)))}},{key:"_setFont",value:function(){this.font=this.fontSize+" "+this.fontFace}}]),t}(),Le=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),Re=function(e){function t(e,i){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var n=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,i));return n.title=new Fe(e,{color:i.color||"black",text:i.title||"Menu Title"}),n.color=i.color||"white",n.selectedColor=i.selectedColor||"red",n.menuItems=[],n.selectedItem=i.selectedItem||0,n.selectCallbacks=[],n.hoverCallbacks=[],n.itemHeight=i.itemHeight||40,n.title.moveTo(n.x,n.y),n.addMenuItems(i.menuItems||[]),n}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,Ce),Le(t,[{key:"addMenuItem",value:function(e){var t=this.y+(this.menuItems.length+1)*this.itemHeight,i=new Fe("menuItem"+this.menuItems.length,e);i.moveTo(this.x,t),i.visible=!0===e.visible||!1,i.selectable=!0===e.selectable||!1,this.menuItems.push(i)}},{key:"addMenuItems",value:function(e){var t=this;console.log("[Menu] addMenuItems()",e),e.forEach(function(e,i){t.addMenuItem(e),e.active&&(t.selectedItem=i)})}},{key:"nextItem",value:function(){++this.selectedItem>=this.menuItems.length&&(this.selectedItem=0),this.selectedItem&&this.menuItems[this.selectedItem]&&!this.menuItems[this.selectedItem].selectable&&this.nextItem()}},{key:"getSelectedItemIndex",value:function(){return this.selectedItem}},{key:"getSelectedItem",value:function(){return this.menuItems[this.selectedItem]}},{key:"setText",value:function(e,t){this.menuItems[e]=t}},{key:"draw",value:function(e){var t=this;0!==this.angle&&(e.save(),e.rotate(this.angle)),this.title.draw(e),this.menuItems.forEach(function(i,n){n===t.selectedItem?i.color=t.selectedColor||"blue":i.color=t.color,i.draw(e)}),0!==this.angle&&e.restore()}}]),t}(),De=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),Ie=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.score=t.score||0,this.alternateScore=t.alternateScore||0,this.energy=t.energy||100,this.$dest=t.target,this.info="",this.inventory={},this.width=t.width||1024,this.height=t.height||64,Object.defineProperty(this,"score",{get:function(){return this.score},set:function(e){this.score=e}})}return De(e,[{key:"drawBackground",value:function(){}},{key:"draw",value:function(){this.drawBackground()}}]),e}(),Ye=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),Ne=function e(t,i,n){null===t&&(t=Function.prototype);var s=Object.getOwnPropertyDescriptor(t,i);if(void 0===s){var r=Object.getPrototypeOf(t);return null===r?void 0:e(r,i,n)}if("value"in s)return s.value;var o=s.get;return void 0!==o?o.call(n):void 0},Be=function(e){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"BitmapText",i=arguments[1];!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var n=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,i));return n.width=i.width||320,n.height=i.height||18,n.pixelHeight=0,n.easing=I.getEasing(i.easing||"linear"),n.imageId=i.imageId||"image not set",n.characters=i.characters||"ABCDEFGHIJKLMNOPQRSTUVWXYZ",i.imageSrc&&(n.imageId=i.imageSrc),n.buffer=null,n.image=null,n.scrolling=!1,n.text=i.text||"BitmapText",n.scrollOffsetX=i.scrollOffsetX||0,n.scrollOffsetY=i.scrollOffsetY||0,n.textArray=[],n.setFontParams(i),n}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,Ce),Ye(t,[{key:"createBuffer",value:function(e){var t=this.width,i=this.height;this.buffer=e.getBuffer(t,i)}},{key:"clearBuffer",value:function(){this.currentScene.display.clearScreen(this.buffer)}},{key:"setFontParams",value:function(e){this.lineSpacing=e.lineSpacing||2,this.letterSpacing=e.letterSpacing||2,this.charWidth=e.charWidth||16,this.charHeight=e.charHeight||18,this.maxCharPerLine=Math.floor(this.width/(this.charWidth+this.letterSpacing)),this.maxPixels=this.maxCharPerLine*(this.charWidth+this.letterSpacing),this.offsetX=e.offsetX||this.charWidth,this.startX=e.startX||0,this.startY=e.startY||0}},{key:"_reset",value:function(){Ne(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"_reset",this).call(this),this.setTextPosition()}},{key:"getNextLineLength",value:function(e,t){for(var i=0;i<e.length&&e[i]!==t;)i++;return i}},{key:"getLines",value:function(){var e=this.text,t="",i=!1,n=0,s=0;for(this.textArray.length=0;!i;)e=e.replace(/^\n/,""),(n=this.getNextLineLength(e,"\n"))?((t=e.substr(0,n)).length<=this.maxCharPerLine?e=e.substr(n):(t=e.substr(0,this.maxCharPerLine),e=e.substr(this.maxCharPerLine)),this.textArray.push({text:t,x:"center"===this.align?Math.floor((this.maxPixels-t.length*(this.charWidth+this.letterSpacing))/2):0,y:s}),s+=this.charHeight+this.lineSpacing):i=!0;this.pixelHeight=this.textArray.length*(this.charHeight+this.lineSpacing)}},{key:"scrollFromBottom",value:function(e,t){this.scrollOffsetY=this.height,this.scrollText({callback:t,duration:e,targetOffsetX:0,targetOffsetY:this.height-this.pixelHeight})}},{key:"scrollFromTop",value:function(e,t){this.scrollOffsetY=-this.pixelHeight,this.scrollText({callback:t,duration:e,targetOffsetX:0,targetOffsetY:0})}},{key:"scrollText",value:function(e){this.scrolling||(console.log("starting scrolling"),this.scrolling=!0,this.callback=e.callback&&e.callback.bind(this)||null,this.duration=e.duration||1e4,this.targetOffsetX=e.targetOffsetX,this.targetOffsetY=e.targetOffsetY,this.startX=this.scrollOffsetX,this.startY=this.scrollOffsetY,this.speedX=this.targetOffsetX-this.startX|0,this.speedY=this.targetOffsetY-this.startY|0,this.startMoveTime=(new Date).getTime())}},{key:"setTextPosition",value:function(){}},{key:"update",value:function(){var e=(new Date).getTime()-this.startMoveTime,t=e/this.duration,i=void 0;!0===this.scrolling&&(e>=this.duration?(this.scrolling=!1,this.scrollOffsetX=this.targetOffsetX,this.scrollOffsetY=this.targetOffsetY,this.callback&&this.callback()):(i=this.easing(t,e,0,1,this.duration),this.scrollOffsetX=this.startX+i*this.speedX|0,this.scrollOffsetY=this.startY+i*this.speedY|0))}},{key:"getCharOffset",value:function(e){var t=this.characters.indexOf(e);return t<0&&(t=this.characters.indexOf(e.toUpperCase())),t*this.offsetX}},{key:"drawLine",value:function(e){var t=e.x,i=e.y,n=0,s=0,r=e.text.length;for(n=0;n<r;++n)32!==e.text[n].charCodeAt(0)&&((s=this.getCharOffset(e.text[n]))>=0?this.buffer.drawImage(this.image,s,this.startY,this.charWidth,this.charHeight,t,i,this.charWidth,this.charHeight):console.log("[BitmapText] character "+e.text[n]+" not supported")),t+=this.letterSpacing+this.charWidth}},{key:"renderText",value:function(){var e,t=0,i=void 0;for(e=this.textArray.length,t=0;t<e;++t)i=this.textArray[t],this.drawLine(i)}},{key:"setText",value:function(e){this.text=e,this.getLines(),this.buffer?this.clearBuffer():this.createBuffer(this.currentScene.display),this.renderText()}},{key:"setImage",value:function(e){e?this.image=e:console.warn("[BitmapText] setImage(): image not loaded",this.imageId||this.imageSrc)}},{key:"setScene",value:function(e){Ne(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"setScene",this).call(this,e),this.setText(this.text)}},{key:"draw",value:function(e){var t,i=this.width*this.scale,n=this.height*this.scale,s=Math.floor(i/2),r=Math.floor(n/2),o=this.currentMap&&this.currentMap.viewportX||0,a=this.currentMap&&this.currentMap.viewportY||0,h=this.width,u=this.height;this.visible&&this.image&&(this.executeFx(e),this.scrollOffsetY>=0?(this.scrollOffsetY,this.height,t=0):(0,t=Math.abs(this.scrollOffsetY)),e.setTransform(this.scale,0,0,this.scale,this.x+o+s,this.y+a+r),e.rotate(this.angle),e.drawImage(this.buffer.canvas,0,t,Math.floor(h),Math.floor(u),Math.floor(-s),Math.floor(-r),Math.floor(i),Math.floor(n)))}}]),t}(),Ge=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),He=function(e){function t(e,i){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var n=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,i));return n.width=i.width||0,n.height=i.height||0,n.x=i.x||0,n.y=i.y||0,n.color=i.color||"red",n}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,Ce),Ge(t,[{key:"draw",value:function(e){this.ctx=e,e.setTransform(1,0,0,1,0,0),this._applyMask(e,this.x,this.y),this.isFxQueueEmpty()||this.executeFx(e),this.render(),this._undoMask()}},{key:"render",value:function(){}},{key:"fill",value:function(e){this.ctx.fillStyle=e||this.color,this.ctx.fillRect(this.x,this.y,this.width,this.height)}},{key:"rect",value:function(e,t,i,n,s){var r=this.ctx;r.fillStyle=s||this.color,r.fillRect(this.x+e,this.y+t,i,n)}},{key:"circle",value:function(e,t,i,n,s,r){var o=this.ctx;o.beginPath(),o.arc(this.x+e+i,this.y+t+i,i,0,2*Math.PI,!1),o.fillStyle=n||this.color,o.fill(),arguments.length>4&&(o.strokeStyle=r||this.color,o.lineWidth=s,o.stroke())}},{key:"arc",value:function(e,t,i,n,s,r,o){var a=this.ctx;a.beginPath(),a.arc(this.x+e,this.y+t,i,n,s,!1),a.lineWidth=o,a.strokeStyle=r||this.color,a.stroke()}},{key:"animate",value:function(e,i){return"Fade"!==e?(console.warn("animte() not supported on Paint objects yet. Effect not applied."),p.resolve(!0)):function e(t,i,n){null===t&&(t=Function.prototype);var s=Object.getOwnPropertyDescriptor(t,i);if(void 0===s){var r=Object.getPrototypeOf(t);return null===r?void 0:e(r,i,n)}if("value"in s)return s.value;var o=s.get;return void 0!==o?o.call(n):void 0}(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"animate",this).call(this,e,i)}}]),t}(),We={easeInQuad:function(e,t,i,n,s){return n*(t/=s)*t+i},easeOutBounce:function(e,t,i,n,s){return(t/=s)<1/2.75?n*(7.5625*t*t)+i:t<2/2.75?n*(7.5625*(t-=1.5/2.75)*t+.75)+i:t<2.5/2.75?n*(7.5625*(t-=2.25/2.75)*t+.9375)+i:n*(7.5625*(t-=2.625/2.75)*t+.984375)+i},swing:function(e){return.5-Math.cos(e*Math.PI)/2}};Object.keys(We).forEach(function(e){return I.addEasing(e,We[e])});var Xe=We;i.d(t,"Game",function(){return Q}),i.d(t,"Pool",function(){return l}),i.d(t,"Scene",function(){return he}),i.d(t,"ResourceManager",function(){return b}),i.d(t,"Drawable",function(){return Ce}),i.d(t,"Sprite",function(){return Pe}),i.d(t,"SimpleText",function(){return Fe}),i.d(t,"Wave",function(){return te}),i.d(t,"Menu",function(){return Re}),i.d(t,"Hud",function(){return Ie}),i.d(t,"BitmapText",function(){return Be}),i.d(t,"Paint",function(){return He}),i.d(t,"Behavior",function(){return le}),i.d(t,"NotificationManager",function(){return X}),i.d(t,"Map",function(){return re}),i.d(t,"Tile",function(){return $}),i.d(t,"MapEvent",function(){return ne}),i.d(t,"FX",function(){return I}),i.d(t,"Effect",function(){return k}),i.d(t,"Easing",function(){return Xe}),i.d(t,"InputManager",function(){return U}),i.d(t,"DisplayManager",function(){return G}),i.d(t,"Display",function(){return N}),i.d(t,"AudioManager",function(){return u}),i.d(t,"Binary",function(){return h}),i.d(t,"Dom",function(){return y}),i.d(t,"Deferred",function(){return p})},function(e,t){},function(e,t){var i;i=function(){return this}();try{i=i||Function("return this")()||(0,eval)("this")}catch(e){"object"==typeof window&&(i=window)}e.exports=i},function(e,t){function i(){throw new Error("setTimeout has not been defined")}function n(){throw new Error("clearTimeout has not been defined")}function s(e){if(u===setTimeout)return setTimeout(e,0);if((u===i||!u)&&setTimeout)return u=setTimeout,setTimeout(e,0);try{return u(e,0)}catch(t){try{return u.call(null,e,0)}catch(t){return u.call(this,e,0)}}}function r(){p&&f&&(p=!1,f.length?d=f.concat(d):v=-1,d.length&&o())}function o(){if(!p){var e=s(r);p=!0;for(var t=d.length;t;){for(f=d,d=[];++v<t;)f&&f[v].run();v=-1,t=d.length}f=null,p=!1,function(e){if(l===clearTimeout)return clearTimeout(e);if((l===n||!l)&&clearTimeout)return l=clearTimeout,clearTimeout(e);try{l(e)}catch(t){try{return l.call(null,e)}catch(t){return l.call(this,e)}}}(e)}}function a(e,t){this.fun=e,this.array=t}function h(){}var u,l,c=e.exports={};!function(){try{u="function"==typeof setTimeout?setTimeout:i}catch(e){u=i}try{l="function"==typeof clearTimeout?clearTimeout:n}catch(e){l=n}}();var f,d=[],p=!1,v=-1;c.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var i=1;i<arguments.length;i++)t[i-1]=arguments[i];d.push(new a(e,t)),1!==d.length||p||s(o)},a.prototype.run=function(){this.fun.apply(null,this.array)},c.title="browser",c.browser=!0,c.env={},c.argv=[],c.version="",c.versions={},c.on=h,c.addListener=h,c.once=h,c.off=h,c.removeListener=h,c.removeAllListeners=h,c.emit=h,c.prependListener=h,c.prependOnceListener=h,c.listeners=function(e){return[]},c.binding=function(e){throw new Error("process.binding is not supported")},c.cwd=function(){return"/"},c.chdir=function(e){throw new Error("process.chdir is not supported")},c.umask=function(){return 0}},function(e,t,i){e.exports=i(3)}])})},/*!**********************!*\
  !*** ./js/tetris.js ***!
  \**********************/
function(e,t,i){"use strict";var n=i(/*! athenajs */0),s=i(/*! ./grid */3),r=function(e){return e&&e.__esModule?e:{default:e}}(s);new n.Game({name:"athena-tetris",showFps:!0,debug:!0,width:800,height:600,scene:new r.default})},/*!***************************!*\
  !*** ./js/flash_lines.js ***!
  \***************************/
function(e,t,i){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),a=i(/*! athenajs */0),h=function(e){function t(e){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};n(this,t);var r=s(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,"flashlines",Object.assign({},{},i)));return r.lines=[],r.lineHeight=i.lineHeight,r}return r(t,e),o(t,[{key:"flash",value:function(e,t){return this.animate("Fade",{startValue:1,endValue:0,duration:400,loop:2})}},{key:"render",value:function(){for(var e=0;e<this.lines.length;++e){var t=this.lines[e];this.rect(0,t*this.lineHeight,this.width,this.lineHeight,"white")}}}]),t}(a.Paint);t.default=h},/*!********************!*\
  !*** ./js/grid.js ***!
  \********************/
function(e,t,i){"use strict";function n(e){return e&&e.__esModule?e:{default:e}}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function r(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),h=i(/*! athenajs */0),u=i(/*! ./shape */4),l=n(u),c=i(/*! ./flash_lines */2),f=n(c),d=1200,p=function(e){function t(){s(this,t);var e=r(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,{resources:[{id:"tiles",type:"image",src:"img/tetris_tiles.png"},{id:"gameover",type:"audio",src:"sound/gameover.mp3"},{id:"ground",type:"audio",src:"sound/ground.mp3"},{id:"level",type:"audio",src:"sound/level.mp3"},{id:"lines",type:"audio",src:"sound/lines.mp3"},{id:"lines_tetris",type:"audio",src:"sound/lines_tetris.mp3"},{id:"move",type:"audio",src:"sound/move.mp3"},{id:"pause",type:"audio",src:"sound/pause.mp3"},{id:"rotate",type:"audio",src:"sound/rotate.mp3"}]}));return e.score=0,e.level=0,e.lines=0,e.timing=d,e.scoreTable=[40,100,300,1200],e.bindEvents("shape:ground"),e}return o(t,e),a(t,[{key:"generateTileSet",value:function(){for(var e=[{offsetX:140,offsetY:440,width:20,height:20}],t=0,i=0;t<7;++t,i+=20)e.push({offsetX:i,offsetY:440,width:20,height:20});return e.push({offsetX:160,offsetY:440,width:20,height:20}),e}},{key:"createMap",value:function(){var e=new h.Map({src:"tiles",tileWidth:20,tileHeight:20,width:240,height:440,buffer:new ArrayBuffer(528)});return e.addTileSet(this.generateTileSet()),e}},{key:"resetMap",value:function(){var e=this.map;e.clear(0,h.Tile.TYPE.AIR);for(var t=0;t<e.numRows;++t)e.updateTile(0,t,8,h.Tile.TYPE.WALL),e.updateTile(e.numCols-1,t,8,h.Tile.TYPE.WALL);for(var i=0;i<e.numCols;++i)e.updateTile(i,e.numRows-1,8,h.Tile.TYPE.WALL)}},{key:"createShapes",value:function(){this.shape=new l.default("shape",{data:{speed:this.timing}}),this.nextShape=new l.default("nextShape",{x:610,y:110}),this.nextShape.movable=!1,this.nextString=new h.SimpleText("nextString",{text:"Next",x:620,y:70}),this.scoreString=new h.SimpleText("scoreString",{text:"Score: 0",x:50,y:70}),this.linesString=new h.SimpleText("linesString",{text:"Lines: 0",x:50,y:120}),this.levelString=new h.SimpleText("levelString",{text:"Level: 0",x:50,y:170}),this.pauseString=new h.SimpleText("pauseString",{text:"Pause",x:380,y:550,visible:!1}),this.controls=new h.SimpleText("controlsString",{text:"Move:  ← ↑ → ↓ \n\nFullscreen: f\n\nPause: p",x:50,y:220}),this.flashLines=new f.default("flash",{x:300,y:80,width:200,lineHeight:20})}},{key:"setup",value:function(){this.createShapes(),this.map=this.createMap()}},{key:"start",value:function(){var e=this.map;this.setBackgroundImage("img/background.png"),this.setMap(e,(800-e.width)/2,(600-e.height)/2),e.addObject(this.shape),this.addObject([this.nextShape,this.nextString,this.linesString,this.scoreString,this.levelString,this.pauseString,this.flashLines,this.controls]),this.reset()}},{key:"reset",value:function(){this.score=0,this.level=0,this.lines=0,this.timing=d,this.resetMap(),this.shape.moveToTop(),this.shape.setRandomShape(),this.nextShape.setRandomShape(),this.linesString.setText("Lines: "+this.lines),this.scoreString.setText("Score: "+this.score),this.levelString.setText("Level: "+this.level),this.shape.movable=!0,this.shape.behavior.reset()}},{key:"gameover",value:function(){h.AudioManager.play("gameover"),alert("Game over!\n\nScore: "+this.score),this.reset()}},{key:"onEvent",value:function(e){var t=this,i=this.nextShape,n=this.shape;switch(e.type){case"shape:ground":this.updateMap(),this.removeLinesFromMap(e.data.startLine,e.data.numRows).then(function(){n.setShape(i.shapeName,i.rotation),i.setRandomShape(),t.shape.moveToTop(),t.shape.snapTile(0,0,!1)?t.shape.movable=!0:t.gameover()})}}},{key:"updateMap",value:function(){for(var e=this.shape,t=this.shape.shape,i=this.map,n=i.getTileIndexFromPixel(e.x,e.y),s=e.getMatrix(),r=t.height/i.tileHeight,o=t.width/i.tileWidth,a=0;a<r;++a)for(var u=0;u<o;++u)s[a*o+u]&&i.updateTile(n.x+u,n.y+a,t.color,h.Tile.TYPE.WALL)}},{key:"getLinesToRemove",value:function(e,t){console.log("[Grid] getLinesToRemove()");var i=this.map,n=[],s=e+t-1;s>i.numRows-2&&(s=i.numRows-2);for(var r=s;r>=e;--r){for(var o=!1,a=1;a<i.numCols-1;++a)o=o||i.getTileBehaviorAtIndex(a,r)!==h.Tile.TYPE.WALL;o||n.push(r)}return n}},{key:"updateLevel",value:function(){var e=this.level;this.level=Math.floor(this.lines/10),this.levelString.setText("Level: "+this.level),this.timing=d-55*this.level,this.shape.data.speed=this.timing,e!==this.level&&h.AudioManager.play("level")}},{key:"increaseScore",value:function(e){this.score+=this.scoreTable[e-1]+this.level*this.scoreTable[e-1],this.lines+=e,this.linesString.setText("Lines: "+this.lines),this.scoreString.setText("Score: "+this.score),4===e?h.AudioManager.play("lines_tetris"):h.AudioManager.play("lines")}},{key:"removeLinesFromMap",value:function(e,t){var i=this,n=this.map,s=this.getLinesToRemove(e,t);return s.length?(this.flashLines.lines=s,this.flashLines.flash().then(function(){for(var e=0;e<s.length;++e)n.shift(s[e]+e,1);for(var r=0;r<t;++r){for(var o=0;o<n.numCols;++o)n.updateTile(o,r,0,h.Tile.TYPE.AIR);n.updateTile(0,r,8,h.Tile.TYPE.WALL),n.updateTile(n.numCols-1,r,8,h.Tile.TYPE.WALL)}(0,h.Dom)(".athena-game").addClass("shake-vertical shake-constant"),setTimeout(function(){(0,h.Dom)(".athena-game").removeClass("shake-vertical shake-constant")},300),i.increaseScore(s.length),i.updateLevel()})):h.Deferred.resolve(!0)}},{key:"pause",value:function(e){this.pauseString.visible=!e,h.AudioManager.play("pause")}}]),t}(h.Scene);t.default=p},/*!*********************!*\
  !*** ./js/shape.js ***!
  \*********************/
function(e,t,i){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),a=i(/*! athenajs */0),h=i(/*! ./shape_behavior */5),u=function(e){return e&&e.__esModule?e:{default:e}}(h),l=function(e){function t(e){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};n(this,t);var r=s(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,Object.assign({},{imageId:"tiles",easing:"linear",behavior:u.default},i)));return r.shapes=[{name:"I",width:80,height:80,color:7,rotations:[[0,0,0,0,1,1,1,1,0,0,0,0,0,0,0,0],[0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0],[0,0,0,0,0,0,0,0,1,1,1,1,0,0,0,0],[0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0]]},{name:"J",width:60,height:60,color:6,rotations:[[1,0,0,1,1,1,0,0,0],[0,1,1,0,1,0,0,1,0],[0,0,0,1,1,1,0,0,1],[0,1,0,0,1,0,1,1,0]]},{name:"L",width:60,height:60,color:5,rotations:[[0,0,1,1,1,1,0,0,0],[0,1,0,0,1,0,0,1,1],[0,0,0,1,1,1,1,0,0],[1,1,0,0,1,0,0,1,0]]},{name:"O",width:80,height:60,color:4,rotations:[[0,1,1,0,0,1,1,0,0,0,0,0],[0,1,1,0,0,1,1,0,0,0,0,0],[0,1,1,0,0,1,1,0,0,0,0,0],[0,1,1,0,0,1,1,0,0,0,0,0]]},{name:"S",width:60,height:60,color:3,rotations:[[0,1,1,1,1,0,0,0,0],[0,1,0,0,1,1,0,0,1],[0,0,0,0,1,1,1,1,0],[1,0,0,1,1,0,0,1,0]]},{name:"Z",width:60,height:60,color:2,rotations:[[1,1,0,0,1,1,0,0,0],[0,0,1,0,1,1,0,1,0],[0,0,0,1,1,0,0,1,1],[0,1,0,1,1,0,1,0,0]]},{name:"T",width:60,height:60,color:1,rotations:[[0,1,0,1,1,1,0,0,0],[0,1,0,0,1,1,0,1,0],[0,0,0,1,1,1,0,1,0],[0,1,0,1,1,0,0,1,0]]}],r.addAnimations(),r.setShape("S",0),r}return r(t,e),o(t,[{key:"moveToTop",value:function(){var e=this.currentMap,t=Math.floor((e.width-this.shape.width)/2/e.tileWidth);this.moveTo(t*e.tileWidth,0)}},{key:"setShape",value:function(e,t){var i=this;this.shapeName=e,this.rotation=t,this.shape=this.shapes.find(function(e){return e.name===i.shapeName}),this.setAnimation(""+e+t)}},{key:"setRandomShape",value:function(e){var t=this,i=this.shapes[7*Math.random()|0].name,n=4*Math.random()|0;console.log("[Shape] setRandomShape() - "+this.type+", "+i),this.movable?this.setShape(i,n):this.animate("Fade",{duration:200,startValue:1,endValue:0}).then(function(){t.setShape(i,n),t.animate("Fade",{duration:200,startValue:0,endValue:1})})}},{key:"getMatrix",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:-1;return this.shape.rotations[-1===e?this.rotation:e]}},{key:"snapTile",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],n=(arguments.length>3&&void 0!==arguments[3]&&arguments[3],this.currentMap),s=this.getMatrix(),r=n.getTileIndexFromPixel(this.x,this.y),o=r.x+e,h=r.y+t;return n.checkMatrixForCollision(s,this.shape.width,o,h,a.Tile.TYPE.WALL)?(1===t&&(this.movable=!1,i&&(a.AudioManager.play("ground"),this.notify("ground",{startLine:r.y,numRows:this.shape.height/n.tileHeight}))),!1):(this.x+=e*n.tileWidth,this.y+=t*n.tileHeight,!0)}},{key:"nextRotation",value:function(){var e=null,t=this.rotation+1,i=this.currentMap,n=i.getTileIndexFromPixel(this.x,this.y);t>3&&(t=0),e=this.getMatrix(t),i.checkMatrixForCollision(e,this.shape.width,n.x,n.y,a.Tile.TYPE.WALL)?console.log("rotation not possible"):(this.setShape(this.shapeName,t),a.AudioManager.play("rotate"))}},{key:"addAnimations",value:function(){var e=this,t=0;this.shapes.forEach(function(i){for(var n=0,s=0;s<4;++s)e.addAnimation(""+i.name+s,"tiles",{offsetY:t,offsetX:n,frameWidth:i.width,frameHeight:i.height,frameDuration:1,numFrames:1}),n+=i.width;t+=i.height})}}]),t}(a.Sprite);t.default=l},/*!******************************!*\
  !*** ./js/shape_behavior.js ***!
  \******************************/
function(e,t,i){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function r(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),a=i(/*! athenajs */0),h=function(e){function t(e,i){n(this,t);var r=s(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,i));return r.state=0,r.lastRotation=0,r.ts=0,r.LONG_DELAY=250,r.SMALL_DELAY=70,r.reset(),r}return r(t,e),o(t,[{key:"reset",value:function(){a.InputManager.clearEvents(),this.delay=this.LONG_DELAY,this.key=0,this.timerEnabled=!0}},{key:"ready",value:function(e,t){return this.state!==e?(this.ts=t,this.state=e,this.delay=this.LONG_DELAY,!0):t-this.ts>this.delay&&(this.ts=t,this.delay=this.SMALL_DELAY,!0)}},{key:"timer",value:function(e){var t=this.sprite;if(this.startTime){if(e-this.startTime>t.data.speed)return this.startTime=e,!0}else this.startTime=e;return!1}},{key:"checkKeyDelay",value:function(e,t,i,n){this.ready(e,t)&&this.sprite.snapTile(i,n)&&a.AudioManager.play("move")}},{key:"onUpdate",value:function(e){var t=this.sprite;return a.InputManager.isKeyDown(84)?void(this.timerEnabled=!this.timerEnabled):this.timerEnabled&&this.timer(e)?void t.snapTile(0,1):void(a.InputManager.isKeyDown("DOWN")?this.checkKeyDelay(1,e,0,1):a.InputManager.isKeyDown("LEFT")?this.checkKeyDelay(2,e,-1,0):a.InputManager.isKeyDown("RIGHT")?this.checkKeyDelay(3,e,1,0):(a.InputManager.isKeyDown("UP")||a.InputManager.isKeyDown("SPACE"))&&e-this.lastRotation>150?(this.lastRotation=e,t.nextRotation()):this.state&&this.ready(0,e))}}]),t}(a.Behavior);t.default=h},/*!****************************!*\
  !*** multi ./js/tetris.js ***!
  \****************************/
function(e,t,i){e.exports=i(/*! ./js/tetris.js */1)}]);